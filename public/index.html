<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Preconnect to speed up API/storage requests -->
  <link rel="preconnect" href="https://fnfkowpdlffzjqtmbnmj.supabase.co">
  <link rel="dns-prefetch" href="https://fnfkowpdlffzjqtmbnmj.supabase.co">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Invoice Approval</title>
  <link rel="stylesheet" href="css/styles.css?v=20260115-perf3">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-top">
        <div class="header-brand">
          <span class="brand-icon">üèóÔ∏è</span>
          <span class="brand-name">Ross Built</span>
        </div>
        <nav class="main-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
        <div class="header-actions">
          <button class="btn btn-primary" id="uploadBtn">+ Upload</button>
          <span class="connection-dot" id="connectionDot" title="Checking connection..."></span>
        </div>
      </div>
      <div class="header-sub">
        <nav class="sub-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="app-body">
      <main class="main">
      <!-- Filters -->
      <div class="table-toolbar">
        <div class="search-box">
          <input type="text" id="invoiceSearchInput" placeholder="Search invoices..." class="form-control search-input">
          <button class="search-clear-btn" id="invoiceSearchClear" style="display: none;" onclick="clearInvoiceSearch()">&times;</button>
        </div>
      </div>

      <!-- Invoice List -->
      <div class="invoice-list" id="invoiceList">
        <div class="skeleton-card"><div class="skeleton-line long"></div><div class="skeleton-line medium"></div><div class="skeleton-line short"></div></div>
        <div class="skeleton-card"><div class="skeleton-line long"></div><div class="skeleton-line medium"></div><div class="skeleton-line short"></div></div>
        <div class="skeleton-card"><div class="skeleton-line long"></div><div class="skeleton-line medium"></div><div class="skeleton-line short"></div></div>
      </div>
    </main>
    </div>
  </div>

  <!-- Invoice Detail Modal -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content modal-xl">
      <div class="modal-header">
        <h2 id="invoiceModalTitle">Invoice Details</h2>
        <button class="close-btn" onclick="closeModal('invoiceModal')">&times;</button>
      </div>
      <div class="modal-body split-view">
        <div class="pdf-viewer-container" id="pdfViewerContainer">
          <div class="pdf-placeholder">
            <div class="pdf-icon">PDF</div>
            <p>No PDF attached</p>
          </div>
        </div>
        <div class="invoice-info-panel" id="invoiceInfoPanel">
          <!-- Filled dynamically -->
        </div>
      </div>
      <div class="modal-footer" id="invoiceModalFooter">
        <!-- Action buttons -->
      </div>
    </div>
  </div>

  <!-- Denial Modal -->
  <div id="denialModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Deny Invoice</h2>
        <button class="close-btn" onclick="closeModal('denialModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Reason for Denial *</label>
          <textarea id="denialReason" rows="3" required placeholder="Explain why..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('denialModal')">Cancel</button>
        <button class="btn btn-danger" onclick="submitDenial()">Deny Invoice</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Mark Invoice as Paid</h2>
        <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="paymentInvoiceId">
        <div class="form-group">
          <label>Payment Method *</label>
          <select id="paymentMethod" class="form-control" required>
            <option value="">Select method...</option>
            <option value="check">Check</option>
            <option value="ach">ACH Transfer</option>
            <option value="wire">Wire Transfer</option>
            <option value="credit_card">Credit Card</option>
            <option value="cash">Cash</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reference # (Check #, Transaction ID, etc.)</label>
          <input type="text" id="paymentReference" class="form-control" placeholder="e.g. Check #1234">
        </div>
        <div class="form-group">
          <label>Payment Date</label>
          <input type="date" id="paymentDate" class="form-control">
        </div>
        <div class="form-group">
          <label>Amount Paid</label>
          <input type="number" id="paymentAmount" class="form-control" step="0.01" placeholder="Leave blank for full amount">
          <small class="form-hint">Leave blank to use the invoice amount</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('paymentModal')">Cancel</button>
        <button class="btn btn-success" onclick="confirmMarkPaid()">Mark as Paid</button>
      </div>
    </div>
  </div>

  <!-- Universal Upload Modal - Simple Version -->
  <div id="universalUploadModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upload Document</h2>
        <button class="close-btn" id="closeUploadBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="upload-info-banner">
          <div class="info-icon">AI</div>
          <div class="info-text">
            <strong>Smart Document Processing</strong>
            <p>AI will automatically detect if this is an Invoice, Lien Release, or other document type.</p>
          </div>
        </div>

        <div class="form-group">
          <label>Document *</label>
          <div class="file-drop-zone" id="dropZone">
            <input type="file" id="pdfFileInput" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.tiff,.tif,.heic,.doc,.docx,.xls,.xlsx,.csv,application/pdf,image/*,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
            <div class="drop-zone-content">
              <div class="drop-icon">üìÑ</div>
              <p>Click to select or drag file here</p>
              <small style="color: var(--text-secondary);">PDF, Images (JPG, PNG), Word, Excel</small>
            </div>
          </div>
          <div id="selectedFileName" class="selected-file" style="display: none;"></div>
        </div>

        <div id="processingStatus" class="processing-status" style="display: none;">
          <div class="processing-spinner"></div>
          <div id="processingMessage">Processing...</div>
        </div>

        <div id="resultArea" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelUploadBtn">Cancel</button>
        <button class="btn btn-primary" id="processBtn" disabled>Process Document</button>
      </div>
    </div>
  </div>

  <!-- AI Processing Overlay -->
  <div id="aiProcessingOverlay" class="ai-processing-overlay">
    <div class="ai-processing-card">
      <div class="ai-processing-header">
        <div class="ai-brain-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 4.5a2.5 2.5 0 0 0-4.96-.46 2.5 2.5 0 0 0-1.98 3 2.5 2.5 0 0 0-1.32 4.24 3 3 0 0 0 .34 5.58 2.5 2.5 0 0 0 2.96 3.08A2.5 2.5 0 0 0 12 19.5a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 12 4.5"/>
            <path d="m15.7 10.4-.9.4"/>
            <path d="m9.2 13.2-.9.4"/>
            <path d="m13.6 15.7-.4-.9"/>
            <path d="m10.8 9.2-.4-.9"/>
            <path d="m15.7 13.5-.9-.4"/>
            <path d="m9.2 10.9-.9-.4"/>
            <path d="m10.5 15.7.4-.9"/>
            <path d="m13.1 9.2.4-.9"/>
          </svg>
          <div class="ai-pulse-ring"></div>
          <div class="ai-pulse-ring delay-1"></div>
          <div class="ai-pulse-ring delay-2"></div>
        </div>
        <h2>AI Processing</h2>
        <p class="ai-processing-subtitle" id="aiProcessingSubtitle">Analyzing your document...</p>
      </div>

      <div class="ai-processing-steps">
        <div class="ai-step" id="aiStep1">
          <div class="ai-step-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">Upload & Read</span>
            <span class="ai-step-status" id="aiStep1Status">Waiting...</span>
          </div>
          <div class="ai-step-check">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
        </div>

        <div class="ai-step" id="aiStep2">
          <div class="ai-step-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 0 0-4 4c0 1.5.8 2.8 2 3.5v1a1.5 1.5 0 0 0 3 0v-1c1.2-.7 2-2 2-3.5a4 4 0 0 0-4-4z"/><path d="M12 22v-5"/><path d="m9 18 3-3 3 3"/><circle cx="12" cy="14" r="1"/></svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">AI Classification</span>
            <span class="ai-step-status" id="aiStep2Status">Waiting...</span>
          </div>
          <div class="ai-step-check">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
        </div>

        <div class="ai-step" id="aiStep3">
          <div class="ai-step-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">Vendor Match</span>
            <span class="ai-step-status" id="aiStep3Status">Waiting...</span>
          </div>
          <div class="ai-step-check">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
        </div>

        <div class="ai-step" id="aiStep4">
          <div class="ai-step-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h.01"/><path d="M17 7h.01"/><path d="M7 12h10"/><path d="M7 17h6"/></svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">Data Extraction</span>
            <span class="ai-step-status" id="aiStep4Status">Waiting...</span>
          </div>
          <div class="ai-step-check">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
        </div>

        <div class="ai-step" id="aiStep5">
          <div class="ai-step-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h8"/><circle cx="18" cy="18" r="3"/><path d="m21 21-1.5-1.5"/></svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">Cost Code & PO Match</span>
            <span class="ai-step-status" id="aiStep5Status">Waiting...</span>
          </div>
          <div class="ai-step-check">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
        </div>

        <div class="ai-step" id="aiStep6">
          <div class="ai-step-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">Save Invoice</span>
            <span class="ai-step-status" id="aiStep6Status">Waiting...</span>
          </div>
          <div class="ai-step-check">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
        </div>
      </div>

      <div class="ai-processing-footer">
        <div class="ai-progress-bar">
          <div class="ai-progress-fill" id="aiProgressFill"></div>
        </div>
        <p class="ai-progress-text" id="aiProgressText">Step 1 of 5</p>
      </div>
    </div>
  </div>

  <!-- Split Invoice Modal -->
  <div id="splitInvoiceModal" class="modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h2>Split Invoice</h2>
        <button class="close-btn" onclick="closeSplitModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="split-original-info">
          <div class="original-label">Original Invoice <span id="splitCreditBadge" class="badge badge-credit" style="display: none;">CREDIT</span></div>
          <div class="original-details">
            <span id="splitOriginalNumber" class="invoice-number"></span>
            <span id="splitOriginalVendor" class="vendor-name"></span>
            <span id="splitOriginalAmount" class="amount"></span>
          </div>
        </div>

        <div class="split-sections" id="splitSections">
          <!-- Split sections added dynamically -->
        </div>

        <button class="btn btn-secondary btn-sm" onclick="addSplitSection()">+ Add Split</button>

        <div class="split-totals">
          <div class="split-total-row">
            <span>Total Allocated:</span>
            <strong id="splitAllocatedAmount">$0.00</strong>
          </div>
          <div class="split-total-row">
            <span>Remaining:</span>
            <strong id="splitRemainingAmount" class="remaining">$0.00</strong>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSplitModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmSplitBtn" onclick="confirmSplit()" disabled>Split Invoice</button>
      </div>
    </div>
  </div>

  <!-- Modal Container (for edit/job selection modals) -->
  <div id="modal-container"></div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Core modules (defer for non-blocking load, maintains execution order) -->
  <script defer src="js/api-cache.js?v=20260117"></script>
  <script defer src="js/toasts.js?v=20260115-perf"></script>
  <script defer src="js/modal-helpers.js?v=20260116"></script>
  <script defer src="js/nav-sidebar.js?v=20260115-perf"></script>
  <script defer src="js/validation.js?v=20260115-perf"></script>
  <script defer src="js/cost-code-picker.js?v=20260115-perf"></script>
  <script defer src="js/searchable-picker.js?v=20260115-perf"></script>
  <script defer src="js/realtime.js?v=20260115-perf"></script>
  <script defer src="js/modals.js?v=20260115-perf"></script>
  <script defer src="js/sidebar.js?v=20260115-perf"></script>
  <script defer src="js/app.js?v=20260115-perf"></script>

  <!-- Simple Upload Script -->
  <script>
  (function() {
    // Elements
    var uploadBtn = document.getElementById('uploadBtn');
    var modal = document.getElementById('universalUploadModal');
    var closeBtn = document.getElementById('closeUploadBtn');
    var cancelBtn = document.getElementById('cancelUploadBtn');
    var processBtn = document.getElementById('processBtn');
    var fileInput = document.getElementById('pdfFileInput');
    var dropZone = document.getElementById('dropZone');
    var fileNameDiv = document.getElementById('selectedFileName');
    var processingDiv = document.getElementById('processingStatus');
    var processingMsg = document.getElementById('processingMessage');
    var resultArea = document.getElementById('resultArea');

    var selectedFile = null;

    // Open modal
    uploadBtn.onclick = function() {
      console.log('Opening upload modal');
      resetModal();
      modal.style.display = 'flex';
      modal.style.opacity = '1';
    };

    // Close modal
    function closeModal() {
      modal.style.display = 'none';
      resetModal();
    }

    closeBtn.onclick = closeModal;
    cancelBtn.onclick = closeModal;

    // Click outside to close
    modal.onclick = function(e) {
      if (e.target === modal) closeModal();
    };

    // Escape key to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeModal();
      }
    });

    // Reset modal state
    function resetModal() {
      selectedFile = null;
      fileInput.value = '';
      fileNameDiv.style.display = 'none';
      fileNameDiv.textContent = '';
      processingDiv.style.display = 'none';
      resultArea.style.display = 'none';
      resultArea.innerHTML = '';
      processBtn.disabled = true;
      processBtn.textContent = 'Process Document';
    }

    // File selection
    fileInput.onchange = function() {
      if (fileInput.files && fileInput.files[0]) {
        selectedFile = fileInput.files[0];
        fileNameDiv.textContent = selectedFile.name;
        fileNameDiv.style.display = 'block';
        processBtn.disabled = false;
        console.log('File selected:', selectedFile.name);
      }
    };

    // Drag and drop
    dropZone.ondragover = function(e) {
      e.preventDefault();
      dropZone.classList.add('dragover');
    };

    dropZone.ondragleave = function() {
      dropZone.classList.remove('dragover');
    };

    dropZone.ondrop = function(e) {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        var file = e.dataTransfer.files[0];
        // Accept PDFs, images, Word docs, and Excel files
        var validTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/tiff', 'image/heic',
          'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/csv'];
        var validExtensions = ['.pdf', '.jpg', '.jpeg', '.png', '.gif', '.webp', '.tiff', '.tif', '.heic', '.doc', '.docx', '.xls', '.xlsx', '.csv'];
        var ext = '.' + file.name.split('.').pop().toLowerCase();

        if (validTypes.includes(file.type) || validExtensions.includes(ext)) {
          selectedFile = file;
          fileNameDiv.textContent = file.name;
          fileNameDiv.style.display = 'block';
          processBtn.disabled = false;
          console.log('File dropped:', file.name);
        } else {
          showToast('Unsupported file type. Use PDF, images, Word, or Excel.', 'error');
        }
      }
    };

    // AI Processing Overlay helpers
    var aiOverlay = document.getElementById('aiProcessingOverlay');
    var aiProgressFill = document.getElementById('aiProgressFill');
    var aiProgressText = document.getElementById('aiProgressText');
    var aiSubtitle = document.getElementById('aiProcessingSubtitle');

    function showAIOverlay() {
      // Reset all steps
      for (var i = 1; i <= 5; i++) {
        var step = document.getElementById('aiStep' + i);
        var status = document.getElementById('aiStep' + i + 'Status');
        step.className = 'ai-step';
        status.textContent = 'Waiting...';
      }
      aiProgressFill.style.width = '0%';
      aiProgressText.textContent = 'Step 1 of 5';
      aiSubtitle.textContent = 'Analyzing your document...';
      aiOverlay.classList.remove('success', 'error');
      aiOverlay.classList.add('show');
    }

    function hideAIOverlay() {
      aiOverlay.classList.remove('show');
    }

    var TOTAL_STEPS = 6;

    function updateAIStep(stepNum, status, statusText) {
      var step = document.getElementById('aiStep' + stepNum);
      var statusEl = document.getElementById('aiStep' + stepNum + 'Status');

      // Remove previous states
      step.classList.remove('active', 'completed', 'error');

      if (status === 'active') {
        step.classList.add('active');
        statusEl.textContent = statusText || 'Processing...';
      } else if (status === 'completed') {
        step.classList.add('completed');
        statusEl.textContent = statusText || 'Done';
      } else if (status === 'error') {
        step.classList.add('error');
        statusEl.textContent = statusText || 'Failed';
      }

      // Update progress
      var progress = (stepNum / TOTAL_STEPS) * 100;
      if (status === 'active') progress = ((stepNum - 1) / TOTAL_STEPS) * 100 + (100 / TOTAL_STEPS / 2);
      aiProgressFill.style.width = progress + '%';
      aiProgressText.textContent = 'Step ' + stepNum + ' of ' + TOTAL_STEPS;
    }

    async function animateStep(stepNum, label, minDuration) {
      minDuration = minDuration || 400;
      updateAIStep(stepNum, 'active', label + '...');
      var start = Date.now();
      return function complete(statusText) {
        var elapsed = Date.now() - start;
        var remaining = Math.max(0, minDuration - elapsed);
        return new Promise(function(resolve) {
          setTimeout(function() {
            updateAIStep(stepNum, 'completed', statusText || 'Complete');
            resolve();
          }, remaining);
        });
      };
    }

    // Process document
    processBtn.onclick = async function() {
      if (!selectedFile) {
        showToast('Please select a file first', 'error');
        return;
      }

      console.log('Processing document:', selectedFile.name);
      processBtn.disabled = true;
      processBtn.textContent = 'Processing...';
      modal.style.display = 'none';
      resultArea.style.display = 'none';

      // Show AI overlay
      showAIOverlay();
      aiSubtitle.textContent = 'Reading ' + selectedFile.name + '...';

      try {
        // Step 1: Reading document
        var complete1 = await animateStep(1, 'Reading PDF', 400);

        var formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('uploaded_by', 'Jake Ross');

        await complete1(selectedFile.name);
        aiSubtitle.textContent = 'Sending to AI for analysis...';

        // Step 2: Classifying document type
        var complete2 = await animateStep(2, 'AI analyzing document', 300);

        var response = await fetch('/api/documents/process', {
          method: 'POST',
          body: formData
        });

        var result = await response.json();
        console.log('Processing result:', result);

        // Show classification result
        var docType = result.documentType || result.classification?.type || 'unknown';
        var confidence = result.classification?.confidence || 0;
        var typeLabel = docType.charAt(0).toUpperCase() + docType.slice(1).replace('_', ' ');
        await complete2(typeLabel + ' (' + Math.round(confidence * 100) + '%)');
        aiSubtitle.textContent = 'Found ' + typeLabel.toLowerCase() + ', extracting details...';

        // Step 3: Matching vendor
        var complete3 = await animateStep(3, 'Finding vendor', 300);
        await new Promise(function(r) { setTimeout(r, 400); });
        var vendorName = result.data?.vendor?.name || result.data?.extracted?.vendor?.companyName || 'Unknown Vendor';
        var vendorConf = result.data?.ai_confidence?.vendor || 0;
        var vendorTradeDB = result.data?.vendor?.trade || '';
        var vendorStatus = vendorName + (vendorConf ? ' (' + Math.round(vendorConf * 100) + '%)' : '');
        if (vendorTradeDB) {
          vendorStatus += ' [' + vendorTradeDB + ']';
        }
        await complete3(vendorStatus);
        aiSubtitle.textContent = vendorTradeDB
          ? 'Matched: ' + vendorName + ' (' + vendorTradeDB + ' trade)'
          : 'Matched to ' + vendorName;

        // Step 4: Extracting data - show all extracted fields
        var complete4 = await animateStep(4, 'Extracting invoice data', 300);
        await new Promise(function(r) { setTimeout(r, 400); });
        var invNum = result.data?.extracted?.invoiceNumber || result.savedRecord?.invoice_number || '?';
        var invDate = result.data?.extracted?.invoiceDate || result.savedRecord?.invoice_date || '';
        var amount = result.data?.extracted?.totalAmount || result.savedRecord?.amount || 0;
        var jobName = result.data?.matchedJob?.name || result.savedRecord?.job?.name || '';

        // Build extraction summary
        var extractedInfo = '#' + invNum + ' - $' + Number(amount).toLocaleString();
        await complete4(extractedInfo);

        // Update subtitle with job match
        if (jobName) {
          aiSubtitle.textContent = 'Matched to job: ' + jobName;
        } else {
          aiSubtitle.textContent = 'Invoice #' + invNum + ' for $' + Number(amount).toLocaleString();
        }

        // Step 5: Cost Code & PO Matching
        var complete5 = await animateStep(5, 'Finding cost codes', 300);
        await new Promise(function(r) { setTimeout(r, 350); });

        // Extract cost code and PO info from result
        var suggestedCodes = result.data?.suggestions?.cost_codes || result.data?.suggested_allocations || [];
        var vendorTrade = result.data?.vendor?.trade || result.data?.extracted?.vendor?.tradeType || '';
        var matchedPO = result.data?.matchedPO || result.data?.suggestions?.po || null;

        var costCodeInfo = '';
        if (suggestedCodes.length > 0) {
          var codes = suggestedCodes.map(function(c) { return c.code; }).join(', ');
          costCodeInfo = codes;
          if (vendorTrade) {
            aiSubtitle.textContent = 'Using ' + vendorTrade + ' trade ‚Üí ' + codes;
          } else {
            aiSubtitle.textContent = 'Suggested cost codes: ' + codes;
          }
        } else {
          costCodeInfo = 'No match';
          aiSubtitle.textContent = 'No cost code match found';
        }

        // Show PO match info
        if (matchedPO) {
          costCodeInfo += ' | PO: ' + (matchedPO.po_number || matchedPO.poNumber || 'Found');
          aiSubtitle.textContent += ' | PO matched';
        }

        await complete5(costCodeInfo);

        // Step 6: Creating invoice
        var complete6 = await animateStep(6, 'Saving to database', 300);
        await new Promise(function(r) { setTimeout(r, 300); });

        if (!response.ok) {
          throw new Error(result.error || result.message || 'Processing failed');
        }

        var savedId = result.savedRecord?.id || result.data?.invoiceId;
        await complete6(savedId ? 'Saved' : 'Complete');

        // Success state
        aiOverlay.classList.add('success');
        var successMsg = vendorName + ' - $' + Number(amount).toLocaleString();
        if (jobName) successMsg += ' ‚Üí ' + jobName;
        aiSubtitle.textContent = successMsg;
        aiProgressFill.style.width = '100%';

        // Show result
        var docType = result.documentType || 'unknown';
        var typeLabels = {
          invoice: 'Invoice',
          lien_release: 'Lien Release',
          purchase_order: 'Purchase Order',
          quote: 'Quote',
          unknown: 'Unknown Document'
        };

        showToast(typeLabels[docType] + ' processed successfully', 'success');

        // Refresh the invoice list
        if (typeof loadInvoices === 'function') {
          loadInvoices();
        }

        // Hide overlay and close after delay
        setTimeout(function() {
          hideAIOverlay();
          closeModal();
        }, 1500);

      } catch (err) {
        console.error('Upload error:', err);

        // Show error in overlay
        aiOverlay.classList.add('error');
        aiSubtitle.textContent = err.message || 'Processing failed';

        // Find and mark the failed step
        for (var i = 1; i <= TOTAL_STEPS; i++) {
          var step = document.getElementById('aiStep' + i);
          if (step.classList.contains('active')) {
            updateAIStep(i, 'error', 'Failed');
            break;
          }
        }

        showToast(err.message || 'Upload failed', 'error');

        // Hide overlay and show modal again
        setTimeout(function() {
          hideAIOverlay();
          modal.style.display = 'flex';
          processBtn.disabled = false;
          processBtn.textContent = 'Try Again';
        }, 2000);
      }
    };

    console.log('Upload module initialized');
  })();
  </script>
</body>
</html>
