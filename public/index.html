<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Invoice Approval</title>
  <link rel="stylesheet" href="css/styles.css?v=20260115i">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-top">
        <div class="header-brand">
          <span class="brand-icon">üèóÔ∏è</span>
          <span class="brand-name">Ross Built</span>
        </div>
        <nav class="main-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
        <div class="header-actions">
          <button class="btn btn-primary" id="uploadBtn">+ Upload</button>
          <span class="connection-dot" id="connectionDot" title="Checking connection..."></span>
        </div>
      </div>
      <div class="header-sub">
        <nav class="sub-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="app-body">
      <main class="main">
      <!-- Filters -->
      <div class="table-toolbar">
        <div class="search-box">
          <input type="text" id="invoiceSearchInput" placeholder="Search invoices..." class="form-control search-input">
          <button class="search-clear-btn" id="invoiceSearchClear" style="display: none;" onclick="clearInvoiceSearch()">&times;</button>
        </div>
      </div>

      <!-- Invoice List -->
      <div class="invoice-list" id="invoiceList">
        <div class="loading">Loading invoices...</div>
      </div>
    </main>
    </div>
  </div>

  <!-- Invoice Detail Modal -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content modal-xl">
      <div class="modal-header">
        <h2 id="invoiceModalTitle">Invoice Details</h2>
        <button class="close-btn" onclick="closeModal('invoiceModal')">&times;</button>
      </div>
      <div class="modal-body split-view">
        <div class="pdf-viewer-container" id="pdfViewerContainer">
          <div class="pdf-placeholder">
            <div class="pdf-icon">PDF</div>
            <p>No PDF attached</p>
          </div>
        </div>
        <div class="invoice-info-panel" id="invoiceInfoPanel">
          <!-- Filled dynamically -->
        </div>
      </div>
      <div class="modal-footer" id="invoiceModalFooter">
        <!-- Action buttons -->
      </div>
    </div>
  </div>

  <!-- Denial Modal -->
  <div id="denialModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Deny Invoice</h2>
        <button class="close-btn" onclick="closeModal('denialModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Reason for Denial *</label>
          <textarea id="denialReason" rows="3" required placeholder="Explain why..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('denialModal')">Cancel</button>
        <button class="btn btn-danger" onclick="submitDenial()">Deny Invoice</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Mark Invoice as Paid</h2>
        <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="paymentInvoiceId">
        <div class="form-group">
          <label>Payment Method *</label>
          <select id="paymentMethod" class="form-control" required>
            <option value="">Select method...</option>
            <option value="check">Check</option>
            <option value="ach">ACH Transfer</option>
            <option value="wire">Wire Transfer</option>
            <option value="credit_card">Credit Card</option>
            <option value="cash">Cash</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reference # (Check #, Transaction ID, etc.)</label>
          <input type="text" id="paymentReference" class="form-control" placeholder="e.g. Check #1234">
        </div>
        <div class="form-group">
          <label>Payment Date</label>
          <input type="date" id="paymentDate" class="form-control">
        </div>
        <div class="form-group">
          <label>Amount Paid</label>
          <input type="number" id="paymentAmount" class="form-control" step="0.01" placeholder="Leave blank for full amount">
          <small class="form-hint">Leave blank to use the invoice amount</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('paymentModal')">Cancel</button>
        <button class="btn btn-success" onclick="confirmMarkPaid()">Mark as Paid</button>
      </div>
    </div>
  </div>

  <!-- Universal Upload Modal - Simple Version -->
  <div id="universalUploadModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upload Document</h2>
        <button class="close-btn" id="closeUploadBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="upload-info-banner">
          <div class="info-icon">AI</div>
          <div class="info-text">
            <strong>Smart Document Processing</strong>
            <p>AI will automatically detect if this is an Invoice, Lien Release, or other document type.</p>
          </div>
        </div>

        <div class="form-group">
          <label>Document *</label>
          <div class="file-drop-zone" id="dropZone">
            <input type="file" id="pdfFileInput" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.tiff,.tif,.heic,.doc,.docx,.xls,.xlsx,.csv,application/pdf,image/*,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
            <div class="drop-zone-content">
              <div class="drop-icon">üìÑ</div>
              <p>Click to select or drag file here</p>
              <small style="color: var(--text-secondary);">PDF, Images (JPG, PNG), Word, Excel</small>
            </div>
          </div>
          <div id="selectedFileName" class="selected-file" style="display: none;"></div>
        </div>

        <div id="processingStatus" class="processing-status" style="display: none;">
          <div class="processing-spinner"></div>
          <div id="processingMessage">Processing...</div>
        </div>

        <div id="resultArea" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelUploadBtn">Cancel</button>
        <button class="btn btn-primary" id="processBtn" disabled>Process Document</button>
      </div>
    </div>
  </div>

  <!-- Split Invoice Modal -->
  <div id="splitInvoiceModal" class="modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h2>Split Invoice</h2>
        <button class="close-btn" onclick="closeSplitModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="split-original-info">
          <div class="original-label">Original Invoice <span id="splitCreditBadge" class="badge badge-credit" style="display: none;">CREDIT</span></div>
          <div class="original-details">
            <span id="splitOriginalNumber" class="invoice-number"></span>
            <span id="splitOriginalVendor" class="vendor-name"></span>
            <span id="splitOriginalAmount" class="amount"></span>
          </div>
        </div>

        <div class="split-sections" id="splitSections">
          <!-- Split sections added dynamically -->
        </div>

        <button class="btn btn-secondary btn-sm" onclick="addSplitSection()">+ Add Split</button>

        <div class="split-totals">
          <div class="split-total-row">
            <span>Total Allocated:</span>
            <strong id="splitAllocatedAmount">$0.00</strong>
          </div>
          <div class="split-total-row">
            <span>Remaining:</span>
            <strong id="splitRemainingAmount" class="remaining">$0.00</strong>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSplitModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmSplitBtn" onclick="confirmSplit()" disabled>Split Invoice</button>
      </div>
    </div>
  </div>

  <!-- Modal Container (for edit/job selection modals) -->
  <div id="modal-container"></div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Core modules -->
  <script src="js/toasts.js?v=20260114b"></script>
  <script src="js/nav-sidebar.js?v=20260114b"></script>
  <script src="js/validation.js?v=20260114b"></script>
  <script src="js/cost-code-picker.js?v=20260114b"></script>
  <script src="js/searchable-picker.js?v=20260114f"></script>
  <script src="js/realtime.js?v=20260114f"></script>
  <script src="js/modals.js?v=20260115f"></script>
  <script src="js/sidebar.js?v=20260114f"></script>
  <script src="js/app.js?v=20260115-co-prompt"></script>

  <!-- Simple Upload Script -->
  <script>
  (function() {
    // Elements
    var uploadBtn = document.getElementById('uploadBtn');
    var modal = document.getElementById('universalUploadModal');
    var closeBtn = document.getElementById('closeUploadBtn');
    var cancelBtn = document.getElementById('cancelUploadBtn');
    var processBtn = document.getElementById('processBtn');
    var fileInput = document.getElementById('pdfFileInput');
    var dropZone = document.getElementById('dropZone');
    var fileNameDiv = document.getElementById('selectedFileName');
    var processingDiv = document.getElementById('processingStatus');
    var processingMsg = document.getElementById('processingMessage');
    var resultArea = document.getElementById('resultArea');

    var selectedFile = null;

    // Open modal
    uploadBtn.onclick = function() {
      console.log('Opening upload modal');
      resetModal();
      modal.style.display = 'flex';
      modal.style.opacity = '1';
    };

    // Close modal
    function closeModal() {
      modal.style.display = 'none';
      resetModal();
    }

    closeBtn.onclick = closeModal;
    cancelBtn.onclick = closeModal;

    // Click outside to close
    modal.onclick = function(e) {
      if (e.target === modal) closeModal();
    };

    // Reset modal state
    function resetModal() {
      selectedFile = null;
      fileInput.value = '';
      fileNameDiv.style.display = 'none';
      fileNameDiv.textContent = '';
      processingDiv.style.display = 'none';
      resultArea.style.display = 'none';
      resultArea.innerHTML = '';
      processBtn.disabled = true;
      processBtn.textContent = 'Process Document';
    }

    // File selection
    fileInput.onchange = function() {
      if (fileInput.files && fileInput.files[0]) {
        selectedFile = fileInput.files[0];
        fileNameDiv.textContent = selectedFile.name;
        fileNameDiv.style.display = 'block';
        processBtn.disabled = false;
        console.log('File selected:', selectedFile.name);
      }
    };

    // Drag and drop
    dropZone.ondragover = function(e) {
      e.preventDefault();
      dropZone.classList.add('dragover');
    };

    dropZone.ondragleave = function() {
      dropZone.classList.remove('dragover');
    };

    dropZone.ondrop = function(e) {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        var file = e.dataTransfer.files[0];
        // Accept PDFs, images, Word docs, and Excel files
        var validTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/tiff', 'image/heic',
          'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/csv'];
        var validExtensions = ['.pdf', '.jpg', '.jpeg', '.png', '.gif', '.webp', '.tiff', '.tif', '.heic', '.doc', '.docx', '.xls', '.xlsx', '.csv'];
        var ext = '.' + file.name.split('.').pop().toLowerCase();

        if (validTypes.includes(file.type) || validExtensions.includes(ext)) {
          selectedFile = file;
          fileNameDiv.textContent = file.name;
          fileNameDiv.style.display = 'block';
          processBtn.disabled = false;
          console.log('File dropped:', file.name);
        } else {
          showToast('Unsupported file type. Use PDF, images, Word, or Excel.', 'error');
        }
      }
    };

    // Process document
    processBtn.onclick = async function() {
      if (!selectedFile) {
        showToast('Please select a file first', 'error');
        return;
      }

      console.log('Processing document:', selectedFile.name);
      processBtn.disabled = true;
      processBtn.textContent = 'Processing...';
      processingDiv.style.display = 'flex';
      processingMsg.textContent = 'Uploading and analyzing document...';
      resultArea.style.display = 'none';

      try {
        var formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('uploaded_by', 'Jake Ross');

        var response = await fetch('/api/documents/process', {
          method: 'POST',
          body: formData
        });

        var result = await response.json();
        console.log('Processing result:', result);

        processingDiv.style.display = 'none';

        if (!response.ok) {
          throw new Error(result.error || 'Processing failed');
        }

        // Show result
        var docType = result.documentType || 'unknown';
        var typeLabels = {
          invoice: 'Invoice',
          lien_release: 'Lien Release',
          purchase_order: 'Purchase Order',
          quote: 'Quote',
          unknown: 'Unknown Document'
        };

        resultArea.innerHTML = '<div class="result-success">' +
          '<h3>Document Processed</h3>' +
          '<p><strong>Type:</strong> ' + (typeLabels[docType] || docType) + '</p>' +
          (result.data?.vendor?.name ? '<p><strong>Vendor:</strong> ' + result.data.vendor.name + '</p>' : '') +
          (result.data?.extracted?.totalAmount ? '<p><strong>Amount:</strong> $' + Number(result.data.extracted.totalAmount).toLocaleString() + '</p>' : '') +
          '</div>';
        resultArea.style.display = 'block';

        processBtn.textContent = 'Done';
        showToast(typeLabels[docType] + ' processed successfully', 'success');

        // Refresh the invoice list
        if (typeof loadInvoices === 'function') {
          loadInvoices();
        }

        // Auto close after 2 seconds
        setTimeout(function() {
          closeModal();
        }, 2000);

      } catch (err) {
        console.error('Upload error:', err);
        processingDiv.style.display = 'none';
        processBtn.disabled = false;
        processBtn.textContent = 'Try Again';
        showToast(err.message || 'Upload failed', 'error');
      }
    };

    console.log('Upload module initialized');
  })();
  </script>
</body>
</html>
