<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Invoice Approval</title>
  <link rel="stylesheet" href="css/styles.css?v=20260109n">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1>Invoice Approval</h1>
        <nav class="header-nav">
          <a href="index.html" class="nav-link active">Invoices</a>
          <a href="pos.html" class="nav-link">Purchase Orders</a>
          <a href="draws.html" class="nav-link">Draws</a>
          <a href="budgets.html" class="nav-link">Budgets</a>
        </nav>
      </div>
      <button class="btn btn-primary" onclick="showUploadInvoiceModal()">+ Upload Invoice</button>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Filters -->
      <div class="table-toolbar">
        <select id="jobFilter" class="job-filter">
          <option value="">All Jobs</option>
        </select>
      </div>

      <!-- Invoice List -->
      <div class="invoice-list" id="invoiceList">
        <div class="loading">Loading invoices...</div>
      </div>
    </main>
  </div>

  <!-- Invoice Detail Modal (Split View with PDF) -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content modal-xl">
      <div class="modal-header">
        <h2 id="invoiceModalTitle">Invoice Details</h2>
        <button class="close-btn" onclick="closeModal('invoiceModal')">&times;</button>
      </div>
      <div class="modal-body split-view">
        <div class="pdf-viewer-container" id="pdfViewerContainer">
          <div class="pdf-placeholder">
            <div class="pdf-icon">PDF</div>
            <p>No PDF attached</p>
          </div>
        </div>
        <div class="invoice-info-panel" id="invoiceInfoPanel">
          <!-- Filled dynamically -->
        </div>
      </div>
      <div class="modal-footer" id="invoiceModalFooter">
        <!-- Action buttons -->
      </div>
    </div>
  </div>

  <!-- Upload Invoice Modal -->
  <div id="uploadInvoiceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upload Invoice</h2>
        <button class="close-btn" onclick="closeModal('uploadInvoiceModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="uploadInvoiceForm">
          <!-- AI Toggle -->
          <div class="form-group ai-toggle">
            <label class="toggle-label">
              <input type="checkbox" id="useAIProcessing" checked onchange="toggleAIMode(this.checked)">
              <span class="toggle-text">Use AI Processing</span>
              <span class="toggle-hint">Automatically extracts vendor, amount, job, and renames file</span>
            </label>
          </div>

          <div class="form-group">
            <label>PDF File *</label>
            <div class="file-upload-area" id="fileUploadArea">
              <input type="file" id="invoicePdfFile" accept=".pdf" required>
              <div class="file-upload-text">
                <span class="upload-icon">+</span>
                <p>Click or drag PDF here</p>
              </div>
              <div class="file-name" id="uploadFileName"></div>
            </div>
          </div>

          <!-- Manual fields (hidden when AI is enabled) -->
          <div id="manualFields" style="display: none;">
            <div class="form-group">
              <label>Job *</label>
              <div id="upload-job-picker-container" class="search-picker-container"></div>
              <input type="hidden" id="uploadJobId">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Vendor</label>
                <div id="upload-vendor-picker-container" class="search-picker-container"></div>
                <input type="hidden" id="uploadVendorId">
              </div>
              <div class="form-group">
                <label>Amount</label>
                <input type="number" id="uploadAmount" step="0.01" placeholder="0.00">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Invoice #</label>
                <input type="text" id="uploadInvoiceNumber" placeholder="e.g. INV-001">
              </div>
              <div class="form-group">
                <label>Invoice Date</label>
                <input type="date" id="uploadInvoiceDate">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('uploadInvoiceModal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitUploadInvoice()">Process with AI</button>
      </div>
    </div>
  </div>

  <!-- AI Processing Overlay -->
  <div id="aiProcessingOverlay" class="ai-processing-overlay">
    <div class="ai-processing-card">
      <div class="ai-processing-header">
        <div class="ai-brain-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 2a4 4 0 0 1 4 4c0 1.1-.9 2-2 2h-4c-1.1 0-2-.9-2-2a4 4 0 0 1 4-4z"/>
            <path d="M8 8v2a4 4 0 0 0 8 0V8"/>
            <path d="M12 14v4"/>
            <path d="M8 18h8"/>
            <circle cx="9" cy="6" r="0.5" fill="currentColor"/>
            <circle cx="15" cy="6" r="0.5" fill="currentColor"/>
          </svg>
          <div class="ai-pulse-ring"></div>
          <div class="ai-pulse-ring delay-1"></div>
          <div class="ai-pulse-ring delay-2"></div>
        </div>
        <h2>AI Processing Invoice</h2>
        <p class="ai-processing-subtitle">Analyzing document with Claude AI</p>
      </div>

      <div class="ai-processing-steps">
        <div class="ai-step" data-step="extract">
          <div class="ai-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14,2 14,8 20,8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">Extracting Text</span>
            <span class="ai-step-status">Reading PDF content...</span>
          </div>
          <div class="ai-step-check">‚úì</div>
        </div>

        <div class="ai-step" data-step="analyze">
          <div class="ai-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">AI Analysis</span>
            <span class="ai-step-status">Claude is reading the invoice...</span>
          </div>
          <div class="ai-step-check">‚úì</div>
        </div>

        <div class="ai-step" data-step="match">
          <div class="ai-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <path d="M20 8v6"/>
              <path d="M23 11h-6"/>
            </svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">Matching Data</span>
            <span class="ai-step-status">Finding vendor & job matches...</span>
          </div>
          <div class="ai-step-check">‚úì</div>
        </div>

        <div class="ai-step" data-step="save">
          <div class="ai-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17,21 17,13 7,13 7,21"/>
              <polyline points="7,3 7,8 15,8"/>
            </svg>
          </div>
          <div class="ai-step-content">
            <span class="ai-step-label">Saving Invoice</span>
            <span class="ai-step-status">Creating invoice record...</span>
          </div>
          <div class="ai-step-check">‚úì</div>
        </div>
      </div>

      <div class="ai-processing-footer">
        <div class="ai-progress-bar">
          <div class="ai-progress-fill"></div>
        </div>
        <p class="ai-progress-text">Starting...</p>
      </div>
    </div>
  </div>

  <!-- Denial Modal -->
  <div id="denialModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Deny Invoice</h2>
        <button class="close-btn" onclick="closeModal('denialModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Reason for Denial *</label>
          <textarea id="denialReason" rows="3" required placeholder="Explain why..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('denialModal')">Cancel</button>
        <button class="btn btn-danger" onclick="submitDenial()">Deny Invoice</button>
      </div>
    </div>
  </div>

  <!-- Modal Container (for edit/job selection modals) -->
  <div id="modal-container"></div>

  <!-- Connection Status Indicator -->
  <div class="connection-status" id="connectionStatus">
    <span class="connection-dot" id="connectionDot"></span>
    <span id="connectionText">Connecting...</span>
  </div>

  <!-- Core modules (load before app.js) -->
  <script src="js/toasts.js?v=20260107"></script>
  <script src="js/validation.js?v=20260108d"></script>
  <script src="js/cost-code-picker.js?v=20260107"></script>
  <script src="js/searchable-picker.js?v=20260108"></script>
  <script src="js/realtime.js?v=20260107"></script>
  <script src="js/modals.js?v=20260109n"></script>

  <!-- Main app -->
  <script src="js/app.js?v=20260109c"></script>

  <!-- Initialize connection status indicator -->
  <script>
    // Update connection status UI
    window.realtimeSync.on('connectionChange', (data) => {
      const dot = document.getElementById('connectionDot');
      const text = document.getElementById('connectionText');

      dot.className = 'connection-dot ' + data.state;

      const stateLabels = {
        connected: 'Connected',
        connecting: 'Connecting...',
        reconnecting: 'Reconnecting...',
        disconnected: 'Disconnected',
        offline: 'Offline',
        failed: 'Connection Failed'
      };

      text.textContent = stateLabels[data.state] || data.state;
    });

    // Listen for invoice updates to refresh list
    window.realtimeSync.on('invoice_update', () => {
      if (typeof loadInvoices === 'function') {
        loadInvoices();
      }
    });

    window.realtimeSync.on('invoice_change', () => {
      if (typeof loadInvoices === 'function') {
        loadInvoices();
      }
    });
  </script>
</body>
</html>
