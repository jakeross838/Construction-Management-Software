<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fnfkowpdlffzjqtmbnmj.supabase.co">
  <link rel="dns-prefetch" href="https://fnfkowpdlffzjqtmbnmj.supabase.co">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Cost Codes</title>
  <link rel="stylesheet" href="css/styles.css?v=20260115-perf3">
  <style>
    .cost-codes-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      padding: 1rem 0;
    }
    .cost-codes-section {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: var(--bg-card-elevated);
      border-bottom: 1px solid var(--border);
    }
    .section-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .section-body {
      padding: 0;
      max-height: 500px;
      overflow-y: auto;
    }
    .code-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem 1.25rem;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    .code-item:hover {
      background: var(--bg-card-elevated);
    }
    .code-item:last-child {
      border-bottom: none;
    }
    .code-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .code-badge {
      background: var(--accent-blue);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      font-weight: 600;
      min-width: 60px;
      text-align: center;
    }
    .code-name {
      color: var(--text-primary);
      font-weight: 500;
    }
    .code-category {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    .code-actions {
      display: flex;
      gap: 0.5rem;
    }
    .mapping-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }
    .mapping-item:hover {
      background: var(--bg-card-elevated);
    }
    .trade-badge {
      background: var(--accent-green);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: capitalize;
    }
    .mapping-arrow {
      color: var(--text-secondary);
      font-size: 1.25rem;
    }
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }
    .add-form {
      display: flex;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: var(--bg-card-elevated);
      border-top: 1px solid var(--border);
    }
    .add-form input, .add-form select {
      flex: 1;
    }
    .stats-bar {
      display: flex;
      gap: 2rem;
      padding: 1rem 1.5rem;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-blue);
    }
    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-top">
        <div class="header-brand">
          <span class="brand-icon">üèóÔ∏è</span>
          <span class="brand-name">Ross Built</span>
        </div>
        <nav class="main-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showAddCodeModal()">+ Add Cost Code</button>
        </div>
      </div>
      <div class="header-sub">
        <nav class="sub-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="app-body">
      <main class="main">
        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar">
          <div class="stat-item">
            <div class="stat-value" id="totalCodes">-</div>
            <div class="stat-label">Cost Codes</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalCategories">-</div>
            <div class="stat-label">Categories</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalMappings">-</div>
            <div class="stat-label">AI Learned</div>
          </div>
        </div>

        <!-- Cost Codes Section - Full Width -->
        <div class="cost-codes-section">
          <div class="section-header">
            <h3>Cost Codes</h3>
            <div style="display: flex; align-items: center; gap: 1rem;">
              <span class="text-secondary" id="codesCount"></span>
              <input type="text" id="codeSearch" class="form-control" placeholder="Search codes..." style="width: 200px; margin: 0;" oninput="filterCostCodes()">
            </div>
          </div>
          <div class="section-body" id="codesList" style="max-height: 600px;">
            <div class="loading">Loading...</div>
          </div>
        </div>

        <!-- Hidden: Trade Mappings (AI uses these in background) -->
        <div id="tradesList" style="display: none;"></div>

        <!-- Info Text -->
        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(63, 185, 80, 0.1); border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.3);">
          <strong style="color: var(--accent-green);">AI Learning:</strong>
          <p style="margin: 0.5rem 0 0; color: var(--text-secondary); font-size: 0.9rem;">
            The AI learns from your cost code selections. When you assign a cost code to an invoice, the AI remembers the vendor's trade type and will auto-suggest that code for future invoices from similar vendors.
          </p>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Cost Code Modal -->
  <div id="addCodeModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Add Cost Code</h2>
        <button class="close-btn" onclick="closeAddCodeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Code *</label>
          <input type="text" id="newCodeCode" class="form-control" placeholder="e.g., 09500" maxlength="10">
        </div>
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="newCodeName" class="form-control" placeholder="e.g., Acoustical Ceilings">
        </div>
        <div class="form-group">
          <label>Category</label>
          <input type="text" id="newCodeCategory" class="form-control" placeholder="e.g., Finishes">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddCodeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewCode()">Add Code</button>
      </div>
    </div>
  </div>

  <!-- Add Trade Mapping Modal -->
  <div id="addTradeModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Add Trade Mapping</h2>
        <button class="close-btn" onclick="closeAddTradeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Trade Type *</label>
          <input type="text" id="newTradeType" class="form-control" placeholder="e.g., masonry" style="text-transform: lowercase;">
        </div>
        <div class="form-group">
          <label>Cost Code *</label>
          <select id="newTradeCostCode" class="form-control">
            <option value="">Select cost code...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddTradeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewTradeMapping()">Add Mapping</button>
      </div>
    </div>
  </div>

  <!-- Edit Code Modal -->
  <div id="editCodeModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Edit Cost Code</h2>
        <button class="close-btn" onclick="closeEditCodeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCodeId">
        <div class="form-group">
          <label>Code *</label>
          <input type="text" id="editCodeCode" class="form-control" maxlength="10">
        </div>
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="editCodeName" class="form-control">
        </div>
        <div class="form-group">
          <label>Category</label>
          <input type="text" id="editCodeCategory" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteCode()" style="margin-right: auto;">Delete</button>
        <button class="btn btn-secondary" onclick="closeEditCodeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEditCode()">Save</button>
      </div>
    </div>
  </div>

  <script src="js/toasts.js"></script>
  <script src="js/modal-helpers.js"></script>
  <script src="js/nav-sidebar.js"></script>
  <script>
    let costCodes = [];
    let tradeMappings = [];

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await Promise.all([loadCostCodes(), loadTradeMappings()]);
      updateStats();
    });

    async function loadCostCodes() {
      try {
        const res = await fetch('/api/cost-codes');
        const data = await res.json();
        costCodes = data.costCodes || [];
        renderCostCodes();
      } catch (err) {
        console.error('Failed to load cost codes:', err);
        document.getElementById('codesList').innerHTML = '<div class="empty-state">Failed to load</div>';
      }
    }

    async function loadTradeMappings() {
      try {
        const res = await fetch('/api/cost-codes/trade-mappings');
        const data = await res.json();
        tradeMappings = data.mappings || [];
        renderTradeMappings();
      } catch (err) {
        console.error('Failed to load trade mappings:', err);
        document.getElementById('tradesList').innerHTML = '<div class="empty-state">Failed to load</div>';
      }
    }

    function renderCostCodes() {
      const container = document.getElementById('codesList');
      document.getElementById('codesCount').textContent = costCodes.length + ' codes';

      if (costCodes.length === 0) {
        container.innerHTML = '<div class="empty-state">No cost codes defined</div>';
        return;
      }

      container.innerHTML = costCodes.map(code => `
        <div class="code-item">
          <div class="code-info">
            <span class="code-badge">${code.code}</span>
            <div>
              <div class="code-name">${code.name}</div>
              ${code.category ? `<div class="code-category">${code.category}</div>` : ''}
            </div>
          </div>
          <div class="code-actions">
            <button class="btn btn-sm btn-ghost" onclick="editCode('${code.id}')">Edit</button>
          </div>
        </div>
      `).join('');
    }

    function renderTradeMappings() {
      const container = document.getElementById('tradesList');

      if (tradeMappings.length === 0) {
        container.innerHTML = '<div class="empty-state">No trade mappings defined</div>';
        return;
      }

      container.innerHTML = tradeMappings.map(m => `
        <div class="mapping-item">
          <span class="trade-badge">${m.trade_type}</span>
          <span class="mapping-arrow">‚Üí</span>
          <div class="code-info">
            <span class="code-badge">${m.cost_code?.code || '?'}</span>
            <span class="code-name">${m.cost_code?.name || 'Unknown'}</span>
          </div>
          <button class="btn btn-sm btn-ghost" onclick="deleteTradeMapping('${m.id}')" title="Remove">√ó</button>
        </div>
      `).join('');
    }

    function updateStats() {
      document.getElementById('totalCodes').textContent = costCodes.length;

      // Count unique categories
      const categories = new Set(costCodes.map(c => c.category).filter(Boolean));
      document.getElementById('totalCategories').textContent = categories.size;

      // Count AI learned mappings
      document.getElementById('totalMappings').textContent = tradeMappings.length;
    }

    // Filter cost codes by search
    function filterCostCodes() {
      const query = document.getElementById('codeSearch').value.toLowerCase().trim();
      const container = document.getElementById('codesList');

      const filtered = query
        ? costCodes.filter(c =>
            c.code.toLowerCase().includes(query) ||
            c.name.toLowerCase().includes(query) ||
            (c.category && c.category.toLowerCase().includes(query))
          )
        : costCodes;

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No matching cost codes</div>';
        return;
      }

      container.innerHTML = filtered.map(code => `
        <div class="code-item">
          <div class="code-info">
            <span class="code-badge">${code.code}</span>
            <div>
              <div class="code-name">${code.name}</div>
              ${code.category ? `<div class="code-category">${code.category}</div>` : ''}
            </div>
          </div>
          <div class="code-actions">
            <button class="btn btn-sm btn-ghost" onclick="editCode('${code.id}')">Edit</button>
          </div>
        </div>
      `).join('');
    }

    // Add Code Modal
    function showAddCodeModal() {
      document.getElementById('newCodeCode').value = '';
      document.getElementById('newCodeName').value = '';
      document.getElementById('newCodeCategory').value = '';
      showModal('addCodeModal');
    }

    function closeAddCodeModal() {
      hideModal('addCodeModal');
    }

    async function saveNewCode() {
      const code = document.getElementById('newCodeCode').value.trim();
      const name = document.getElementById('newCodeName').value.trim();
      const category = document.getElementById('newCodeCategory').value.trim();

      if (!code || !name) {
        showToast('Code and name are required', 'error');
        return;
      }

      try {
        const res = await fetch('/api/cost-codes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, name, category })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to add');
        }

        showToast('Cost code added', 'success');
        closeAddCodeModal();
        await loadCostCodes();
        updateStats();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // Edit Code Modal
    function editCode(id) {
      const code = costCodes.find(c => c.id === id);
      if (!code) return;

      document.getElementById('editCodeId').value = id;
      document.getElementById('editCodeCode').value = code.code;
      document.getElementById('editCodeName').value = code.name;
      document.getElementById('editCodeCategory').value = code.category || '';
      showModal('editCodeModal');
    }

    function closeEditCodeModal() {
      hideModal('editCodeModal');
    }

    async function saveEditCode() {
      const id = document.getElementById('editCodeId').value;
      const code = document.getElementById('editCodeCode').value.trim();
      const name = document.getElementById('editCodeName').value.trim();
      const category = document.getElementById('editCodeCategory').value.trim();

      if (!code || !name) {
        showToast('Code and name are required', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/cost-codes/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, name, category })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to update');
        }

        showToast('Cost code updated', 'success');
        closeEditCodeModal();
        await loadCostCodes();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function deleteCode() {
      const id = document.getElementById('editCodeId').value;
      if (!confirm('Delete this cost code? This may affect existing allocations.')) return;

      try {
        const res = await fetch(`/api/cost-codes/${id}`, { method: 'DELETE' });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to delete');
        }

        showToast('Cost code deleted', 'success');
        closeEditCodeModal();
        await Promise.all([loadCostCodes(), loadTradeMappings()]);
        updateStats();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // Add Trade Mapping Modal
    function showAddTradeModal() {
      document.getElementById('newTradeType').value = '';

      // Populate cost code dropdown
      const select = document.getElementById('newTradeCostCode');
      select.innerHTML = '<option value="">Select cost code...</option>' +
        costCodes.map(c => `<option value="${c.id}">${c.code} - ${c.name}</option>`).join('');

      showModal('addTradeModal');
    }

    function closeAddTradeModal() {
      hideModal('addTradeModal');
    }

    async function saveNewTradeMapping() {
      const tradeType = document.getElementById('newTradeType').value.trim().toLowerCase();
      const costCodeId = document.getElementById('newTradeCostCode').value;

      if (!tradeType || !costCodeId) {
        showToast('Trade type and cost code are required', 'error');
        return;
      }

      try {
        const res = await fetch('/api/cost-codes/trade-mappings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trade_type: tradeType, cost_code_id: costCodeId })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to add');
        }

        showToast('Trade mapping added', 'success');
        closeAddTradeModal();
        await loadTradeMappings();
        updateStats();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function deleteTradeMapping(id) {
      if (!confirm('Remove this trade mapping?')) return;

      try {
        const res = await fetch(`/api/cost-codes/trade-mappings/${id}`, { method: 'DELETE' });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to delete');
        }

        showToast('Trade mapping removed', 'success');
        await loadTradeMappings();
        updateStats();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }
  </script>
</body>
</html>
