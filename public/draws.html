<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Draws</title>
  <link rel="stylesheet" href="css/styles.css?v=20260109v">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1>Draws</h1>
        <nav class="header-nav">
          <a href="index.html" class="nav-link">Invoices</a>
          <a href="pos.html" class="nav-link">Purchase Orders</a>
          <a href="draws.html" class="nav-link">Draws</a>
          <a href="budgets.html" class="nav-link">Budgets</a>
        </nav>
      </div>
      <button class="btn btn-primary" onclick="showCreateDrawModal()">+ New Draw</button>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Filters -->
      <div class="table-toolbar">
        <div class="filter-controls">
          <select id="statusFilter" class="form-control filter-select">
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="submitted">Submitted</option>
            <option value="funded">Funded</option>
          </select>
          <select id="jobFilter" class="form-control filter-select">
            <option value="">All Jobs</option>
          </select>
        </div>
      </div>

      <!-- Draw List -->
      <div class="draw-list" id="drawList">
        <div class="loading">Loading draws...</div>
      </div>
    </main>
  </div>

  <!-- Draw Detail Modal (Fullscreen - Single Page Layout) -->
  <div id="drawModal" class="modal modal-fullscreen-dark">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-group">
          <h2 id="drawModalTitle">Draw #1</h2>
          <span class="status-badge" id="drawModalStatus">Draft</span>
          <span class="lock-indicator" id="lockIndicator" style="display: none;" title="This draw is locked">üîí</span>
        </div>
        <div class="modal-header-actions">
          <button class="btn btn-secondary" onclick="exportExcel()" title="Export Excel">
            Export Excel
          </button>
          <button class="btn btn-secondary" onclick="exportPDF()" title="Export PDF">
            Export PDF
          </button>
          <button class="btn btn-secondary" onclick="window.print()" title="Print">
            Print
          </button>
          <button class="close-btn" onclick="closeDrawModal()">&times;</button>
        </div>
      </div>

      <div class="modal-body draw-modal-body draw-single-page">
        <!-- Summary Header -->
        <section class="draw-section draw-summary-section">
          <div class="draw-summary-grid">
            <div class="summary-card">
              <div class="summary-label">Job</div>
              <div class="summary-value" id="summaryJob">-</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Application #</div>
              <div class="summary-value" id="summaryAppNum">-</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Period To</div>
              <div class="summary-value" id="summaryPeriod">-</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Invoice Count</div>
              <div class="summary-value" id="summaryInvCount">0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">This Period</div>
              <div class="summary-value" id="summaryThisPeriod">$0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">Current Payment Due</div>
              <div class="summary-value" id="summaryPaymentDue">$0</div>
            </div>
            <div class="summary-card funding-info" id="fundingInfoCard" style="display: none;">
              <div class="summary-label">Funded Amount</div>
              <div class="summary-value" id="summaryFundedAmount">$0</div>
              <div class="funding-note" id="summaryFundingNote"></div>
            </div>
          </div>
        </section>

        <!-- G702 Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>G702 - Application and Certificate for Payment</h3>
          </div>
          <div class="g702-container">
            <div class="g702-form">
              <div class="g702-section">
                <div class="g702-row">
                  <div class="g702-field">
                    <label>TO OWNER:</label>
                    <div class="g702-value" id="g702Owner">-</div>
                  </div>
                  <div class="g702-field">
                    <label>APPLICATION NO:</label>
                    <div class="g702-value" id="g702AppNo">-</div>
                  </div>
                </div>
                <div class="g702-row">
                  <div class="g702-field">
                    <label>PROJECT:</label>
                    <div class="g702-value" id="g702Project">-</div>
                  </div>
                  <div class="g702-field">
                    <label>PERIOD TO:</label>
                    <div class="g702-value" id="g702PeriodTo">-</div>
                  </div>
                </div>
                <div class="g702-row">
                  <div class="g702-field">
                    <label>FROM CONTRACTOR:</label>
                    <div class="g702-value">Ross Built Custom Homes</div>
                  </div>
                </div>
              </div>

              <table class="g702-table">
                <tbody>
                  <tr>
                    <td class="g702-line-num">1.</td>
                    <td>ORIGINAL CONTRACT SUM</td>
                    <td class="g702-amount" id="g702Line1">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">2.</td>
                    <td>Net change by Change Orders</td>
                    <td class="g702-amount" id="g702Line2">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">3.</td>
                    <td>CONTRACT SUM TO DATE (Line 1 + 2)</td>
                    <td class="g702-amount" id="g702Line3">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">4.</td>
                    <td>TOTAL COMPLETED & STORED TO DATE</td>
                    <td class="g702-amount" id="g702Line4">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">5.</td>
                    <td>LESS PREVIOUS CERTIFICATES FOR PAYMENT</td>
                    <td class="g702-amount" id="g702Line5">$0.00</td>
                  </tr>
                  <tr class="g702-highlight">
                    <td class="g702-line-num">6.</td>
                    <td><strong>CURRENT PAYMENT DUE</strong> (Line 4 less Line 5)</td>
                    <td class="g702-amount" id="g702Line6">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">7.</td>
                    <td>BALANCE TO FINISH (Line 3 less Line 4)</td>
                    <td class="g702-amount" id="g702Line7">$0.00</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- PCCO (Potential Change Orders) Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>PCCO - Change Orders</h3>
            <span class="section-badge" id="pccoCount">0 Change Orders</span>
          </div>
          <div class="pcco-container">
            <table class="pcco-table">
              <thead>
                <tr>
                  <th>CO #</th>
                  <th>Description</th>
                  <th>Reason</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="pccoBody">
                <tr>
                  <td colspan="6" class="empty-state">No change orders for this project</td>
                </tr>
              </tbody>
              <tfoot id="pccoFooter">
              </tfoot>
            </table>
          </div>
        </section>

        <!-- G703 Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>G703 - Schedule of Values</h3>
            <span class="section-subtitle">Budget vs Billings by Cost Code</span>
          </div>
          <div class="g703-container">
            <div class="g703-table-wrapper">
              <table class="g703-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Cost Code</th>
                    <th>Scheduled Value</th>
                    <th>Previous<br>Applications</th>
                    <th>This<br>Application</th>
                    <th>Total<br>Completed</th>
                    <th>%</th>
                    <th>Balance<br>to Finish</th>
                  </tr>
                </thead>
                <tbody id="g703Body">
                  <tr>
                    <td colspan="8" class="loading">Loading schedule of values...</td>
                  </tr>
                </tbody>
                <tfoot id="g703Footer">
                </tfoot>
              </table>
            </div>
          </div>
        </section>

        <!-- Change Order Billing Section -->
        <section class="draw-section" id="coBillingSection">
          <div class="section-header">
            <h3>Change Order Billings</h3>
            <button class="btn btn-primary btn-sm" id="addCOBillingBtn" onclick="showAddCOBillingModal()">+ Add CO Billing</button>
          </div>
          <div class="co-billing-container">
            <table class="g703-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Change Order</th>
                  <th>CO Amount</th>
                  <th>Previous<br>Billings</th>
                  <th>This<br>Application</th>
                  <th>Total<br>Billed</th>
                  <th>%</th>
                  <th>Balance</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="coBillingBody">
                <tr>
                  <td colspan="9" class="empty-state">No change order billings in this draw</td>
                </tr>
              </tbody>
              <tfoot id="coBillingFooter">
              </tfoot>
            </table>
          </div>
        </section>

        <!-- Invoices Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Invoices in this Draw</h3>
            <span class="section-hint" id="invoicesSectionHint">Invoices are automatically added when approved</span>
          </div>
          <div class="invoices-container">
            <table class="invoices-table">
              <thead>
                <tr>
                  <th>Vendor</th>
                  <th>Invoice #</th>
                  <th>Date</th>
                  <th>Cost Codes</th>
                  <th>Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoicesBody">
                <tr>
                  <td colspan="6" class="loading">Loading invoices...</td>
                </tr>
              </tbody>
              <tfoot id="invoicesFooter">
              </tfoot>
            </table>
          </div>
        </section>

        <!-- Attachments Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Attachments</h3>
            <button class="btn btn-primary btn-sm" id="addAttachmentBtn" onclick="showAddAttachmentModal()">+ Add Attachment</button>
          </div>
          <div class="attachments-container">
            <table class="attachments-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Vendor</th>
                  <th>File</th>
                  <th>Uploaded</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="attachmentsBody">
                <tr>
                  <td colspan="5" class="empty-state">No attachments yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Activity Log Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Activity Log</h3>
          </div>
          <div class="activity-container" id="activityContainer">
            <div class="empty-state">No activity recorded</div>
          </div>
        </section>
      </div>

      <div class="modal-footer" id="drawModalFooter">
        <button class="btn btn-secondary" onclick="closeDrawModal()">Close</button>
        <button class="btn btn-outline-warning" id="unsubmitDrawBtn" onclick="unsubmitDraw()" style="display:none;">Unsubmit</button>
        <button class="btn btn-warning" id="submitDrawBtn" onclick="submitDraw()">Submit Draw</button>
        <button class="btn btn-success" id="fundDrawBtn" onclick="fundDraw()" style="display:none;">Mark as Funded</button>
      </div>
    </div>
  </div>

  <!-- Create Draw Modal -->
  <div id="createDrawModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Create New Draw</h2>
        <button class="close-btn" onclick="closeModal('createDrawModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Job *</label>
          <select id="newDrawJob" class="form-control" required>
            <option value="">Select a job...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Period End Date</label>
          <input type="date" id="newDrawPeriodEnd" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('createDrawModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createDraw()">Create Draw</button>
      </div>
    </div>
  </div>

  <!-- Add CO Billing Modal -->
  <div id="addCOBillingModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Add Change Order Billings</h2>
        <button class="close-btn" onclick="closeModal('addCOBillingModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-description">Select change orders to bill on this draw. Enter the amount to bill for each.</p>
        <div id="availableCOsList" class="co-billing-list">
          <!-- Dynamic content populated by showAddCOBillingModal -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addCOBillingModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCOBillings()">Add to Draw</button>
      </div>
    </div>
  </div>

  <!-- Fund Draw Modal -->
  <div id="fundDrawModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Mark Draw as Funded</h2>
        <button class="close-btn" onclick="closeModal('fundDrawModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="funding-summary" id="fundingSummary">
          <!-- Populated dynamically -->
        </div>

        <div class="form-group">
          <label>Amount Funded *</label>
          <div class="input-with-prefix">
            <span class="input-prefix">$</span>
            <input type="text" id="fundedAmount" class="form-control" placeholder="0.00"
              oninput="updateFundingDifference()">
          </div>
          <div class="field-hint" id="fundingDifferenceHint"></div>
        </div>

        <div class="form-group" id="partialNoteGroup" style="display: none;">
          <label>Note (required for partial funding)</label>
          <textarea id="partialFundingNote" class="form-control" rows="2"
            placeholder="Explain why the funding differs from the billed amount..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('fundDrawModal')">Cancel</button>
        <button class="btn btn-success" id="confirmFundBtn" onclick="confirmFundDraw()">Confirm Funding</button>
      </div>
    </div>
  </div>

  <!-- Add Attachment Modal -->
  <div id="addAttachmentModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Add Attachment</h2>
        <button class="close-btn" onclick="closeModal('addAttachmentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Attachment Type *</label>
          <select id="attachmentType" class="form-control">
            <option value="lien_release">Lien Release</option>
            <option value="affidavit">Affidavit</option>
            <option value="insurance_cert">Insurance Certificate</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Vendor (optional)</label>
          <select id="attachmentVendor" class="form-control">
            <option value="">-- No specific vendor --</option>
          </select>
        </div>
        <div class="form-group">
          <label>File URL *</label>
          <input type="text" id="attachmentUrl" class="form-control" placeholder="https://...">
          <div class="field-hint">Enter the URL of the uploaded file</div>
        </div>
        <div class="form-group">
          <label>File Name *</label>
          <input type="text" id="attachmentFileName" class="form-control" placeholder="lien_release.pdf">
        </div>
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea id="attachmentNotes" class="form-control" rows="2" placeholder="Any notes about this attachment..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addAttachmentModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveAttachment()">Add Attachment</button>
      </div>
    </div>
  </div>

  <!-- Unsubmit Reason Modal -->
  <div id="unsubmitModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Unsubmit Draw</h2>
        <button class="close-btn" onclick="closeModal('unsubmitModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>This will return the draw to draft status, allowing changes to be made.</p>
        <div class="form-group">
          <label>Reason (optional)</label>
          <textarea id="unsubmitReason" class="form-control" rows="3" placeholder="Why is this draw being unsubmitted?"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('unsubmitModal')">Cancel</button>
        <button class="btn btn-warning" onclick="confirmUnsubmit()">Unsubmit Draw</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="js/toasts.js"></script>
  <script>
    // ============================================================
    // DRAWS PAGE - Single Page Layout
    // ============================================================

    let state = {
      draws: [],
      jobs: [],
      currentFilter: 'all',
      currentJobFilter: ''
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadJobs();
      loadDraws();
      setupFilters();
    });

    async function loadJobs() {
      try {
        const res = await fetch('/api/jobs');
        state.jobs = await res.json();

        const select = document.getElementById('jobFilter');
        select.innerHTML = '<option value="">All Jobs</option>';
        state.jobs.forEach(job => {
          select.innerHTML += `<option value="${job.id}">${job.name}</option>`;
        });

        select.addEventListener('change', (e) => {
          state.currentJobFilter = e.target.value;
          renderDrawList();
        });
      } catch (err) {
        console.error('Failed to load jobs:', err);
      }
    }

    async function loadDraws() {
      try {
        const jobsRes = await fetch('/api/jobs');
        const jobs = await jobsRes.json();

        let allDraws = [];
        for (const job of jobs) {
          const res = await fetch(`/api/jobs/${job.id}/draws`);
          const draws = await res.json();
          draws.forEach(d => d.job = job);
          allDraws = allDraws.concat(draws);
        }

        state.draws = allDraws.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        renderDrawList();
      } catch (err) {
        console.error('Failed to load draws:', err);
        document.getElementById('drawList').innerHTML = '<div class="empty-state">Failed to load draws</div>';
      }
    }

    function setupFilters() {
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', (e) => {
          state.currentFilter = e.target.value || 'all';
          renderDrawList();
        });
      }
    }

    function renderDrawList() {
      const container = document.getElementById('drawList');

      let filtered = state.draws;

      if (state.currentFilter !== 'all') {
        filtered = filtered.filter(d => d.status === state.currentFilter);
      }

      if (state.currentJobFilter) {
        filtered = filtered.filter(d => d.job_id === state.currentJobFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No draws found</div>';
        return;
      }

      container.innerHTML = `
        <div class="draw-list-header">
          <div>Draw #</div>
          <div>Job</div>
          <div>Period End</div>
          <div>Status</div>
          <div>Amount</div>
          <div>Invoices</div>
        </div>
        ${filtered.map(draw => renderDrawRow(draw)).join('')}
      `;
    }

    function renderDrawRow(draw) {
      // Only 3 statuses: draft, submitted, funded
      const statusClass = {
        draft: 'pending',
        submitted: 'pending-approval',
        funded: 'approved'
      }[draw.status] || 'pending';

      const statusLabel = {
        draft: 'Draft',
        submitted: 'Submitted',
        funded: 'Funded'
      }[draw.status] || draw.status;

      // Funding variance indicator (shown next to status for funded draws)
      let fundingVariance = '';
      if (draw.status === 'funded' && draw.funding_difference) {
        const diff = parseFloat(draw.funding_difference);
        if (diff < -0.01) {
          fundingVariance = `<span class="funding-variance text-warning">-${formatMoney(Math.abs(diff))}</span>`;
        } else if (diff > 0.01) {
          fundingVariance = `<span class="funding-variance text-info">+${formatMoney(diff)}</span>`;
        }
      }

      // Count invoices from the nested data
      const invoiceCount = draw.invoices?.length || draw.invoice_count || 0;

      return `
        <div class="draw-row" onclick="openDraw('${draw.id}', '${draw.job_id}')">
          <div class="draw-number">Draw #${draw.draw_number}</div>
          <div class="draw-job">${draw.job?.name || 'Unknown'}</div>
          <div class="draw-date">${draw.period_end ? formatDate(draw.period_end) : '-'}</div>
          <div><span class="status-badge status-${statusClass}">${statusLabel}</span>${fundingVariance}</div>
          <div class="draw-amount">${formatMoney(draw.total_amount)}</div>
          <div class="draw-invoices">${invoiceCount}</div>
        </div>
      `;
    }

    let currentDraw = null;
    window.currentDraw = null;

    async function openDraw(drawId) {
      console.log('openDraw called with drawId:', drawId);
      try {
        const url = `/api/draws/${drawId}`;
        const res = await fetch(url);

        if (!res.ok) {
          const errorText = await res.text();
          console.error('API Error:', errorText);
          throw new Error(`Failed to fetch draw: ${res.status}`);
        }

        currentDraw = await res.json();
        window.currentDraw = currentDraw;

        renderDrawModal(currentDraw);
        document.getElementById('drawModal').style.display = 'flex';
      } catch (err) {
        console.error('Error opening draw:', err);
        showToast('Failed to load draw', 'error');
      }
    }

    function closeDrawModal() {
      document.getElementById('drawModal').style.display = 'none';
      currentDraw = null;
    }

    function renderDrawModal(draw) {
      // Modal header
      document.getElementById('drawModalTitle').textContent = `Draw #${draw.draw_number} - ${draw.job?.name || 'Unknown Job'}`;

      // Status badge - only 3 statuses: draft, submitted, funded
      const statusBadge = document.getElementById('drawModalStatus');
      const statusClass = { draft: 'pending', submitted: 'pending-approval', funded: 'approved' }[draw.status] || 'pending';
      const statusLabel = { draft: 'Draft', submitted: 'Submitted', funded: 'Funded' }[draw.status] || draw.status;
      statusBadge.className = `status-badge status-${statusClass}`;
      statusBadge.textContent = statusLabel;

      // Summary section
      document.getElementById('summaryJob').textContent = draw.job?.name || '-';
      document.getElementById('summaryAppNum').textContent = draw.draw_number;
      document.getElementById('summaryPeriod').textContent = draw.period_end ? formatDate(draw.period_end) : '-';
      document.getElementById('summaryInvCount').textContent = draw.invoiceCount || 0;
      document.getElementById('summaryThisPeriod').textContent = formatMoney(draw.g702?.totalCompletedThisPeriod || 0);
      document.getElementById('summaryPaymentDue').textContent = formatMoney(draw.g702?.currentPaymentDue || 0);

      // Funding info (for funded draws)
      const fundingInfoCard = document.getElementById('fundingInfoCard');
      if (draw.status === 'funded') {
        fundingInfoCard.style.display = 'block';
        const fundedAmount = parseFloat(draw.funded_amount || 0);
        const billedAmount = parseFloat(draw.total_amount || 0);
        const diff = parseFloat(draw.funding_difference || 0);

        document.getElementById('summaryFundedAmount').textContent = formatMoney(fundedAmount);

        const noteEl = document.getElementById('summaryFundingNote');
        if (diff < -0.01) {
          // Partial payment - client paid less
          noteEl.innerHTML = `<span class="text-warning">Short ${formatMoney(Math.abs(diff))}</span>`;
          if (draw.partial_funding_note) {
            noteEl.innerHTML += `<br><small>${draw.partial_funding_note}</small>`;
          }
        } else if (diff > 0.01) {
          // Overpayment - client paid more (credit)
          noteEl.innerHTML = `<span class="text-info">Credit ${formatMoney(diff)}</span>`;
          if (draw.partial_funding_note) {
            noteEl.innerHTML += `<br><small>${draw.partial_funding_note}</small>`;
          }
        } else {
          noteEl.textContent = 'Paid in full';
        }
      } else {
        fundingInfoCard.style.display = 'none';
      }

      // G702 section
      document.getElementById('g702Owner').textContent = draw.job?.client_name || '-';
      document.getElementById('g702AppNo').textContent = draw.draw_number;
      document.getElementById('g702Project').textContent = draw.job?.name || '-';
      document.getElementById('g702PeriodTo').textContent = draw.period_end ? formatDate(draw.period_end) : '-';

      const contractSum = parseFloat(draw.job?.contract_amount) || 0;
      const changeOrders = draw.changeOrderTotal || 0;
      const contractSumToDate = contractSum + changeOrders;
      const totalCompleted = draw.g702?.grandTotal || 0;
      const previousCertificates = draw.g702?.lessPreviousCertificates || 0;
      const currentPaymentDue = draw.g702?.currentPaymentDue || 0;
      const balanceToFinish = contractSumToDate - totalCompleted;

      document.getElementById('g702Line1').textContent = formatMoneyDecimal(contractSum);
      document.getElementById('g702Line2').textContent = formatMoneyDecimal(changeOrders);
      document.getElementById('g702Line3').textContent = formatMoneyDecimal(contractSumToDate);
      document.getElementById('g702Line4').textContent = formatMoneyDecimal(totalCompleted);
      document.getElementById('g702Line5').textContent = formatMoneyDecimal(previousCertificates);
      document.getElementById('g702Line6').textContent = formatMoneyDecimal(currentPaymentDue);
      document.getElementById('g702Line7').textContent = formatMoneyDecimal(balanceToFinish);

      // PCCO section
      renderPCCOTable(draw.changeOrders || []);

      // G703 section
      renderG703Table(draw.scheduleOfValues || []);

      // CO Billing section
      renderCOBillingTable(draw.coScheduleOfValues || [], draw.status);

      // Invoices section
      renderInvoicesTable(draw.invoices || [], draw.status);

      // Attachments section
      renderAttachmentsTable(draw.attachments || [], draw.status);

      // Activity log section
      renderActivityLog(draw.activity || []);

      // Lock indicator
      const lockIndicator = document.getElementById('lockIndicator');
      const isLocked = draw.status !== 'draft';
      lockIndicator.style.display = isLocked ? 'inline' : 'none';

      // Action buttons based on status
      const submitBtn = document.getElementById('submitDrawBtn');
      const fundBtn = document.getElementById('fundDrawBtn');
      const unsubmitBtn = document.getElementById('unsubmitDrawBtn');
      const addCOBillingBtn = document.getElementById('addCOBillingBtn');
      const addAttachmentBtn = document.getElementById('addAttachmentBtn');
      const isFunded = ['funded', 'partially_funded', 'overfunded'].includes(draw.status);

      if (draw.status === 'draft') {
        submitBtn.style.display = 'inline-block';
        fundBtn.style.display = 'none';
        unsubmitBtn.style.display = 'none';
        addCOBillingBtn.style.display = 'inline-block';
        addAttachmentBtn.style.display = 'inline-block';
      } else if (draw.status === 'submitted') {
        submitBtn.style.display = 'none';
        fundBtn.style.display = 'inline-block';
        unsubmitBtn.style.display = 'inline-block';
        addCOBillingBtn.style.display = 'none';
        addAttachmentBtn.style.display = 'inline-block'; // Can still add attachments when submitted
      } else {
        // Funded draws - fully immutable
        submitBtn.style.display = 'none';
        fundBtn.style.display = 'none';
        unsubmitBtn.style.display = 'none';
        addCOBillingBtn.style.display = 'none';
        addAttachmentBtn.style.display = 'none';
      }
    }

    function renderPCCOTable(changeOrders) {
      const tbody = document.getElementById('pccoBody');
      const tfoot = document.getElementById('pccoFooter');
      const countBadge = document.getElementById('pccoCount');

      countBadge.textContent = `${changeOrders.length} Change Order${changeOrders.length !== 1 ? 's' : ''}`;

      if (!changeOrders || changeOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No change orders for this project</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      tbody.innerHTML = changeOrders.map(co => {
        const statusClass = {
          draft: 'pending',
          pending_approval: 'pending-approval',
          approved: 'approved',
          rejected: 'denied'
        }[co.status] || 'pending';

        const reasonLabel = {
          scope_change: 'Scope Change',
          owner_request: 'Owner Request',
          unforeseen_conditions: 'Unforeseen Conditions',
          design_change: 'Design Change',
          other: 'Other'
        }[co.reason] || co.reason || '-';

        const amount = co.amount !== undefined ? co.amount : co.amount_change;
        const desc = co.title || co.description || '-';
        const clientApproved = co.client_approved_at || co.client_approval_bypassed;

        return `
          <tr>
            <td>CO-${co.change_order_number}</td>
            <td>${desc}</td>
            <td>${reasonLabel}</td>
            <td class="amount ${amount < 0 ? 'negative' : ''}">${formatMoneyDecimal(amount)}</td>
            <td>
              <span class="status-badge status-${statusClass}">${co.status}</span>
              ${co.status === 'approved' && clientApproved ? '<span class="client-approved-badge">Client OK</span>' : ''}
            </td>
            <td>${co.created_at ? formatDate(co.created_at) : '-'}</td>
          </tr>
        `;
      }).join('');

      const totalChange = changeOrders
        .filter(co => co.status === 'approved')
        .reduce((sum, co) => sum + parseFloat(co.amount || co.amount_change || 0), 0);

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="3"><strong>Total Approved Change Orders</strong></td>
          <td class="amount ${totalChange < 0 ? 'negative' : ''}"><strong>${formatMoneyDecimal(totalChange)}</strong></td>
          <td colspan="2"></td>
        </tr>
      `;
    }

    function renderG703Table(scheduleOfValues) {
      const tbody = document.getElementById('g703Body');
      const tfoot = document.getElementById('g703Footer');

      if (!scheduleOfValues || scheduleOfValues.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No billing data for this draw</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      tbody.innerHTML = scheduleOfValues.map(item => {
        const budget = item.budget || item.scheduledValue || 0;
        const previous = item.previousBilled || item.previousCompleted || 0;
        const current = item.currentBilled || item.thisPeriod || 0;
        const total = item.totalBilled || item.totalCompleted || 0;
        const balance = item.balance || 0;
        const balanceClass = balance < 0 ? 'over-budget' : '';

        return `
          <tr>
            <td>${item.item}</td>
            <td>${item.costCode} - ${item.description}</td>
            <td class="amount">${budget > 0 ? formatMoneyDecimal(budget) : '<span class="no-budget">No Budget</span>'}</td>
            <td class="amount">${formatMoneyDecimal(previous)}</td>
            <td class="amount highlight-current">${formatMoneyDecimal(current)}</td>
            <td class="amount">${formatMoneyDecimal(total)}</td>
            <td class="percent">${item.percentComplete.toFixed(1)}%</td>
            <td class="amount ${balanceClass}">${formatMoneyDecimal(balance)}</td>
          </tr>
        `;
      }).join('');

      // Totals row
      const totals = scheduleOfValues.reduce((acc, item) => ({
        budget: acc.budget + (item.budget || item.scheduledValue || 0),
        previous: acc.previous + (item.previousBilled || item.previousCompleted || 0),
        current: acc.current + (item.currentBilled || item.thisPeriod || 0),
        total: acc.total + (item.totalBilled || item.totalCompleted || 0),
        balance: acc.balance + (item.balance || 0)
      }), { budget: 0, previous: 0, current: 0, total: 0, balance: 0 });

      const overallPercent = totals.budget > 0 ? (totals.total / totals.budget) * 100 : (totals.total > 0 ? 100 : 0);

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td></td>
          <td><strong>GRAND TOTAL</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.budget)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.previous)}</strong></td>
          <td class="amount highlight-current"><strong>${formatMoneyDecimal(totals.current)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.total)}</strong></td>
          <td class="percent"><strong>${overallPercent.toFixed(1)}%</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.balance)}</strong></td>
        </tr>
      `;
    }

    function renderCOBillingTable(coScheduleOfValues, drawStatus) {
      const tbody = document.getElementById('coBillingBody');
      const tfoot = document.getElementById('coBillingFooter');
      const section = document.getElementById('coBillingSection');

      if (!coScheduleOfValues || coScheduleOfValues.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No change order billings in this draw</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      const isDraft = drawStatus === 'draft';

      tbody.innerHTML = coScheduleOfValues.map((item, idx) => {
        const coAmount = parseFloat(item.coAmount) || 0;
        const previous = parseFloat(item.previousBilled) || 0;
        const current = parseFloat(item.thisPeriod) || 0;
        const total = parseFloat(item.totalBilled) || 0;
        const balance = coAmount - total;
        const percent = coAmount > 0 ? (total / coAmount) * 100 : 0;

        return `
          <tr>
            <td>${idx + 1}</td>
            <td>
              <strong>CO-${String(item.changeOrderNumber).padStart(3, '0')}</strong>
              <br><span class="text-muted">${item.title || ''}</span>
            </td>
            <td class="amount">${formatMoneyDecimal(coAmount)}</td>
            <td class="amount">${formatMoneyDecimal(previous)}</td>
            <td class="amount highlight-current">${formatMoneyDecimal(current)}</td>
            <td class="amount">${formatMoneyDecimal(total)}</td>
            <td class="percent">${percent.toFixed(1)}%</td>
            <td class="amount">${formatMoneyDecimal(balance)}</td>
            <td>
              ${isDraft && current > 0 ? `
                <button class="btn btn-sm btn-danger" onclick="removeCOBilling('${item.changeOrderId}')" title="Remove from draw">
                  <i class="fas fa-times"></i>
                </button>
              ` : '-'}
            </td>
          </tr>
        `;
      }).join('');

      // Totals row
      const totals = coScheduleOfValues.reduce((acc, item) => ({
        coAmount: acc.coAmount + (parseFloat(item.coAmount) || 0),
        previous: acc.previous + (parseFloat(item.previousBilled) || 0),
        current: acc.current + (parseFloat(item.thisPeriod) || 0),
        total: acc.total + (parseFloat(item.totalBilled) || 0)
      }), { coAmount: 0, previous: 0, current: 0, total: 0 });

      const overallPercent = totals.coAmount > 0 ? (totals.total / totals.coAmount) * 100 : 0;
      const totalBalance = totals.coAmount - totals.total;

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td></td>
          <td><strong>CO TOTALS</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.coAmount)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.previous)}</strong></td>
          <td class="amount highlight-current"><strong>${formatMoneyDecimal(totals.current)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.total)}</strong></td>
          <td class="percent"><strong>${overallPercent.toFixed(1)}%</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totalBalance)}</strong></td>
          <td></td>
        </tr>
      `;
    }

    function renderInvoicesTable(invoices, drawStatus) {
      const tbody = document.getElementById('invoicesBody');
      const tfoot = document.getElementById('invoicesFooter');
      const isDraft = drawStatus === 'draft';

      if (!invoices || invoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No invoices in this draw yet. Approve invoices to add them automatically.</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      // Helper to get billable amount (allocation sum or invoice amount)
      function getBillableAmount(inv) {
        const allocationSum = (inv.allocations || []).reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
        return allocationSum > 0 ? allocationSum : parseFloat(inv.amount || 0);
      }

      tbody.innerHTML = invoices.map(inv => {
        // Get cost codes from allocations
        const costCodes = inv.allocations?.map(a => a.cost_code?.code).filter(Boolean).join(', ') || '-';
        const billableAmount = getBillableAmount(inv);
        const isPartial = billableAmount < parseFloat(inv.amount || 0);

        return `
          <tr>
            <td>${inv.vendor?.name || 'Unknown'}</td>
            <td>${inv.invoice_number || '-'}${isPartial ? ' <span class="partial-badge">Partial</span>' : ''}</td>
            <td>${inv.invoice_date ? formatDate(inv.invoice_date) : '-'}</td>
            <td class="cost-codes">${costCodes}</td>
            <td class="amount">${formatMoney(billableAmount)}${isPartial ? `<br><small class="text-muted">of ${formatMoney(inv.amount)}</small>` : ''}</td>
            <td>
              ${isDraft ? `
                <button class="btn btn-sm btn-danger" onclick="removeInvoice('${inv.id}')">Remove</button>
              ` : ''}
              ${inv.pdf_stamped_url ? `
                <a href="${inv.pdf_stamped_url}" target="_blank" class="btn btn-sm btn-secondary">PDF</a>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');

      // Total row - use billable amounts (allocation sums)
      const totalAmount = invoices.reduce((sum, inv) => {
        const allocationSum = (inv.allocations || []).reduce((s, a) => s + parseFloat(a.amount || 0), 0);
        return sum + (allocationSum > 0 ? allocationSum : parseFloat(inv.amount || 0));
      }, 0);
      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="4"><strong>Total (${invoices.length} invoice${invoices.length !== 1 ? 's' : ''})</strong></td>
          <td class="amount"><strong>${formatMoney(totalAmount)}</strong></td>
          <td></td>
        </tr>
      `;
    }

    function renderAttachmentsTable(attachments, drawStatus) {
      const tbody = document.getElementById('attachmentsBody');
      const canModify = drawStatus === 'draft' || drawStatus === 'submitted';

      const typeLabels = {
        lien_release: 'Lien Release',
        affidavit: 'Affidavit',
        insurance_cert: 'Insurance Cert',
        other: 'Other'
      };

      if (!attachments || attachments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No attachments yet</td></tr>';
        return;
      }

      tbody.innerHTML = attachments.map(att => `
        <tr>
          <td><span class="type-badge type-${att.attachment_type}">${typeLabels[att.attachment_type] || att.attachment_type}</span></td>
          <td>${att.vendor?.name || '-'}</td>
          <td><a href="${att.file_url}" target="_blank">${att.file_name}</a></td>
          <td>${att.uploaded_at ? formatDate(att.uploaded_at) : '-'}</td>
          <td>
            <a href="${att.file_url}" target="_blank" class="btn btn-sm btn-secondary">View</a>
            ${canModify ? `<button class="btn btn-sm btn-danger" onclick="deleteAttachment('${att.id}')">Delete</button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    function renderActivityLog(activities) {
      const container = document.getElementById('activityContainer');

      const actionLabels = {
        created: 'Draw created',
        invoice_added: 'Invoice added',
        invoice_removed: 'Invoice removed',
        submitted: 'Draw submitted',
        unsubmitted: 'Draw unsubmitted',
        funded: 'Draw funded',
        attachment_added: 'Attachment added',
        attachment_removed: 'Attachment removed'
      };

      if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="empty-state">No activity recorded</div>';
        return;
      }

      container.innerHTML = `
        <div class="activity-list">
          ${activities.map(act => {
            const details = act.details || {};
            let detailText = '';
            if (act.action === 'invoice_added' || act.action === 'invoice_removed') {
              detailText = details.invoice_number ? ` - ${details.invoice_number}` : '';
            } else if (act.action === 'funded') {
              detailText = details.funded_amount ? ` - ${formatMoney(details.funded_amount)}` : '';
            } else if (act.action === 'unsubmitted' && details.reason) {
              detailText = ` - "${details.reason}"`;
            }
            return `
              <div class="activity-item">
                <span class="activity-time">${formatDateTime(act.created_at)}</span>
                <span class="activity-action">${actionLabels[act.action] || act.action}${detailText}</span>
                <span class="activity-user">${act.performed_by || 'System'}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    // ============================================================
    // UNSUBMIT FUNCTIONALITY
    // ============================================================

    function unsubmitDraw() {
      if (!currentDraw || currentDraw.status !== 'submitted') return;
      document.getElementById('unsubmitReason').value = '';
      openModal('unsubmitModal');
    }

    async function confirmUnsubmit() {
      if (!currentDraw) return;

      const reason = document.getElementById('unsubmitReason').value.trim();

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/unsubmit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to unsubmit draw');
        }

        showToast('Draw returned to draft status', 'success');
        closeModal('unsubmitModal');
        openDraw(currentDraw.id); // Refresh the draw
        loadDraws();
      } catch (err) {
        console.error('Error unsubmitting draw:', err);
        showToast(err.message || 'Failed to unsubmit draw', 'error');
      }
    }

    // ============================================================
    // ATTACHMENT FUNCTIONALITY
    // ============================================================

    async function showAddAttachmentModal() {
      if (!currentDraw) return;

      // Load vendors for the dropdown
      const vendorSelect = document.getElementById('attachmentVendor');
      vendorSelect.innerHTML = '<option value="">-- No specific vendor --</option>';

      try {
        const res = await fetch('/api/vendors');
        if (res.ok) {
          const vendors = await res.json();
          vendors.forEach(v => {
            vendorSelect.innerHTML += `<option value="${v.id}">${v.name}</option>`;
          });
        }
      } catch (err) {
        console.error('Error loading vendors:', err);
      }

      // Clear form
      document.getElementById('attachmentType').value = 'lien_release';
      document.getElementById('attachmentUrl').value = '';
      document.getElementById('attachmentFileName').value = '';
      document.getElementById('attachmentNotes').value = '';

      openModal('addAttachmentModal');
    }

    async function saveAttachment() {
      if (!currentDraw) return;

      const fileUrl = document.getElementById('attachmentUrl').value.trim();
      const fileName = document.getElementById('attachmentFileName').value.trim();

      if (!fileUrl || !fileName) {
        showToast('File URL and File Name are required', 'error');
        return;
      }

      const data = {
        file_url: fileUrl,
        file_name: fileName,
        attachment_type: document.getElementById('attachmentType').value,
        vendor_id: document.getElementById('attachmentVendor').value || null,
        notes: document.getElementById('attachmentNotes').value.trim() || null
      };

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/attachments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to add attachment');
        }

        showToast('Attachment added', 'success');
        closeModal('addAttachmentModal');
        openDraw(currentDraw.id); // Refresh
      } catch (err) {
        console.error('Error adding attachment:', err);
        showToast(err.message || 'Failed to add attachment', 'error');
      }
    }

    async function deleteAttachment(attachmentId) {
      if (!currentDraw) return;
      if (!confirm('Delete this attachment?')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/attachments/${attachmentId}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to delete attachment');
        }

        showToast('Attachment deleted', 'success');
        openDraw(currentDraw.id); // Refresh
      } catch (err) {
        console.error('Error deleting attachment:', err);
        showToast(err.message || 'Failed to delete attachment', 'error');
      }
    }

    async function submitDraw() {
      if (!currentDraw) return;

      if (!confirm('Submit this draw? It will be locked from further changes.')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/submit`, { method: 'PATCH' });
        if (!res.ok) throw new Error('Failed to submit draw');

        showToast('Draw submitted successfully', 'success');
        closeDrawModal();
        loadDraws();
      } catch (err) {
        console.error('Error submitting draw:', err);
        showToast('Failed to submit draw', 'error');
      }
    }

    function fundDraw() {
      if (!currentDraw) return;

      // Populate the fund draw modal
      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const formattedAmount = totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      document.getElementById('fundingSummary').innerHTML = `
        <div class="summary-row">
          <span class="summary-label">Draw Total (Billed):</span>
          <span class="summary-value">$${formattedAmount}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Invoices:</span>
          <span class="summary-value">${currentDraw.invoices?.length || 0}</span>
        </div>
      `;

      document.getElementById('fundedAmount').value = formattedAmount;
      document.getElementById('partialFundingNote').value = '';
      document.getElementById('partialNoteGroup').style.display = 'none';
      document.getElementById('fundingDifferenceHint').textContent = '';
      document.getElementById('fundingDifferenceHint').className = 'field-hint';

      openModal('fundDrawModal');
    }

    function updateFundingDifference() {
      if (!currentDraw) return;

      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const inputVal = document.getElementById('fundedAmount').value.replace(/[^0-9.-]/g, '');
      const fundedAmount = parseFloat(inputVal) || 0;
      const difference = fundedAmount - totalAmount;

      const hintEl = document.getElementById('fundingDifferenceHint');
      const noteGroup = document.getElementById('partialNoteGroup');

      if (Math.abs(difference) < 0.01) {
        hintEl.textContent = 'Full funding - matches billed amount';
        hintEl.className = 'field-hint text-success';
        noteGroup.style.display = 'none';
      } else if (difference < 0) {
        const shortfall = Math.abs(difference).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        hintEl.textContent = `Partial funding - ${shortfall} less than billed`;
        hintEl.className = 'field-hint text-warning';
        noteGroup.style.display = 'block';
      } else {
        const overage = difference.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        hintEl.textContent = `Overfunding - ${overage} more than billed (credit)`;
        hintEl.className = 'field-hint text-info';
        noteGroup.style.display = 'block';
      }
    }

    async function confirmFundDraw() {
      if (!currentDraw) return;

      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const inputVal = document.getElementById('fundedAmount').value.replace(/[^0-9.-]/g, '');
      const fundedAmount = parseFloat(inputVal) || 0;
      const difference = fundedAmount - totalAmount;
      const note = document.getElementById('partialFundingNote').value.trim();

      // Require note for non-matching amounts
      if (Math.abs(difference) >= 0.01 && !note) {
        showToast('Please provide a note explaining the funding difference', 'error');
        document.getElementById('partialFundingNote').focus();
        return;
      }

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/fund`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            funded_amount: fundedAmount,
            partial_funding_note: note || null
          })
        });

        if (!res.ok) throw new Error('Failed to fund draw');

        const result = await res.json();
        const statusLabel = result.status === 'partially_funded' ? 'partially funded' :
                           result.status === 'overfunded' ? 'overfunded' : 'funded';

        showToast(`Draw marked as ${statusLabel}`, 'success');
        closeModal('fundDrawModal');
        closeDrawModal();
        loadDraws();
      } catch (err) {
        console.error('Error funding draw:', err);
        showToast('Failed to fund draw', 'error');
      }
    }

    async function removeInvoice(invoiceId) {
      if (!currentDraw) return;

      if (!confirm('Remove this invoice from the draw?')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/remove-invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ invoice_id: invoiceId })
        });
        if (!res.ok) throw new Error('Failed to remove invoice');

        showToast('Invoice removed from draw', 'success');
        openDraw(currentDraw.id); // Refresh modal
        loadDraws(); // Refresh draw list to update amounts
      } catch (err) {
        console.error('Error removing invoice:', err);
        showToast('Failed to remove invoice', 'error');
      }
    }

    function showAddInvoiceModal() {
      showToast('Add invoice modal - coming soon', 'info');
    }

    async function showAddCOBillingModal() {
      if (!currentDraw) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/available-cos`);
        if (!res.ok) throw new Error('Failed to load available COs');

        const availableCOs = await res.json();

        if (availableCOs.length === 0) {
          showToast('No approved change orders available to bill', 'info');
          return;
        }

        // Populate the modal with available COs
        const container = document.getElementById('availableCOsList');
        container.innerHTML = availableCOs.map(co => {
          const remaining = parseFloat(co.amount) - parseFloat(co.billed_amount || 0);
          const percent = co.amount > 0 ? ((co.billed_amount || 0) / co.amount) * 100 : 0;

          return `
            <div class="co-billing-item" data-co-id="${co.id}">
              <div class="co-billing-info">
                <strong>CO-${String(co.change_order_number).padStart(3, '0')}: ${co.title}</strong>
                <div class="co-billing-details">
                  <span>Total: ${formatMoneyDecimal(co.amount)}</span>
                  <span>Billed: ${formatMoneyDecimal(co.billed_amount || 0)} (${percent.toFixed(1)}%)</span>
                  <span>Remaining: ${formatMoneyDecimal(remaining)}</span>
                </div>
              </div>
              <div class="co-billing-input">
                <label>Bill this period:</label>
                <input type="number" class="form-control co-amount-input"
                       data-co-id="${co.id}"
                       data-max="${remaining}"
                       min="0"
                       max="${remaining}"
                       step="0.01"
                       placeholder="0.00"
                       onchange="validateCOAmount(this)">
                <button class="btn btn-sm btn-outline" onclick="setCOAmountPercent('${co.id}', 100)">100%</button>
                <button class="btn btn-sm btn-outline" onclick="setCOAmountPercent('${co.id}', 50)">50%</button>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('addCOBillingModal').style.display = 'flex';
      } catch (err) {
        console.error('Error loading available COs:', err);
        showToast('Failed to load change orders', 'error');
      }
    }

    function validateCOAmount(input) {
      const max = parseFloat(input.dataset.max) || 0;
      const value = parseFloat(input.value) || 0;
      if (value > max) {
        input.value = max.toFixed(2);
        showToast('Amount cannot exceed remaining balance', 'warning');
      }
      if (value < 0) {
        input.value = '0.00';
      }
    }

    function setCOAmountPercent(coId, percent) {
      const input = document.querySelector(`.co-amount-input[data-co-id="${coId}"]`);
      if (input) {
        const max = parseFloat(input.dataset.max) || 0;
        input.value = (max * percent / 100).toFixed(2);
      }
    }

    async function saveCOBillings() {
      if (!currentDraw) return;

      const inputs = document.querySelectorAll('.co-amount-input');
      const billings = [];

      inputs.forEach(input => {
        const amount = parseFloat(input.value) || 0;
        if (amount > 0) {
          billings.push({
            changeOrderId: input.dataset.coId,
            amount: amount
          });
        }
      });

      if (billings.length === 0) {
        showToast('No amounts entered', 'warning');
        return;
      }

      try {
        for (const billing of billings) {
          const res = await fetch(`/api/draws/${currentDraw.id}/add-co-billing`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(billing)
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Failed to add CO billing');
          }
        }

        showToast(`Added ${billings.length} CO billing(s) to draw`, 'success');
        closeModal('addCOBillingModal');
        openDraw(currentDraw.id); // Refresh draw data
      } catch (err) {
        console.error('Error adding CO billings:', err);
        showToast(err.message || 'Failed to add CO billings', 'error');
      }
    }

    async function removeCOBilling(changeOrderId) {
      if (!currentDraw) return;
      if (!confirm('Remove this change order billing from the draw?')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/remove-co-billing/${changeOrderId}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to remove CO billing');
        }

        showToast('CO billing removed from draw', 'success');
        openDraw(currentDraw.id); // Refresh draw data
      } catch (err) {
        console.error('Error removing CO billing:', err);
        showToast(err.message || 'Failed to remove CO billing', 'error');
      }
    }

    async function exportExcel() {
      if (!currentDraw) return;
      window.open(`/api/draws/${currentDraw.id}/export/excel`, '_blank');
    }

    async function exportPDF() {
      if (!currentDraw) return;
      window.open(`/api/draws/${currentDraw.id}/export/pdf`, '_blank');
    }

    function showCreateDrawModal() {
      const select = document.getElementById('newDrawJob');
      select.innerHTML = '<option value="">Select a job...</option>';
      state.jobs.forEach(job => {
        select.innerHTML += `<option value="${job.id}">${job.name}</option>`;
      });

      document.getElementById('newDrawPeriodEnd').value = new Date().toISOString().split('T')[0];
      document.getElementById('createDrawModal').style.display = 'flex';
    }

    async function createDraw() {
      const jobId = document.getElementById('newDrawJob').value;
      const periodEnd = document.getElementById('newDrawPeriodEnd').value;

      if (!jobId) {
        showToast('Please select a job', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/jobs/${jobId}/draws`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ period_end: periodEnd })
        });
        if (!res.ok) throw new Error('Failed to create draw');

        const newDraw = await res.json();
        showToast('Draw created successfully', 'success');
        closeModal('createDrawModal');
        loadDraws();
        openDraw(newDraw.id);
      } catch (err) {
        console.error('Error creating draw:', err);
        showToast('Failed to create draw', 'error');
      }
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function formatMoney(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(num);
    }

    function formatMoneyDecimal(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function showToast(message, type = 'info') {
      if (window.Toast) {
        Toast.show(message, type);
      } else {
        console.log(`[${type}] ${message}`);
      }
    }
  </script>
</body>
</html>
