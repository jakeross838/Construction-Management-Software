<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ross Built - Draws</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1>Draws</h1>
        <nav class="header-nav">
          <a href="index.html" class="nav-link">Invoices</a>
          <a href="pos.html" class="nav-link">Purchase Orders</a>
          <a href="draws.html" class="nav-link active">Draws</a>
        </nav>
      </div>
      <button class="btn btn-primary" onclick="showCreateDrawModal()">+ New Draw</button>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Filters -->
      <div class="table-toolbar">
        <div class="filter-group">
          <button class="filter-btn active" data-status="all">All</button>
          <button class="filter-btn" data-status="draft">Draft</button>
          <button class="filter-btn" data-status="submitted">Submitted</button>
          <button class="filter-btn" data-status="funded">Funded</button>
        </div>
        <select id="jobFilter" class="job-filter">
          <option value="">All Jobs</option>
        </select>
      </div>

      <!-- Draw List -->
      <div class="draw-list" id="drawList">
        <div class="loading">Loading draws...</div>
      </div>
    </main>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="js/toasts.js"></script>
  <script>
    // ============================================================
    // DRAWS PAGE
    // ============================================================

    let state = {
      draws: [],
      jobs: [],
      currentFilter: 'all',
      currentJobFilter: ''
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadJobs();
      loadDraws();
      setupFilters();
    });

    async function loadJobs() {
      try {
        const res = await fetch('/api/jobs');
        state.jobs = await res.json();

        const select = document.getElementById('jobFilter');
        select.innerHTML = '<option value="">All Jobs</option>';
        state.jobs.forEach(job => {
          select.innerHTML += `<option value="${job.id}">${job.name}</option>`;
        });

        select.addEventListener('change', (e) => {
          state.currentJobFilter = e.target.value;
          renderDrawList();
        });
      } catch (err) {
        console.error('Failed to load jobs:', err);
      }
    }

    async function loadDraws() {
      try {
        // Get all draws from all jobs
        const jobsRes = await fetch('/api/jobs');
        const jobs = await jobsRes.json();

        let allDraws = [];
        for (const job of jobs) {
          const res = await fetch(`/api/jobs/${job.id}/draws`);
          const draws = await res.json();
          draws.forEach(d => d.job = job);
          allDraws = allDraws.concat(draws);
        }

        state.draws = allDraws.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        renderDrawList();
        updateStats();
      } catch (err) {
        console.error('Failed to load draws:', err);
        document.getElementById('drawList').innerHTML = '<div class="empty-state">Failed to load draws</div>';
      }
    }

    function updateStats() {
      const openDraws = state.draws.filter(d => d.status === 'draft' || d.status === 'submitted');
      const pendingAmount = openDraws.reduce((sum, d) => sum + parseFloat(d.total_amount || 0), 0);

      const now = new Date();
      const thisMonth = state.draws.filter(d => {
        if (d.status !== 'funded' || !d.funded_at) return false;
        const funded = new Date(d.funded_at);
        return funded.getMonth() === now.getMonth() && funded.getFullYear() === now.getFullYear();
      });
      const fundedMonth = thisMonth.reduce((sum, d) => sum + parseFloat(d.funded_amount || d.total_amount || 0), 0);

      const totalFunded = state.draws
        .filter(d => d.status === 'funded')
        .reduce((sum, d) => sum + parseFloat(d.funded_amount || d.total_amount || 0), 0);

      document.getElementById('statOpenDraws').textContent = openDraws.length;
      document.getElementById('statPendingAmount').textContent = formatMoney(pendingAmount);
      document.getElementById('statFundedMonth').textContent = formatMoney(fundedMonth);
      document.getElementById('statTotalFunded').textContent = formatMoney(totalFunded);
    }

    function setupFilters() {
      const buttons = document.querySelectorAll('.filter-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.currentFilter = btn.dataset.status;
          renderDrawList();
        });
      });
    }

    function renderDrawList() {
      const container = document.getElementById('drawList');

      let filtered = state.draws;

      if (state.currentFilter !== 'all') {
        filtered = filtered.filter(d => d.status === state.currentFilter);
      }

      if (state.currentJobFilter) {
        filtered = filtered.filter(d => d.job_id === state.currentJobFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No draws found</div>';
        return;
      }

      container.innerHTML = `
        <div class="draw-list-header">
          <div>Draw #</div>
          <div>Job</div>
          <div>Period End</div>
          <div>Status</div>
          <div>Amount</div>
          <div>Invoices</div>
        </div>
        ${filtered.map(draw => renderDrawRow(draw)).join('')}
      `;
    }

    function renderDrawRow(draw) {
      const statusClass = {
        draft: 'pending',
        submitted: 'pending-approval',
        funded: 'approved'
      }[draw.status] || 'pending';

      const statusLabel = {
        draft: 'Draft',
        submitted: 'Submitted',
        funded: 'Funded'
      }[draw.status] || draw.status;

      return `
        <div class="draw-row" onclick="openDraw('${draw.id}', '${draw.job_id}')">
          <div class="draw-number">Draw #${draw.draw_number}</div>
          <div class="draw-job">${draw.job?.name || 'Unknown'}</div>
          <div class="draw-date">${draw.period_end ? formatDate(draw.period_end) : '-'}</div>
          <div><span class="status-badge status-${statusClass}">${statusLabel}</span></div>
          <div class="draw-amount">${formatMoney(draw.total_amount)}</div>
          <div class="draw-invoices">${draw.invoice_count || 0}</div>
        </div>
      `;
    }

    function openDraw(drawId, jobId) {
      // For now, redirect to invoices filtered by in_draw
      window.location.href = `index.html?draw=${drawId}`;
    }

    function showCreateDrawModal() {
      // TODO: Implement create draw modal
      alert('Create Draw modal - coming soon');
    }

    function formatMoney(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(num);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
  </script>
</body>
</html>
