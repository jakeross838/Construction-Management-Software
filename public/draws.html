<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fnfkowpdlffzjqtmbnmj.supabase.co">
  <link rel="dns-prefetch" href="https://fnfkowpdlffzjqtmbnmj.supabase.co">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Draws</title>
  <link rel="stylesheet" href="css/styles.css?v=20260115-perf3">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-top">
        <div class="header-brand">
          <span class="brand-icon">üèóÔ∏è</span>
          <span class="brand-name">Ross Built</span>
        </div>
        <nav class="main-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showAutoGenerateModal()">Auto-Generate Draw</button>
        </div>
      </div>
      <div class="header-sub">
        <nav class="sub-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="app-body">
      <main class="main">
      <!-- Filters -->
      <div class="table-toolbar">
        <div class="filter-controls">
          <select id="statusFilter" class="form-control filter-select">
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="submitted">Submitted</option>
            <option value="funded">Funded</option>
          </select>
        </div>
        <div class="search-box">
          <input type="text" id="drawSearchInput" placeholder="Search draws..." class="form-control search-input">
          <button class="search-clear-btn" id="drawSearchClear" style="display: none;" onclick="clearDrawSearch()">&times;</button>
        </div>
      </div>

      <!-- Draw List -->
      <div class="draw-list" id="drawList">
        <div class="loading">Loading draws...</div>
      </div>
    </main>
    </div>
  </div>

  <!-- Draw Detail Modal (Fullscreen - Single Page Layout) -->
  <div id="drawModal" class="modal modal-fullscreen-dark">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-group">
          <h2 id="drawModalTitle">Draw #1</h2>
          <span class="status-badge" id="drawModalStatus">Draft</span>
          <span class="lock-indicator" id="lockIndicator" style="display: none;" title="This draw is locked">üîí</span>
        </div>
        <div class="modal-header-actions">
          <button class="btn btn-primary" id="editDrawBtn" onclick="toggleEditMode()" style="display: none;">
            Edit Draw
          </button>
          <button class="btn btn-success" id="saveDrawBtn" onclick="saveDrawEdits()" style="display: none;">
            Save Changes
          </button>
          <button class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEditMode()" style="display: none;">
            Cancel
          </button>
          <button class="btn btn-secondary" onclick="exportExcel()" title="Export Excel">
            Export Excel
          </button>
          <button class="btn btn-secondary" onclick="exportPDF()" title="Export PDF">
            Export PDF
          </button>
          <button class="btn btn-secondary" onclick="window.print()" title="Print">
            Print
          </button>
          <button class="close-btn" onclick="closeDrawModal()">&times;</button>
        </div>
      </div>

      <div class="modal-body draw-modal-body draw-single-page">
        <!-- Status Workflow -->
        <section class="draw-section">
          <div class="status-workflow" id="statusWorkflow">
            <div class="workflow-step" id="workflowDraft">
              <div class="workflow-icon">
                <span class="workflow-dot"></span>
              </div>
              <div class="workflow-label">Draft</div>
              <div class="workflow-date" id="workflowDraftDate">-</div>
            </div>
            <div class="workflow-connector" id="workflowConnector1"></div>
            <div class="workflow-step" id="workflowSubmitted">
              <div class="workflow-icon">
                <span class="workflow-dot"></span>
              </div>
              <div class="workflow-label">Submitted</div>
              <div class="workflow-date" id="workflowSubmittedDate">-</div>
            </div>
            <div class="workflow-connector" id="workflowConnector2"></div>
            <div class="workflow-step" id="workflowFunded">
              <div class="workflow-icon">
                <span class="workflow-dot"></span>
              </div>
              <div class="workflow-label">Funded</div>
              <div class="workflow-date" id="workflowFundedDate">-</div>
            </div>
          </div>
        </section>

        <!-- Summary Header -->
        <section class="draw-section draw-summary-section">
          <div class="draw-summary-grid">
            <div class="summary-card">
              <div class="summary-label">Job</div>
              <div class="summary-value" id="summaryJob">-</div>
            </div>
            <div class="summary-card editable-card">
              <div class="summary-label">Application #</div>
              <div class="summary-value" id="summaryAppNum">-</div>
              <input type="number" class="edit-input" id="editAppNum" style="display: none;" min="1">
            </div>
            <div class="summary-card editable-card">
              <div class="summary-label">Period To</div>
              <div class="summary-value" id="summaryPeriod">-</div>
              <input type="date" class="edit-input" id="editPeriodTo" style="display: none;">
            </div>
            <div class="summary-card">
              <div class="summary-label">Invoice Count</div>
              <div class="summary-value" id="summaryInvCount">0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">This Period</div>
              <div class="summary-value" id="summaryThisPeriod">$0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">Current Payment Due</div>
              <div class="summary-value" id="summaryPaymentDue">$0</div>
            </div>
            <div class="summary-card funding-info" id="fundingInfoCard" style="display: none;">
              <div class="summary-label">Funded Amount</div>
              <div class="summary-value" id="summaryFundedAmount">$0</div>
              <div class="funding-note" id="summaryFundingNote"></div>
            </div>
          </div>
          <!-- Notes Section (shown in edit mode) -->
          <div class="draw-notes-section" id="drawNotesSection" style="display: none;">
            <label class="summary-label">Notes</label>
            <textarea class="edit-input" id="editNotes" rows="3" placeholder="Add notes about this draw..."></textarea>
          </div>
          <!-- Notes Display (shown in view mode) -->
          <div class="draw-notes-display" id="drawNotesDisplay" style="display: none;">
            <label class="summary-label">Notes</label>
            <div class="summary-value" id="summaryNotes">-</div>
          </div>
        </section>

        <!-- G702 Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>G702 - Application and Certificate for Payment</h3>
          </div>
          <div class="g702-container">
            <div class="g702-form">
              <div class="g702-section">
                <div class="g702-row">
                  <div class="g702-field">
                    <label>TO OWNER:</label>
                    <div class="g702-value" id="g702Owner">-</div>
                  </div>
                  <div class="g702-field">
                    <label>APPLICATION NO:</label>
                    <div class="g702-value" id="g702AppNo">-</div>
                  </div>
                </div>
                <div class="g702-row">
                  <div class="g702-field">
                    <label>PROJECT:</label>
                    <div class="g702-value" id="g702Project">-</div>
                  </div>
                  <div class="g702-field">
                    <label>PERIOD TO:</label>
                    <div class="g702-value" id="g702PeriodTo">-</div>
                  </div>
                </div>
                <div class="g702-row">
                  <div class="g702-field">
                    <label>FROM CONTRACTOR:</label>
                    <div class="g702-value">Ross Built Custom Homes</div>
                  </div>
                </div>
              </div>

              <table class="g702-table">
                <tbody>
                  <tr class="g702-editable-row">
                    <td class="g702-line-num">1.</td>
                    <td>ORIGINAL CONTRACT SUM</td>
                    <td class="g702-amount">
                      <span id="g702Line1">$0.00</span>
                      <input type="text" class="g702-edit-input" id="editG702Line1" style="display: none;" placeholder="0.00">
                      <span class="g702-override-badge" id="g702Line1Badge" style="display: none;">Override</span>
                    </td>
                  </tr>
                  <tr class="g702-editable-row">
                    <td class="g702-line-num">2.</td>
                    <td>Net change by Change Orders</td>
                    <td class="g702-amount">
                      <span id="g702Line2">$0.00</span>
                      <input type="text" class="g702-edit-input" id="editG702Line2" style="display: none;" placeholder="0.00">
                      <span class="g702-override-badge" id="g702Line2Badge" style="display: none;">Override</span>
                    </td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">3.</td>
                    <td>CONTRACT SUM TO DATE (Line 1 + 2)</td>
                    <td class="g702-amount" id="g702Line3">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">4.</td>
                    <td>TOTAL COMPLETED & STORED TO DATE</td>
                    <td class="g702-amount" id="g702Line4">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">5.</td>
                    <td>LESS PREVIOUS CERTIFICATES FOR PAYMENT</td>
                    <td class="g702-amount" id="g702Line5">$0.00</td>
                  </tr>
                  <tr class="g702-highlight">
                    <td class="g702-line-num">6.</td>
                    <td><strong>CURRENT PAYMENT DUE</strong> (Line 4 less Line 5)</td>
                    <td class="g702-amount" id="g702Line6">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">7.</td>
                    <td>BALANCE TO FINISH (Line 3 less Line 4)</td>
                    <td class="g702-amount" id="g702Line7">$0.00</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <\!-- G703 Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>G703 - Schedule of Values</h3>
            <span class="section-subtitle">Budget vs Billings by Cost Code</span>
          </div>
          <div class="g703-container">
            <div class="g703-table-wrapper">
              <table class="g703-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Cost Code</th>
                    <th>Scheduled Value</th>
                    <th>Previous<br>Applications</th>
                    <th>This<br>Application</th>
                    <th>Total<br>Completed</th>
                    <th>%</th>
                    <th>Balance<br>to Finish</th>
                  </tr>
                </thead>
                <tbody id="g703Body">
                  <tr>
                    <td colspan="8" class="loading">Loading schedule of values...</td>
                  </tr>
                </tbody>
                <tfoot id="g703Footer">
                </tfoot>
              </table>
            </div>
          </div>
        </section>

        <!-- Change Order Billing Section -->
        <section class="draw-section" id="coBillingSection">
          <div class="section-header">
            <h3>Change Order Billings</h3>
            <button class="btn btn-primary btn-sm" id="addCOBillingBtn" onclick="showAddCOBillingModal()">+ Add CO Billing</button>
          </div>
          <div class="co-billing-container">
            <table class="g703-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Change Order</th>
                  <th>CO Amount</th>
                  <th>Days</th>
                  <th>Previous<br>Billings</th>
                  <th>This<br>Application</th>
                  <th>Total<br>Billed</th>
                  <th>%</th>
                  <th>Balance</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="coBillingBody">
                <tr>
                  <td colspan="10" class="empty-state">No change order billings in this draw</td>
                </tr>
              </tbody>
              <tfoot id="coBillingFooter">
              </tfoot>
            </table>
          </div>
        </section>

        <!-- Invoices Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Invoices in this Draw</h3>
            <span class="section-hint" id="invoicesSectionHint">Invoices are automatically added when approved</span>
          </div>
          <div class="invoices-container">
            <table class="invoices-table">
              <thead>
                <tr>
                  <th>Vendor</th>
                  <th>Invoice #</th>
                  <th>Date</th>
                  <th>Cost Codes</th>
                  <th>Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoicesBody">
                <tr>
                  <td colspan="6" class="loading">Loading invoices...</td>
                </tr>
              </tbody>
              <tfoot id="invoicesFooter">
              </tfoot>
            </table>
          </div>
        </section>

        <!-- Lien Releases Section -->
        <section class="draw-section draw-lien-releases-section">
          <div class="section-header">
            <h3>Lien Releases</h3>
            <button class="btn btn-sm btn-secondary" onclick="showAttachLienReleaseModal()">+ Attach Release</button>
          </div>
          <div class="lien-release-mini-list" id="drawLienReleasesContainer">
            <div class="empty-state">No lien releases attached</div>
          </div>
        </section>

        <!-- Activity Log Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Activity Log</h3>
          </div>
          <div class="activity-container" id="activityContainer">
            <div class="empty-state">No activity recorded</div>
          </div>
        </section>
      </div>

      <div class="modal-footer" id="drawModalFooter">
        <button class="btn btn-secondary" onclick="closeDrawModal()">Close</button>
        <button class="btn btn-outline-warning" id="unsubmitDrawBtn" onclick="unsubmitDraw()" style="display:none;">Unsubmit</button>
        <button class="btn btn-warning" id="submitDrawBtn" onclick="submitDraw()">Submit Draw</button>
        <button class="btn btn-success" id="fundDrawBtn" onclick="fundDraw()" style="display:none;">Mark as Funded</button>
      </div>
    </div>
  </div>

  <!-- Add CO Billing Modal -->
  <div id="addCOBillingModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Add Change Order Billings</h2>
        <button class="close-btn" onclick="closeModal('addCOBillingModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-description">Select change orders to bill on this draw. Enter the amount to bill for each.</p>
        <div id="availableCOsList" class="co-billing-list">
          <!-- Dynamic content populated by showAddCOBillingModal -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addCOBillingModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCOBillings()">Add to Draw</button>
      </div>
    </div>
  </div>

  <!-- Fund Draw Modal -->
  <div id="fundDrawModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Mark Draw as Funded</h2>
        <button class="close-btn" onclick="closeModal('fundDrawModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="funding-summary" id="fundingSummary">
          <!-- Populated dynamically -->
        </div>

        <div class="form-group">
          <label>Amount Funded *</label>
          <div class="input-with-prefix">
            <span class="input-prefix">$</span>
            <input type="text" id="fundedAmount" class="form-control" placeholder="0.00"
              oninput="updateFundingDifference()">
          </div>
          <div class="field-hint" id="fundingDifferenceHint"></div>
        </div>

        <div class="form-group" id="partialNoteGroup" style="display: none;">
          <label>Note (required for partial funding)</label>
          <textarea id="partialFundingNote" class="form-control" rows="2"
            placeholder="Explain why the funding differs from the billed amount..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('fundDrawModal')">Cancel</button>
        <button class="btn btn-success" id="confirmFundBtn" onclick="confirmFundDraw()">Confirm Funding</button>
      </div>
    </div>
  </div>

  <!-- Submit Draw Modal -->
  <div id="submitDrawModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Submit Draw</h2>
        <button class="close-btn" onclick="closeModal('submitDrawModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Submitting will lock this draw from further changes.</p>
        <div class="form-group">
          <label>Period End Date *</label>
          <input type="date" id="submitPeriodEnd" class="form-control" required>
          <div class="field-hint">The billing period end date for this pay application</div>
        </div>
        <div id="submitDrawSummary" class="submit-summary">
          <!-- Populated dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('submitDrawModal')">Cancel</button>
        <button class="btn btn-warning" onclick="confirmSubmitDraw()">Submit Draw</button>
      </div>
    </div>
  </div>

  <!-- Unsubmit Reason Modal -->
  <div id="unsubmitModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Unsubmit Draw</h2>
        <button class="close-btn" onclick="closeModal('unsubmitModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>This will return the draw to draft status, allowing changes to be made.</p>
        <div class="form-group">
          <label>Reason (optional)</label>
          <textarea id="unsubmitReason" class="form-control" rows="3" placeholder="Why is this draw being unsubmitted?"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('unsubmitModal')">Cancel</button>
        <button class="btn btn-warning" onclick="confirmUnsubmit()">Unsubmit Draw</button>
      </div>
    </div>
  </div>

  <!-- Auto-Generate Draw Modal -->
  <div id="autoGenerateModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Auto-Generate Draw</h2>
        <button class="close-btn" onclick="closeModal('autoGenerateModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Job *</label>
          <select id="autoGenerateJob" class="form-control" onchange="loadApprovedInvoices()">
            <option value="">Select a job...</option>
          </select>
        </div>
        <div id="autoGeneratePreview" class="auto-generate-preview" style="display: none;">
          <div class="auto-generate-summary">
            <div class="summary-row">
              <span class="label">Approved Invoices Ready:</span>
              <span class="value" id="agInvoiceCount">0</span>
            </div>
            <div class="summary-row">
              <span class="label">Total Amount:</span>
              <span class="value" id="agTotalAmount">$0.00</span>
            </div>
            <div class="summary-row existing-draft" id="agExistingDraft" style="display: none;">
              <span class="label">Existing Draft Draw:</span>
              <span class="value" id="agDraftInfo">-</span>
            </div>
          </div>
          <div class="invoice-preview-list" id="agInvoiceList">
            <!-- Invoice list populated dynamically -->
          </div>
        </div>
        <div id="autoGenerateEmpty" class="empty-state" style="display: none;">
          No approved invoices ready for this job.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('autoGenerateModal')">Cancel</button>
        <button class="btn btn-primary" id="autoGenerateBtn" onclick="executeAutoGenerate()" disabled>Generate Draw</button>
      </div>
    </div>
  </div>

  <!-- Invoice PDF Viewer Modal -->
  <div id="pdfViewerModal" class="modal modal-fullscreen-dark">
    <div class="modal-content" style="max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
      <div class="modal-header">
        <div>
          <h2 id="pdfViewerTitle">Invoice</h2>
          <p id="pdfViewerSubtitle" class="modal-subtitle" style="margin: 0; color: var(--text-secondary);"></p>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <span id="pdfInvoiceStatus" class="status-badge"></span>
          <button class="close-btn" onclick="closeModal('pdfViewerModal')">&times;</button>
        </div>
      </div>
      <div class="modal-body" style="flex: 1; padding: 0; overflow: hidden;">
        <div id="pdfViewerLoading" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
          <span class="loading">Loading PDF...</span>
        </div>
        <iframe id="pdfViewerFrame" style="width: 100%; height: 100%; border: none; display: none;"></iframe>
        <div id="pdfViewerError" style="display: none; padding: 2rem; text-align: center; color: var(--text-secondary);">
          <p>Unable to load PDF</p>
          <button class="btn btn-primary" onclick="openInvoiceInNewTab()">Open Invoice Page</button>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 0.75rem 1.5rem;">
        <div id="pdfInvoiceInfo" style="display: flex; gap: 2rem; font-size: 0.9rem; color: var(--text-secondary);"></div>
        <button class="btn btn-secondary" onclick="closeModal('pdfViewerModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Attach Lien Release Modal -->
  <div id="attachLienReleaseModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Attach Lien Release</h2>
        <button class="close-btn" onclick="closeModal('attachLienReleaseModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-description">Select lien releases to attach to this draw.</p>
        <div id="availableLienReleasesList" class="lien-release-picker-list">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('attachLienReleaseModal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmAttachLienReleases()">Attach Selected</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script defer src="js/toasts.js?v=20260115-perf"></script>
  <script defer src="js/nav-sidebar.js?v=20260115-perf"></script>
  <script defer src="js/sidebar.js?v=20260115-perf"></script>
  <script>
    // ============================================================
    // DRAWS PAGE - Single Page Layout
    // ============================================================

    let state = {
      draws: [],
      jobs: [],
      currentFilter: 'all',
      currentJobFilter: '',
      searchQuery: '',
      currentViewingInvoice: null,
      currentDrawInvoices: []
    };

    document.addEventListener('DOMContentLoaded', async () => {
      loadJobs();
      await loadDraws();
      setupFilters();
      setupDrawSearch();

      // Check for openDraw query parameter (deep linking from reconciliation, etc.)
      const urlParams = new URLSearchParams(window.location.search);
      const openDrawId = urlParams.get('openDraw');
      if (openDrawId) {
        // Clear the URL parameter without reloading
        window.history.replaceState({}, '', window.location.pathname);
        // Open the draw modal after data is loaded
        setTimeout(() => {
          openDraw(openDrawId);
        }, 300);
      }

      // Sidebar integration - listen for job selection changes
      if (window.JobSidebar) {
        window.JobSidebar.onJobChange((jobId) => {
          state.currentJobFilter = jobId;
          renderDrawList();
        });
      }
    });

    function setupDrawSearch() {
      const input = document.getElementById('drawSearchInput');
      const clearBtn = document.getElementById('drawSearchClear');
      let debounceTimer;

      if (!input) return;

      input.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          state.searchQuery = e.target.value;
          clearBtn.style.display = state.searchQuery ? 'block' : 'none';
          renderDrawList();
        }, 300);
      });
    }

    function clearDrawSearch() {
      const input = document.getElementById('drawSearchInput');
      const clearBtn = document.getElementById('drawSearchClear');
      if (input) input.value = '';
      state.searchQuery = '';
      clearBtn.style.display = 'none';
      renderDrawList();
    }

    async function loadJobs() {
      try {
        const res = await fetch('/api/jobs');
        state.jobs = await res.json();
      } catch (err) {
        console.error('Failed to load jobs:', err);
      }
    }

    async function loadDraws() {
      try {
        const jobsRes = await fetch('/api/jobs');
        const jobs = await jobsRes.json();

        let allDraws = [];
        for (const job of jobs) {
          const res = await fetch(`/api/jobs/${job.id}/draws`);
          const draws = await res.json();
          draws.forEach(d => d.job = job);
          allDraws = allDraws.concat(draws);
        }

        state.draws = allDraws.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        renderDrawList();
      } catch (err) {
        console.error('Failed to load draws:', err);
        document.getElementById('drawList').innerHTML = '<div class="empty-state">Failed to load draws</div>';
      }
    }

    function setupFilters() {
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', (e) => {
          state.currentFilter = e.target.value || 'all';
          renderDrawList();
        });
      }
    }

    function renderDrawList() {
      const container = document.getElementById('drawList');

      let filtered = state.draws;

      if (state.currentFilter !== 'all') {
        filtered = filtered.filter(d => d.status === state.currentFilter);
      }

      if (state.currentJobFilter) {
        filtered = filtered.filter(d => d.job_id === state.currentJobFilter);
      }

      // Search filter
      if (state.searchQuery) {
        const q = state.searchQuery.toLowerCase();
        filtered = filtered.filter(d =>
          (d.draw_number?.toString() || '').includes(q) ||
          (d.job?.name || '').toLowerCase().includes(q) ||
          (d.status || '').toLowerCase().includes(q) ||
          (d.total_amount?.toString() || '').includes(q)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No draws found</div>';
        return;
      }

      container.innerHTML = `
        <div class="draw-list-header">
          <div>Draw #</div>
          <div>Job</div>
          <div>Period End</div>
          <div>Status</div>
          <div>Amount</div>
          <div>Invoices</div>
        </div>
        ${filtered.map(draw => renderDrawRow(draw)).join('')}
      `;
    }

    function renderDrawRow(draw) {
      // Only 3 statuses: draft, submitted, funded
      const statusClass = {
        draft: 'pending',
        submitted: 'pending-approval',
        funded: 'approved'
      }[draw.status] || 'pending';

      const statusLabel = {
        draft: 'Draft',
        submitted: 'Submitted',
        funded: 'Funded'
      }[draw.status] || draw.status;

      // Funding variance indicator (shown next to status for funded draws)
      let fundingVariance = '';
      if (draw.status === 'funded' && draw.funding_difference) {
        const diff = parseFloat(draw.funding_difference);
        if (diff < -0.01) {
          fundingVariance = `<span class="funding-variance text-warning">-${formatMoney(Math.abs(diff))}</span>`;
        } else if (diff > 0.01) {
          fundingVariance = `<span class="funding-variance text-info">+${formatMoney(diff)}</span>`;
        }
      }

      // Count invoices from the nested data
      const invoiceCount = draw.invoices?.length || draw.invoice_count || 0;

      return `
        <div class="draw-row" onclick="openDraw('${draw.id}', '${draw.job_id}')">
          <div class="draw-number">Draw #${draw.draw_number}</div>
          <div class="draw-job">${draw.job?.name || 'Unknown'}</div>
          <div class="draw-date">${draw.period_end ? formatDate(draw.period_end) : '-'}</div>
          <div><span class="status-badge status-${statusClass}">${statusLabel}</span>${fundingVariance}</div>
          <div class="draw-amount">${formatMoney(draw.total_amount)}</div>
          <div class="draw-invoices">${invoiceCount}</div>
        </div>
      `;
    }

    let currentDraw = null;
    window.currentDraw = null;

    async function openDraw(drawId) {
      console.log('openDraw called with drawId:', drawId);
      try {
        const url = `/api/draws/${drawId}`;
        const res = await fetch(url);

        if (!res.ok) {
          const errorText = await res.text();
          console.error('API Error:', errorText);
          throw new Error(`Failed to fetch draw: ${res.status}`);
        }

        currentDraw = await res.json();
        window.currentDraw = currentDraw;

        renderDrawModal(currentDraw);
        document.getElementById('drawModal').classList.add('show');
      } catch (err) {
        console.error('Error opening draw:', err);
        showToast('Failed to load draw', 'error');
      }
    }

    let isEditMode = false;

    function updateStatusWorkflow(draw) {
      const draftStep = document.getElementById('workflowDraft');
      const submittedStep = document.getElementById('workflowSubmitted');
      const fundedStep = document.getElementById('workflowFunded');
      const connector1 = document.getElementById('workflowConnector1');
      const connector2 = document.getElementById('workflowConnector2');

      // Reset all
      [draftStep, submittedStep, fundedStep].forEach(step => {
        step.classList.remove('completed', 'current');
      });
      [connector1, connector2].forEach(conn => {
        conn.classList.remove('completed');
      });

      // Set dates
      document.getElementById('workflowDraftDate').textContent = draw.created_at ? formatDate(draw.created_at) : '-';
      document.getElementById('workflowSubmittedDate').textContent = draw.submitted_at ? formatDate(draw.submitted_at) : '-';
      document.getElementById('workflowFundedDate').textContent = draw.funded_at ? formatDate(draw.funded_at) : '-';

      // Set states based on current status
      if (draw.status === 'draft') {
        draftStep.classList.add('current');
      } else if (draw.status === 'submitted') {
        draftStep.classList.add('completed');
        connector1.classList.add('completed');
        submittedStep.classList.add('current');
      } else if (draw.status === 'funded') {
        draftStep.classList.add('completed');
        connector1.classList.add('completed');
        submittedStep.classList.add('completed');
        connector2.classList.add('completed');
        fundedStep.classList.add('current');
      }
    }

    function closeDrawModal() {
      document.getElementById('drawModal').classList.remove('show');
      currentDraw = null;
      isEditMode = false;
    }

    function toggleEditMode() {
      isEditMode = true;

      // Show edit inputs, hide display values
      document.getElementById('summaryAppNum').style.display = 'none';
      document.getElementById('summaryPeriod').style.display = 'none';
      document.getElementById('editAppNum').style.display = 'block';
      document.getElementById('editPeriodTo').style.display = 'block';

      // Populate edit inputs with current values
      document.getElementById('editAppNum').value = currentDraw.draw_number;
      document.getElementById('editPeriodTo').value = currentDraw.period_end ? currentDraw.period_end.split('T')[0] : '';
      document.getElementById('editNotes').value = currentDraw.notes || '';

      // Show notes edit section
      document.getElementById('drawNotesSection').style.display = 'block';
      document.getElementById('drawNotesDisplay').style.display = 'none';

      // Show G702 edit inputs
      document.getElementById('editG702Line1').style.display = 'inline-block';
      document.getElementById('editG702Line2').style.display = 'inline-block';

      // Populate G702 edit values (use override if set, otherwise calculated value)
      const contractSum = currentDraw.g702_original_contract_override ?? currentDraw.job?.contract_amount ?? 0;
      const changeOrders = currentDraw.g702_change_orders_override ?? currentDraw.changeOrderTotal ?? 0;
      document.getElementById('editG702Line1').value = parseFloat(contractSum).toFixed(2);
      document.getElementById('editG702Line2').value = parseFloat(changeOrders).toFixed(2);

      // Toggle buttons
      document.getElementById('editDrawBtn').style.display = 'none';
      document.getElementById('saveDrawBtn').style.display = 'inline-block';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
    }

    function cancelEditMode() {
      isEditMode = false;

      // Hide edit inputs, show display values
      document.getElementById('summaryAppNum').style.display = 'block';
      document.getElementById('summaryPeriod').style.display = 'block';
      document.getElementById('editAppNum').style.display = 'none';
      document.getElementById('editPeriodTo').style.display = 'none';

      // Hide notes edit, show display if has notes
      document.getElementById('drawNotesSection').style.display = 'none';
      if (currentDraw.notes) {
        document.getElementById('drawNotesDisplay').style.display = 'block';
      }

      // Hide G702 edit inputs
      document.getElementById('editG702Line1').style.display = 'none';
      document.getElementById('editG702Line2').style.display = 'none';

      // Toggle buttons
      document.getElementById('editDrawBtn').style.display = 'inline-block';
      document.getElementById('saveDrawBtn').style.display = 'none';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }

    async function saveDrawEdits() {
      // Parse G702 values (remove commas if present)
      const g702Line1 = parseFloat(document.getElementById('editG702Line1').value.replace(/,/g, '')) || 0;
      const g702Line2 = parseFloat(document.getElementById('editG702Line2').value.replace(/,/g, '')) || 0;

      const updates = {
        draw_number: parseInt(document.getElementById('editAppNum').value),
        period_end: document.getElementById('editPeriodTo').value,
        notes: document.getElementById('editNotes').value || null,
        g702_overrides: {
          original_contract_sum: g702Line1,
          net_change_orders: g702Line2
        }
      };

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || 'Failed to save');
        }

        showToast('Draw updated successfully', 'success');

        // Reload the draw
        await openDraw(currentDraw.id);
        cancelEditMode();
        loadDraws();
      } catch (err) {
        console.error('Error saving draw:', err);
        showToast(err.message || 'Failed to save draw', 'error');
      }
    }

    function renderDrawModal(draw) {
      // Modal header
      document.getElementById('drawModalTitle').textContent = `Draw #${draw.draw_number} - ${draw.job?.name || 'Unknown Job'}`;

      // Status badge - only 3 statuses: draft, submitted, funded
      const statusBadge = document.getElementById('drawModalStatus');
      const statusClass = { draft: 'pending', submitted: 'pending-approval', funded: 'approved' }[draw.status] || 'pending';
      const statusLabel = { draft: 'Draft', submitted: 'Submitted', funded: 'Funded' }[draw.status] || draw.status;
      statusBadge.className = `status-badge status-${statusClass}`;
      statusBadge.textContent = statusLabel;

      // Update status workflow
      updateStatusWorkflow(draw);

      // Summary section
      document.getElementById('summaryJob').textContent = draw.job?.name || '-';
      document.getElementById('summaryAppNum').textContent = draw.draw_number;
      document.getElementById('summaryPeriod').textContent = draw.period_end ? formatDate(draw.period_end) : '-';
      document.getElementById('summaryInvCount').textContent = draw.invoiceCount || 0;
      document.getElementById('summaryThisPeriod').textContent = formatMoney(draw.g702?.totalCompletedThisPeriod || 0);
      document.getElementById('summaryPaymentDue').textContent = formatMoney(draw.g702?.currentPaymentDue || 0);

      // Funding info (for funded draws)
      const fundingInfoCard = document.getElementById('fundingInfoCard');
      if (draw.status === 'funded') {
        fundingInfoCard.style.display = 'block';
        const fundedAmount = parseFloat(draw.funded_amount || 0);
        const billedAmount = parseFloat(draw.total_amount || 0);
        const diff = parseFloat(draw.funding_difference || 0);

        document.getElementById('summaryFundedAmount').textContent = formatMoney(fundedAmount);

        const noteEl = document.getElementById('summaryFundingNote');
        if (diff < -0.01) {
          // Partial payment - client paid less
          noteEl.innerHTML = `<span class="text-warning">Short ${formatMoney(Math.abs(diff))}</span>`;
          if (draw.partial_funding_note) {
            noteEl.innerHTML += `<br><small>${draw.partial_funding_note}</small>`;
          }
        } else if (diff > 0.01) {
          // Overpayment - client paid more (credit)
          noteEl.innerHTML = `<span class="text-info">Credit ${formatMoney(diff)}</span>`;
          if (draw.partial_funding_note) {
            noteEl.innerHTML += `<br><small>${draw.partial_funding_note}</small>`;
          }
        } else {
          noteEl.textContent = 'Paid in full';
        }
      } else {
        fundingInfoCard.style.display = 'none';
      }

      // G702 section
      document.getElementById('g702Owner').textContent = draw.job?.client_name || '-';
      document.getElementById('g702AppNo').textContent = draw.draw_number;
      document.getElementById('g702Project').textContent = draw.job?.name || '-';
      document.getElementById('g702PeriodTo').textContent = draw.period_end ? formatDate(draw.period_end) : '-';

      // G702 values - use overrides if set, otherwise use calculated values
      const hasContractOverride = draw.g702_original_contract_override !== null && draw.g702_original_contract_override !== undefined;
      const hasChangeOrderOverride = draw.g702_change_orders_override !== null && draw.g702_change_orders_override !== undefined;

      const contractSum = hasContractOverride ? parseFloat(draw.g702_original_contract_override) : (parseFloat(draw.job?.contract_amount) || 0);
      const changeOrders = hasChangeOrderOverride ? parseFloat(draw.g702_change_orders_override) : (draw.changeOrderTotal || 0);
      const contractSumToDate = contractSum + changeOrders;
      const totalCompleted = draw.g702?.grandTotal || 0;
      const previousCertificates = draw.g702?.lessPreviousCertificates || 0;
      const currentPaymentDue = draw.g702?.currentPaymentDue || 0;
      const balanceToFinish = contractSumToDate - totalCompleted;

      // Store for edit mode
      draw.g702_original_contract_override = hasContractOverride ? draw.g702_original_contract_override : null;
      draw.g702_change_orders_override = hasChangeOrderOverride ? draw.g702_change_orders_override : null;

      document.getElementById('g702Line1').textContent = formatMoneyDecimal(contractSum);
      document.getElementById('g702Line2').textContent = formatMoneyDecimal(changeOrders);
      document.getElementById('g702Line3').textContent = formatMoneyDecimal(contractSumToDate);
      document.getElementById('g702Line4').textContent = formatMoneyDecimal(totalCompleted);
      document.getElementById('g702Line5').textContent = formatMoneyDecimal(previousCertificates);
      document.getElementById('g702Line6').textContent = formatMoneyDecimal(currentPaymentDue);
      document.getElementById('g702Line7').textContent = formatMoneyDecimal(balanceToFinish);

      // Show override badges
      document.getElementById('g702Line1Badge').style.display = hasContractOverride ? 'inline-block' : 'none';
      document.getElementById('g702Line2Badge').style.display = hasChangeOrderOverride ? 'inline-block' : 'none';

      // G703 section
      renderG703Table(draw.scheduleOfValues || []);

      // CO Billing section (includes linked COs and unlinked CO cost code allocations)
      renderCOBillingTable(draw.coScheduleOfValues || [], draw.status, draw.unlinkedCOAllocations);

      // Invoices section
      renderInvoicesTable(draw.invoices || [], draw.status);

      // Lien releases section
      loadDrawLienReleases(draw.id, draw.status);

      // Activity log section
      renderActivityLog(draw.activity || []);

      // Lock indicator
      const lockIndicator = document.getElementById('lockIndicator');
      const isLocked = draw.status !== 'draft';
      lockIndicator.style.display = isLocked ? 'inline' : 'none';

      // Action buttons based on status
      const submitBtn = document.getElementById('submitDrawBtn');
      const fundBtn = document.getElementById('fundDrawBtn');
      const unsubmitBtn = document.getElementById('unsubmitDrawBtn');
      const addCOBillingBtn = document.getElementById('addCOBillingBtn');
      const isFunded = ['funded', 'partially_funded', 'overfunded'].includes(draw.status);

      // Edit button - only for draft status
      const editDrawBtn = document.getElementById('editDrawBtn');
      editDrawBtn.style.display = draw.status === 'draft' ? 'inline-block' : 'none';

      // Reset edit mode buttons
      document.getElementById('saveDrawBtn').style.display = 'none';
      document.getElementById('cancelEditBtn').style.display = 'none';

      // Notes display
      const notesDisplay = document.getElementById('drawNotesDisplay');
      const notesSection = document.getElementById('drawNotesSection');
      const summaryNotes = document.getElementById('summaryNotes');
      notesSection.style.display = 'none'; // Always hidden initially (shown in edit mode)
      if (draw.notes) {
        notesDisplay.style.display = 'block';
        summaryNotes.textContent = draw.notes;
      } else {
        notesDisplay.style.display = 'none';
      }

      if (draw.status === 'draft') {
        submitBtn.style.display = 'inline-block';
        fundBtn.style.display = 'none';
        unsubmitBtn.style.display = 'none';
        addCOBillingBtn.style.display = 'inline-block';
      } else if (draw.status === 'submitted') {
        submitBtn.style.display = 'none';
        fundBtn.style.display = 'inline-block';
        unsubmitBtn.style.display = 'inline-block';
        addCOBillingBtn.style.display = 'none';
      } else {
        // Funded draws - fully immutable
        submitBtn.style.display = 'none';
        fundBtn.style.display = 'none';
        unsubmitBtn.style.display = 'none';
        addCOBillingBtn.style.display = 'none';
      }
    }

    function renderG703Table(scheduleOfValues) {
      const tbody = document.getElementById('g703Body');
      const tfoot = document.getElementById('g703Footer');

      if (!scheduleOfValues || scheduleOfValues.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No billing data for this draw</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      tbody.innerHTML = scheduleOfValues.map(item => {
        const budget = item.budget || item.scheduledValue || 0;
        const previous = item.previousBilled || item.previousCompleted || 0;
        const current = item.currentBilled || item.thisPeriod || 0;
        const total = item.totalBilled || item.totalCompleted || 0;
        const balance = item.balance || 0;
        const balanceClass = balance < 0 ? 'over-budget' : '';

        return `
          <tr>
            <td>${item.item}</td>
            <td>${item.costCode} - ${item.description}</td>
            <td class="amount">${budget > 0 ? formatMoneyDecimal(budget) : '<span class="no-budget">No Budget</span>'}</td>
            <td class="amount">${formatMoneyDecimal(previous)}</td>
            <td class="amount highlight-current">${formatMoneyDecimal(current)}</td>
            <td class="amount">${formatMoneyDecimal(total)}</td>
            <td class="percent">${item.percentComplete.toFixed(1)}%</td>
            <td class="amount ${balanceClass}">${formatMoneyDecimal(balance)}</td>
          </tr>
        `;
      }).join('');

      // Totals row
      const totals = scheduleOfValues.reduce((acc, item) => ({
        budget: acc.budget + (item.budget || item.scheduledValue || 0),
        previous: acc.previous + (item.previousBilled || item.previousCompleted || 0),
        current: acc.current + (item.currentBilled || item.thisPeriod || 0),
        total: acc.total + (item.totalBilled || item.totalCompleted || 0),
        balance: acc.balance + (item.balance || 0)
      }), { budget: 0, previous: 0, current: 0, total: 0, balance: 0 });

      const overallPercent = totals.budget > 0 ? (totals.total / totals.budget) * 100 : (totals.total > 0 ? 100 : 0);

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td></td>
          <td><strong>GRAND TOTAL</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.budget)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.previous)}</strong></td>
          <td class="amount highlight-current"><strong>${formatMoneyDecimal(totals.current)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.total)}</strong></td>
          <td class="percent"><strong>${overallPercent.toFixed(1)}%</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.balance)}</strong></td>
        </tr>
      `;
    }

    function renderCOBillingTable(coScheduleOfValues, drawStatus, unlinkedCOAllocations) {
      const tbody = document.getElementById('coBillingBody');
      const tfoot = document.getElementById('coBillingFooter');
      const section = document.getElementById('coBillingSection');

      const hasLinkedCOs = coScheduleOfValues && coScheduleOfValues.length > 0;
      const hasUnlinkedCO = unlinkedCOAllocations &&
        (unlinkedCOAllocations.totalThisPeriod > 0 || unlinkedCOAllocations.totalPrevious > 0);

      if (!hasLinkedCOs && !hasUnlinkedCO) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No change order billings in this draw</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      const isDraft = drawStatus === 'draft';
      let rowHtml = '';
      let itemNum = 0;

      // Render linked CO rows
      if (hasLinkedCOs) {
        rowHtml += coScheduleOfValues.map((item) => {
          itemNum++;
          const coAmount = parseFloat(item.coAmount) || 0;
          const daysAdded = parseInt(item.daysAdded) || 0;
          const previous = parseFloat(item.previousBilled) || 0;
          const current = parseFloat(item.thisPeriod) || 0;
          const total = parseFloat(item.totalBilled) || 0;
          const balance = coAmount - total;
          const percent = coAmount > 0 ? (total / coAmount) * 100 : 0;

          const daysDisplay = daysAdded > 0 ? `+${daysAdded}` : daysAdded.toString();
          const daysColor = daysAdded > 0 ? 'var(--accent-orange)' : (daysAdded < 0 ? 'var(--accent-green)' : 'var(--text-secondary)');

          return `
            <tr>
              <td>${itemNum}</td>
              <td>
                <strong>CO-${String(item.changeOrderNumber).padStart(3, '0')}</strong>
                <br><span class="text-muted">${item.title || ''}</span>
              </td>
              <td class="amount">${formatMoneyDecimal(coAmount)}</td>
              <td style="text-align: center; color: ${daysColor}; font-weight: 500;">${daysDisplay}</td>
              <td class="amount">${formatMoneyDecimal(previous)}</td>
              <td class="amount highlight-current">${formatMoneyDecimal(current)}</td>
              <td class="amount">${formatMoneyDecimal(total)}</td>
              <td class="percent">${percent.toFixed(1)}%</td>
              <td class="amount">${formatMoneyDecimal(balance)}</td>
              <td>
                ${isDraft && current > 0 ? `
                  <button class="btn btn-sm btn-danger" onclick="removeCOBilling('${item.changeOrderId}')" title="Remove from draw">
                    <i class="fas fa-times"></i>
                  </button>
                ` : '-'}
              </td>
            </tr>
          `;
        }).join('');
      }

      // Render unlinked CO cost code allocations (grouped by cost code)
      if (hasUnlinkedCO) {
        const unlinkedAllocations = unlinkedCOAllocations.thisPeriod?.allocations || [];
        const previousUnlinked = unlinkedCOAllocations.previous?.allocations || [];

        // Group by cost code
        const byCostCode = {};
        unlinkedAllocations.forEach(alloc => {
          const code = alloc.cost_code?.code || 'Unknown';
          if (!byCostCode[code]) {
            byCostCode[code] = {
              code,
              name: alloc.cost_code?.name || 'Unknown',
              thisPeriod: 0,
              previous: 0
            };
          }
          byCostCode[code].thisPeriod += parseFloat(alloc.amount) || 0;
        });
        previousUnlinked.forEach(alloc => {
          const code = alloc.cost_code?.code || 'Unknown';
          if (!byCostCode[code]) {
            byCostCode[code] = {
              code,
              name: alloc.cost_code?.name || 'Unknown',
              thisPeriod: 0,
              previous: 0
            };
          }
          byCostCode[code].previous += parseFloat(alloc.amount) || 0;
        });

        // Render each unlinked CO cost code as a row
        Object.values(byCostCode).forEach(cc => {
          itemNum++;
          const total = cc.previous + cc.thisPeriod;
          rowHtml += `
            <tr class="unlinked-co-row">
              <td>${itemNum}</td>
              <td>
                <strong>${cc.code}</strong>
                <span class="badge badge-secondary" style="margin-left: 8px; font-size: 10px;">No CO</span>
                <br><span class="text-muted">${cc.name}</span>
              </td>
              <td class="amount" style="color: var(--text-secondary);">-</td>
              <td style="text-align: center; color: var(--text-secondary);">-</td>
              <td class="amount">${formatMoneyDecimal(cc.previous)}</td>
              <td class="amount highlight-current">${formatMoneyDecimal(cc.thisPeriod)}</td>
              <td class="amount">${formatMoneyDecimal(total)}</td>
              <td class="percent">-</td>
              <td class="amount">-</td>
              <td>-</td>
            </tr>
          `;
        });
      }

      tbody.innerHTML = rowHtml;

      // Calculate totals (linked COs + unlinked)
      const linkedTotals = (coScheduleOfValues || []).reduce((acc, item) => ({
        coAmount: acc.coAmount + (parseFloat(item.coAmount) || 0),
        days: acc.days + (parseInt(item.daysAdded) || 0),
        previous: acc.previous + (parseFloat(item.previousBilled) || 0),
        current: acc.current + (parseFloat(item.thisPeriod) || 0),
        total: acc.total + (parseFloat(item.totalBilled) || 0)
      }), { coAmount: 0, days: 0, previous: 0, current: 0, total: 0 });

      const unlinkedPrev = unlinkedCOAllocations?.totalPrevious || 0;
      const unlinkedCurr = unlinkedCOAllocations?.totalThisPeriod || 0;

      const totals = {
        coAmount: linkedTotals.coAmount, // Only count linked CO amounts as scheduled
        days: linkedTotals.days,
        previous: linkedTotals.previous + unlinkedPrev,
        current: linkedTotals.current + unlinkedCurr,
        total: linkedTotals.total + unlinkedPrev + unlinkedCurr
      };

      const overallPercent = totals.coAmount > 0 ? (linkedTotals.total / totals.coAmount) * 100 : 0;
      const totalBalance = totals.coAmount - linkedTotals.total;
      const totalDaysDisplay = totals.days > 0 ? `+${totals.days}` : totals.days.toString();

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td></td>
          <td><strong>CO TOTALS</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.coAmount)}</strong></td>
          <td style="text-align: center;"><strong>${totalDaysDisplay}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.previous)}</strong></td>
          <td class="amount highlight-current"><strong>${formatMoneyDecimal(totals.current)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.total)}</strong></td>
          <td class="percent"><strong>${overallPercent.toFixed(1)}%</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totalBalance)}</strong></td>
          <td></td>
        </tr>
      `;
    }

    function renderInvoicesTable(invoices, drawStatus) {
      const tbody = document.getElementById('invoicesBody');
      const tfoot = document.getElementById('invoicesFooter');
      const isDraft = drawStatus === 'draft';

      if (!invoices || invoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No invoices in this draw yet. Approve invoices to add them automatically.</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      // Helper to get billable amount (allocation sum or invoice amount)
      function getBillableAmount(inv) {
        const allocationSum = (inv.allocations || []).reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
        return allocationSum > 0 ? allocationSum : parseFloat(inv.amount || 0);
      }

      // Store invoices for PDF viewer access
      state.currentDrawInvoices = invoices;

      tbody.innerHTML = invoices.map((inv, idx) => {
        // Get cost codes from allocations
        const costCodes = inv.allocations?.map(a => a.cost_code?.code).filter(Boolean).join(', ') || '-';
        const billableAmount = getBillableAmount(inv);
        const isPartial = billableAmount < parseFloat(inv.amount || 0);
        const hasValidPdf = inv.pdf_stamped_url || inv.pdf_url;

        return `
          <tr class="${hasValidPdf ? 'clickable-row' : ''}" ${hasValidPdf ? `onclick="showInvoicePdf(state.currentDrawInvoices[${idx}])"` : ''} ${hasValidPdf ? 'title="Click to view PDF"' : ''}>
            <td>${inv.vendor?.name || 'Unknown'}</td>
            <td><strong>${inv.invoice_number || '-'}</strong>${isPartial ? ' <span class="partial-badge">Partial</span>' : ''}</td>
            <td>${inv.invoice_date ? formatDate(inv.invoice_date) : '-'}</td>
            <td class="cost-codes">${costCodes}</td>
            <td class="amount">${formatMoney(billableAmount)}${isPartial ? `<br><small class="text-muted">of ${formatMoney(inv.amount)}</small>` : ''}</td>
            <td>
              ${isDraft ? `
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); removeInvoice('${inv.id}')">Remove</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');

      // Total row - use billable amounts (allocation sums)
      const totalAmount = invoices.reduce((sum, inv) => {
        const allocationSum = (inv.allocations || []).reduce((s, a) => s + parseFloat(a.amount || 0), 0);
        return sum + (allocationSum > 0 ? allocationSum : parseFloat(inv.amount || 0));
      }, 0);
      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="4"><strong>Total (${invoices.length} invoice${invoices.length !== 1 ? 's' : ''})</strong></td>
          <td class="amount"><strong>${formatMoney(totalAmount)}</strong></td>
          <td></td>
        </tr>
      `;
    }

    function renderActivityLog(activities) {
      const container = document.getElementById('activityContainer');

      const actionLabels = {
        created: 'Draw created',
        invoice_added: 'Invoice added',
        invoice_removed: 'Invoice removed',
        submitted: 'Draw submitted',
        unsubmitted: 'Draw unsubmitted',
        funded: 'Draw funded'
      };

      if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="empty-state">No activity recorded</div>';
        return;
      }

      container.innerHTML = `
        <div class="activity-list">
          ${activities.map(act => {
            const details = act.details || {};
            let detailText = '';
            if (act.action === 'invoice_added' || act.action === 'invoice_removed') {
              detailText = details.invoice_number ? ` - ${details.invoice_number}` : '';
            } else if (act.action === 'funded') {
              detailText = details.funded_amount ? ` - ${formatMoney(details.funded_amount)}` : '';
            } else if (act.action === 'unsubmitted' && details.reason) {
              detailText = ` - "${details.reason}"`;
            }
            return `
              <div class="activity-item">
                <span class="activity-time">${formatDateTime(act.created_at)}</span>
                <span class="activity-action">${actionLabels[act.action] || act.action}${detailText}</span>
                <span class="activity-user">${act.performed_by || 'System'}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    // ============================================================
    // UNSUBMIT FUNCTIONALITY
    // ============================================================

    function unsubmitDraw() {
      if (!currentDraw || currentDraw.status !== 'submitted') return;
      document.getElementById('unsubmitReason').value = '';
      openModal('unsubmitModal');
    }

    async function confirmUnsubmit() {
      if (!currentDraw) return;

      const reason = document.getElementById('unsubmitReason').value.trim();

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/unsubmit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to unsubmit draw');
        }

        showToast('Draw returned to draft status', 'success');
        closeModal('unsubmitModal');
        openDraw(currentDraw.id); // Refresh the draw
        loadDraws();
      } catch (err) {
        console.error('Error unsubmitting draw:', err);
        showToast(err.message || 'Failed to unsubmit draw', 'error');
      }
    }

    function submitDraw() {
      if (!currentDraw) return;

      // Pre-fill period end date (existing value or today)
      const periodEndInput = document.getElementById('submitPeriodEnd');
      periodEndInput.value = currentDraw.period_end || new Date().toISOString().split('T')[0];

      // Show summary
      const invoiceCount = currentDraw.invoices?.length || 0;
      const totalAmount = parseFloat(currentDraw.total_amount || 0);

      // Build lien release warning if coverage is incomplete
      let lienWarningHtml = '';
      if (lienReleaseCoverage && !lienReleaseCoverage.is_complete) {
        const missingVendors = lienReleaseCoverage.missing_vendors || [];
        lienWarningHtml = `
          <div class="submit-warning">
            <div class="warning-header">
              <span class="warning-icon">‚ö†</span>
              <strong>Missing Lien Releases</strong>
            </div>
            <p>The following vendors have invoices in this draw but no lien release attached:</p>
            <ul class="warning-list">
              ${missingVendors.map(v => `<li>${v.vendor_name} (${formatMoney(v.total_amount)})</li>`).join('')}
            </ul>
            <p class="warning-note">You can still submit, but banks typically require lien releases from all vendors.</p>
          </div>
        `;
      }

      document.getElementById('submitDrawSummary').innerHTML = `
        ${lienWarningHtml}
        <div class="summary-stats">
          <div class="stat">
            <span class="stat-value">${invoiceCount}</span>
            <span class="stat-label">Invoice${invoiceCount !== 1 ? 's' : ''}</span>
          </div>
          <div class="stat">
            <span class="stat-value">${formatMoney(totalAmount)}</span>
            <span class="stat-label">Total Amount</span>
          </div>
          ${lienReleaseCoverage ? `
          <div class="stat ${lienReleaseCoverage.is_complete ? 'stat-success' : 'stat-warning'}">
            <span class="stat-value">${lienReleaseCoverage.coverage_percent}%</span>
            <span class="stat-label">Lien Coverage</span>
          </div>
          ` : ''}
        </div>
      `;

      openModal('submitDrawModal');
    }

    async function confirmSubmitDraw() {
      if (!currentDraw) return;

      const periodEnd = document.getElementById('submitPeriodEnd').value;
      if (!periodEnd) {
        showToast('Please enter a period end date', 'error');
        return;
      }

      try {
        // Update period end first if changed
        if (periodEnd !== currentDraw.period_end) {
          await fetch(`/api/draws/${currentDraw.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ period_end: periodEnd })
          });
        }

        // Submit the draw
        const res = await fetch(`/api/draws/${currentDraw.id}/submit`, { method: 'PATCH' });
        if (!res.ok) throw new Error('Failed to submit draw');

        showToast('Draw submitted successfully', 'success');
        closeModal('submitDrawModal');
        closeDrawModal();
        loadDraws();
      } catch (err) {
        console.error('Error submitting draw:', err);
        showToast('Failed to submit draw', 'error');
      }
    }

    function fundDraw() {
      if (!currentDraw) return;

      // Populate the fund draw modal
      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const formattedAmount = totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      document.getElementById('fundingSummary').innerHTML = `
        <div class="summary-row">
          <span class="summary-label">Draw Total (Billed):</span>
          <span class="summary-value">$${formattedAmount}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Invoices:</span>
          <span class="summary-value">${currentDraw.invoices?.length || 0}</span>
        </div>
      `;

      document.getElementById('fundedAmount').value = formattedAmount;
      document.getElementById('partialFundingNote').value = '';
      document.getElementById('partialNoteGroup').style.display = 'none';
      document.getElementById('fundingDifferenceHint').textContent = '';
      document.getElementById('fundingDifferenceHint').className = 'field-hint';

      openModal('fundDrawModal');
    }

    function updateFundingDifference() {
      if (!currentDraw) return;

      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const inputVal = document.getElementById('fundedAmount').value.replace(/[^0-9.-]/g, '');
      const fundedAmount = parseFloat(inputVal) || 0;
      const difference = fundedAmount - totalAmount;

      const hintEl = document.getElementById('fundingDifferenceHint');
      const noteGroup = document.getElementById('partialNoteGroup');

      if (Math.abs(difference) < 0.01) {
        hintEl.textContent = 'Full funding - matches billed amount';
        hintEl.className = 'field-hint text-success';
        noteGroup.style.display = 'none';
      } else if (difference < 0) {
        const shortfall = Math.abs(difference).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        hintEl.textContent = `Partial funding - ${shortfall} less than billed`;
        hintEl.className = 'field-hint text-warning';
        noteGroup.style.display = 'block';
      } else {
        const overage = difference.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        hintEl.textContent = `Overfunding - ${overage} more than billed (credit)`;
        hintEl.className = 'field-hint text-info';
        noteGroup.style.display = 'block';
      }
    }

    async function confirmFundDraw() {
      if (!currentDraw) return;

      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const inputVal = document.getElementById('fundedAmount').value.replace(/[^0-9.-]/g, '');
      const fundedAmount = parseFloat(inputVal) || 0;
      const difference = fundedAmount - totalAmount;
      const note = document.getElementById('partialFundingNote').value.trim();

      // Require note for non-matching amounts
      if (Math.abs(difference) >= 0.01 && !note) {
        showToast('Please provide a note explaining the funding difference', 'error');
        document.getElementById('partialFundingNote').focus();
        return;
      }

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/fund`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            funded_amount: fundedAmount,
            partial_funding_note: note || null
          })
        });

        if (!res.ok) throw new Error('Failed to fund draw');

        const result = await res.json();
        const statusLabel = result.status === 'partially_funded' ? 'partially funded' :
                           result.status === 'overfunded' ? 'overfunded' : 'funded';

        showToast(`Draw marked as ${statusLabel}`, 'success');
        closeModal('fundDrawModal');
        closeDrawModal();
        loadDraws();
      } catch (err) {
        console.error('Error funding draw:', err);
        showToast('Failed to fund draw', 'error');
      }
    }

    async function removeInvoice(invoiceId) {
      if (!currentDraw) return;

      if (!confirm('Remove this invoice from the draw?')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/remove-invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ invoice_id: invoiceId })
        });
        if (!res.ok) throw new Error('Failed to remove invoice');

        showToast('Invoice removed from draw', 'success');
        openDraw(currentDraw.id); // Refresh modal
        loadDraws(); // Refresh draw list to update amounts
      } catch (err) {
        console.error('Error removing invoice:', err);
        showToast('Failed to remove invoice', 'error');
      }
    }

    function showAddInvoiceModal() {
      showToast('Add invoice modal - coming soon', 'info');
    }

    async function showAddCOBillingModal() {
      if (!currentDraw) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/available-cos`);
        if (!res.ok) throw new Error('Failed to load available COs');

        const availableCOs = await res.json();

        if (availableCOs.length === 0) {
          showToast('No approved change orders available to bill', 'info');
          return;
        }

        // Populate the modal with available COs
        const container = document.getElementById('availableCOsList');
        container.innerHTML = availableCOs.map(co => {
          const remaining = parseFloat(co.amount) - parseFloat(co.billed_amount || 0);
          const percent = co.amount > 0 ? ((co.billed_amount || 0) / co.amount) * 100 : 0;

          return `
            <div class="co-billing-item" data-co-id="${co.id}">
              <div class="co-billing-info">
                <strong>CO-${String(co.change_order_number).padStart(3, '0')}: ${co.title}</strong>
                <div class="co-billing-details">
                  <span>Total: ${formatMoneyDecimal(co.amount)}</span>
                  <span>Billed: ${formatMoneyDecimal(co.billed_amount || 0)} (${percent.toFixed(1)}%)</span>
                  <span>Remaining: ${formatMoneyDecimal(remaining)}</span>
                </div>
              </div>
              <div class="co-billing-input">
                <label>Bill this period:</label>
                <input type="number" class="form-control co-amount-input"
                       data-co-id="${co.id}"
                       data-max="${remaining}"
                       min="0"
                       max="${remaining}"
                       step="0.01"
                       placeholder="0.00"
                       onchange="validateCOAmount(this)">
                <button class="btn btn-sm btn-outline" onclick="setCOAmountPercent('${co.id}', 100)">100%</button>
                <button class="btn btn-sm btn-outline" onclick="setCOAmountPercent('${co.id}', 50)">50%</button>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('addCOBillingModal').classList.add('show');
      } catch (err) {
        console.error('Error loading available COs:', err);
        showToast('Failed to load change orders', 'error');
      }
    }

    function validateCOAmount(input) {
      const max = parseFloat(input.dataset.max) || 0;
      const value = parseFloat(input.value) || 0;
      if (value > max) {
        input.value = max.toFixed(2);
        showToast('Amount cannot exceed remaining balance', 'warning');
      }
      if (value < 0) {
        input.value = '0.00';
      }
    }

    function setCOAmountPercent(coId, percent) {
      const input = document.querySelector(`.co-amount-input[data-co-id="${coId}"]`);
      if (input) {
        const max = parseFloat(input.dataset.max) || 0;
        input.value = (max * percent / 100).toFixed(2);
      }
    }

    async function saveCOBillings() {
      if (!currentDraw) return;

      const inputs = document.querySelectorAll('.co-amount-input');
      const billings = [];

      inputs.forEach(input => {
        const amount = parseFloat(input.value) || 0;
        if (amount > 0) {
          billings.push({
            changeOrderId: input.dataset.coId,
            amount: amount
          });
        }
      });

      if (billings.length === 0) {
        showToast('No amounts entered', 'warning');
        return;
      }

      try {
        for (const billing of billings) {
          const res = await fetch(`/api/draws/${currentDraw.id}/add-co-billing`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(billing)
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Failed to add CO billing');
          }
        }

        showToast(`Added ${billings.length} CO billing(s) to draw`, 'success');
        closeModal('addCOBillingModal');
        openDraw(currentDraw.id); // Refresh draw data
      } catch (err) {
        console.error('Error adding CO billings:', err);
        showToast(err.message || 'Failed to add CO billings', 'error');
      }
    }

    async function removeCOBilling(changeOrderId) {
      if (!currentDraw) return;
      if (!confirm('Remove this change order billing from the draw?')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/remove-co-billing/${changeOrderId}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to remove CO billing');
        }

        showToast('CO billing removed from draw', 'success');
        openDraw(currentDraw.id); // Refresh draw data
      } catch (err) {
        console.error('Error removing CO billing:', err);
        showToast(err.message || 'Failed to remove CO billing', 'error');
      }
    }

    async function exportExcel() {
      if (!currentDraw) return;
      window.open(`/api/draws/${currentDraw.id}/export/excel`, '_blank');
    }

    async function exportPDF() {
      if (!currentDraw) return;
      window.open(`/api/draws/${currentDraw.id}/export/pdf`, '_blank');
    }

    // ============================================================
    // AUTO-GENERATE DRAW
    // ============================================================

    let autoGenerateData = null;

    function showAutoGenerateModal() {
      const select = document.getElementById('autoGenerateJob');
      select.innerHTML = '<option value="">Select a job...</option>';
      state.jobs.forEach(job => {
        select.innerHTML += `<option value="${job.id}">${job.name}</option>`;
      });

      // Pre-select job if one is currently filtered
      if (state.currentJobFilter) {
        select.value = state.currentJobFilter;
        loadApprovedInvoices();
      } else {
        // Reset preview
        document.getElementById('autoGeneratePreview').style.display = 'none';
        document.getElementById('autoGenerateEmpty').style.display = 'none';
        document.getElementById('autoGenerateBtn').disabled = true;
        autoGenerateData = null;
      }

      document.getElementById('autoGenerateModal').classList.add('show');
    }

    async function loadApprovedInvoices() {
      const jobId = document.getElementById('autoGenerateJob').value;
      const preview = document.getElementById('autoGeneratePreview');
      const emptyMsg = document.getElementById('autoGenerateEmpty');
      const genBtn = document.getElementById('autoGenerateBtn');

      if (!jobId) {
        preview.style.display = 'none';
        emptyMsg.style.display = 'none';
        genBtn.disabled = true;
        autoGenerateData = null;
        return;
      }

      try {
        const res = await fetch(`/api/jobs/${jobId}/approved-unbilled-invoices`);
        if (!res.ok) throw new Error('Failed to fetch invoices');

        autoGenerateData = await res.json();
        autoGenerateData.jobId = jobId;

        if (autoGenerateData.invoice_count === 0) {
          preview.style.display = 'none';
          emptyMsg.style.display = 'block';
          genBtn.disabled = true;
          return;
        }

        // Show preview
        emptyMsg.style.display = 'none';
        preview.style.display = 'block';
        genBtn.disabled = false;

        document.getElementById('agInvoiceCount').textContent = autoGenerateData.invoice_count;
        document.getElementById('agTotalAmount').textContent = formatMoney(autoGenerateData.total_amount);

        // Show existing draft info if applicable
        const draftRow = document.getElementById('agExistingDraft');
        if (autoGenerateData.existing_draft) {
          draftRow.style.display = 'flex';
          document.getElementById('agDraftInfo').textContent =
            `Draw #${autoGenerateData.existing_draft.draw_number} (${formatMoney(autoGenerateData.existing_draft.total_amount || 0)})`;
          genBtn.textContent = 'Add to Existing Draft';
        } else {
          draftRow.style.display = 'none';
          genBtn.textContent = 'Create New Draw';
        }

        // Render invoice list
        const listContainer = document.getElementById('agInvoiceList');
        listContainer.innerHTML = autoGenerateData.invoices.map(inv => {
          const allocationSum = (inv.allocations || []).reduce((s, a) => s + parseFloat(a.amount || 0), 0);
          const amount = allocationSum > 0 ? allocationSum : parseFloat(inv.amount || 0);
          return `
            <div class="invoice-preview-item">
              <div class="inv-info">
                <span class="inv-vendor">${inv.vendor?.name || 'Unknown'}</span>
                <span class="inv-number">#${inv.invoice_number || 'N/A'}</span>
              </div>
              <span class="inv-amount">${formatMoney(amount)}</span>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error loading approved invoices:', err);
        showToast('Failed to load invoices', 'error');
        preview.style.display = 'none';
        emptyMsg.style.display = 'none';
        genBtn.disabled = true;
      }
    }

    async function executeAutoGenerate() {
      if (!autoGenerateData || autoGenerateData.invoice_count === 0) {
        showToast('No invoices to add to draw', 'error');
        return;
      }

      const genBtn = document.getElementById('autoGenerateBtn');
      genBtn.disabled = true;
      genBtn.textContent = 'Processing...';

      try {
        const res = await fetch(`/api/jobs/${autoGenerateData.jobId}/auto-generate-draw`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            invoice_ids: autoGenerateData.invoices.map(inv => inv.id),
            use_existing_draft: !!autoGenerateData.existing_draft
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to generate draw');
        }

        const result = await res.json();

        showToast(
          `Draw #${result.draw_number} ${result.created_new ? 'created' : 'updated'} with ${result.invoice_count} invoice${result.invoice_count !== 1 ? 's' : ''}`,
          'success'
        );

        closeModal('autoGenerateModal');
        loadDraws();

        // Open the new/updated draw
        openDraw(result.draw_id);

      } catch (err) {
        console.error('Error generating draw:', err);
        showToast(err.message || 'Failed to generate draw', 'error');
        genBtn.disabled = false;
        genBtn.textContent = autoGenerateData.existing_draft ? 'Add to Existing Draft' : 'Create New Draw';
      }
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    function formatMoney(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatMoneyDecimal(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // ============================================================
    // PDF VIEWER
    // ============================================================

    async function showInvoicePdf(invoice) {
      if (!invoice) return;

      // Store current invoice for "Open in new tab" button
      state.currentViewingInvoice = invoice;

      // Show loading state
      document.getElementById('pdfViewerLoading').style.display = 'flex';
      document.getElementById('pdfViewerFrame').style.display = 'none';
      document.getElementById('pdfViewerError').style.display = 'none';

      // Update header
      document.getElementById('pdfViewerTitle').textContent = `Invoice ${invoice.invoice_number || ''}`;
      document.getElementById('pdfViewerSubtitle').textContent = invoice.vendor?.name || 'Unknown Vendor';

      // Update status badge
      const statusClasses = {
        received: 'pending',
        needs_approval: 'pending',
        approved: 'approved',
        in_draw: 'in-progress',
        paid: 'approved',
        denied: 'denied'
      };
      const statusBadge = document.getElementById('pdfInvoiceStatus');
      statusBadge.className = `status-badge status-${statusClasses[invoice.status] || 'pending'}`;
      statusBadge.textContent = (invoice.status || '').replace('_', ' ');

      // Update footer info
      const allocSum = (invoice.allocations || []).reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
      document.getElementById('pdfInvoiceInfo').innerHTML = `
        <span><strong>Date:</strong> ${formatDate(invoice.invoice_date)}</span>
        <span><strong>Total:</strong> ${formatMoney(invoice.amount)}</span>
        <span><strong>Allocated:</strong> ${formatMoney(allocSum || invoice.amount)}</span>
      `;

      // Show modal
      document.getElementById('pdfViewerModal').classList.add('show');

      // Load PDF
      const pdfUrl = invoice.pdf_stamped_url || invoice.pdf_url;
      if (pdfUrl) {
        const iframe = document.getElementById('pdfViewerFrame');
        iframe.onload = () => {
          document.getElementById('pdfViewerLoading').style.display = 'none';
          iframe.style.display = 'block';
        };
        iframe.onerror = () => {
          document.getElementById('pdfViewerLoading').style.display = 'none';
          document.getElementById('pdfViewerError').style.display = 'block';
        };
        iframe.src = pdfUrl;

        // Fallback timeout
        setTimeout(() => {
          if (document.getElementById('pdfViewerLoading').style.display !== 'none') {
            document.getElementById('pdfViewerLoading').style.display = 'none';
            iframe.style.display = 'block';
          }
        }, 2000);
      } else {
        document.getElementById('pdfViewerLoading').style.display = 'none';
        document.getElementById('pdfViewerError').style.display = 'block';
      }
    }

    function openInvoiceInNewTab() {
      const invoice = state.currentViewingInvoice;
      if (invoice) {
        window.open(`index.html?invoice=${invoice.id}`, '_blank');
      }
    }

    function showToast(message, type = 'info') {
      if (window.Toast) {
        Toast.show(message, type);
      } else {
        console.log(`[${type}] ${message}`);
      }
    }

    // ============================================================
    // LIEN RELEASES SECTION
    // ============================================================

    let drawLienReleases = [];
    let lienReleaseCoverage = null;

    async function loadDrawLienReleases(drawId, drawStatus) {
      const container = document.getElementById('drawLienReleasesContainer');
      try {
        // Load both releases and coverage in parallel
        const [releasesRes, coverageRes] = await Promise.all([
          fetch(`/api/draws/${drawId}/lien-releases`),
          fetch(`/api/draws/${drawId}/lien-release-coverage`)
        ]);

        drawLienReleases = await releasesRes.json();
        lienReleaseCoverage = await coverageRes.json();

        renderDrawLienReleases(drawLienReleases, lienReleaseCoverage, drawStatus);
      } catch (err) {
        console.error('Failed to load lien releases:', err);
        container.innerHTML = '<div class="error-state">Failed to load lien releases</div>';
      }
    }

    function renderDrawLienReleases(releases, coverage, drawStatus) {
      const container = document.getElementById('drawLienReleasesContainer');

      // Build coverage status header
      let coverageHtml = '';
      if (coverage && coverage.total_vendors > 0) {
        const statusClass = coverage.is_complete ? 'coverage-complete' : 'coverage-incomplete';
        const statusIcon = coverage.is_complete ? '‚úì' : '‚ö†';

        coverageHtml = `
          <div class="lien-release-coverage ${statusClass}">
            <div class="coverage-header">
              <span class="coverage-icon">${statusIcon}</span>
              <span class="coverage-title">Vendor Coverage: ${coverage.coverage_percent}%</span>
              <span class="coverage-detail">(${coverage.vendors_with_release}/${coverage.total_vendors} vendors)</span>
            </div>
            ${!coverage.is_complete ? `
              <div class="coverage-missing">
                <strong>Missing lien releases from:</strong>
                <ul>
                  ${coverage.missing_vendors.map(v => `
                    <li>
                      <span class="vendor-name">${v.vendor_name}</span>
                      <span class="vendor-meta">${v.invoice_count} invoice(s) - ${formatMoney(v.total_amount)}</span>
                    </li>
                  `).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `;
      }

      // Build releases list
      let releasesHtml = '';
      if (!releases || releases.length === 0) {
        releasesHtml = '<div class="empty-state">No lien releases attached to this draw</div>';
      } else {
        releasesHtml = releases.map(lr => `
          <div class="lien-release-mini-item">
            <div class="lien-release-mini-info">
              <span class="lien-release-mini-vendor">${lr.vendor?.name || 'Unknown Vendor'}</span>
              <span class="lien-release-mini-meta">
                ${formatLienReleaseType(lr.release_type)}
                ${lr.amount ? ' - ' + formatMoney(lr.amount) : ''}
                ${lr.through_date ? ' - Through ' + formatDate(lr.through_date) : ''}
              </span>
            </div>
            <div class="lien-release-mini-actions">
              ${lr.pdf_url ? `<a href="${lr.pdf_url}" target="_blank" class="btn btn-sm btn-secondary">View PDF</a>` : ''}
              ${drawStatus === 'draft' ? `<button class="btn btn-sm btn-danger" onclick="detachLienRelease('${lr.id}')">Remove</button>` : ''}
            </div>
          </div>
        `).join('');
      }

      container.innerHTML = coverageHtml + releasesHtml;
    }

    function formatLienReleaseType(type) {
      const labels = {
        'conditional_progress': 'Conditional Progress',
        'unconditional_progress': 'Unconditional Progress',
        'conditional_final': 'Conditional Final',
        'unconditional_final': 'Unconditional Final'
      };
      return labels[type] || type;
    }

    async function showAttachLienReleaseModal() {
      if (!currentDraw) return;

      const container = document.getElementById('availableLienReleasesList');
      container.innerHTML = '<div class="loading">Loading available lien releases...</div>';
      openModal('attachLienReleaseModal');

      try {
        // Get lien releases for this job that are not attached to any draw
        const params = new URLSearchParams();
        if (currentDraw.job_id) params.append('job_id', currentDraw.job_id);

        const res = await fetch(`/api/lien-releases?${params.toString()}`);
        const releases = await res.json();

        // Filter out those already attached to a draw
        const available = releases.filter(lr => !lr.draw_id);

        if (available.length === 0) {
          container.innerHTML = '<div class="empty-state">No available lien releases for this job. Upload releases on the Lien Releases page first.</div>';
          return;
        }

        container.innerHTML = available.map(lr => `
          <label class="lien-release-picker-item">
            <input type="checkbox" value="${lr.id}" class="lien-release-checkbox">
            <div class="lien-release-picker-info">
              <span class="vendor">${lr.vendor?.name || 'Unknown Vendor'}</span>
              <span class="meta">
                ${formatLienReleaseType(lr.release_type)}
                ${lr.amount ? ' - ' + formatMoney(lr.amount) : ''}
                ${lr.through_date ? ' - Through ' + formatDate(lr.through_date) : ''}
              </span>
            </div>
          </label>
        `).join('');

      } catch (err) {
        console.error('Error loading lien releases:', err);
        container.innerHTML = '<div class="error-state">Failed to load lien releases</div>';
      }
    }

    async function confirmAttachLienReleases() {
      const checkboxes = document.querySelectorAll('.lien-release-checkbox:checked');
      const selectedIds = Array.from(checkboxes).map(cb => cb.value);

      if (selectedIds.length === 0) {
        showToast('Please select at least one lien release', 'error');
        return;
      }

      try {
        for (const id of selectedIds) {
          await fetch(`/api/lien-releases/${id}/attach-to-draw`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ draw_id: currentDraw.id, attached_by: 'User' })
          });
        }

        showToast(`${selectedIds.length} lien release(s) attached`, 'success');
        closeModal('attachLienReleaseModal');
        loadDrawLienReleases(currentDraw.id, currentDraw.status);
      } catch (err) {
        console.error('Error attaching lien releases:', err);
        showToast('Failed to attach lien releases', 'error');
      }
    }

    async function detachLienRelease(lienReleaseId) {
      if (!confirm('Remove this lien release from the draw?')) return;

      try {
        await fetch(`/api/lien-releases/${lienReleaseId}/detach-from-draw`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ detached_by: 'User' })
        });

        showToast('Lien release removed from draw', 'success');
        loadDrawLienReleases(currentDraw.id, currentDraw.status);
      } catch (err) {
        console.error('Error detaching lien release:', err);
        showToast('Failed to remove lien release', 'error');
      }
    }
  </script>
</body>
</html>






