<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Draws</title>
  <link rel="stylesheet" href="css/styles.css?v=20260112b">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-top">
        <div class="header-brand">
          <span class="brand-icon">üèóÔ∏è</span>
          <span class="brand-name">Ross Built</span>
        </div>
        <nav class="main-nav">
          <a href="index.html" class="main-nav-link active">Financial</a>
          <span class="main-nav-link disabled" title="Coming soon">Projects</span>
          <span class="main-nav-link disabled" title="Coming soon">Reports</span>
        </nav>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="showAutoGenerateModal()">Auto-Generate</button>
          <button class="btn btn-primary" onclick="showCreateDrawModal()">+ New Draw</button>
        </div>
      </div>
      <div class="header-sub">
        <nav class="sub-nav">
          <a href="index.html" class="sub-nav-link">Invoices</a>
          <a href="pos.html" class="sub-nav-link">Purchase Orders</a>
          <a href="draws.html" class="sub-nav-link active">Draws</a>
          <a href="budgets.html" class="sub-nav-link">Budgets</a>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Filters -->
      <div class="table-toolbar">
        <div class="filter-controls">
          <select id="statusFilter" class="form-control filter-select">
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="submitted">Submitted</option>
            <option value="funded">Funded</option>
          </select>
        </div>
        <div class="search-box">
          <input type="text" id="drawSearchInput" placeholder="Search draws..." class="form-control search-input">
          <button class="search-clear-btn" id="drawSearchClear" style="display: none;" onclick="clearDrawSearch()">&times;</button>
        </div>
      </div>

      <!-- Draw List -->
      <div class="draw-list" id="drawList">
        <div class="loading">Loading draws...</div>
      </div>
    </main>
  </div>

  <!-- Draw Detail Modal (Fullscreen - Single Page Layout) -->
  <div id="drawModal" class="modal modal-fullscreen-dark">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-group">
          <h2 id="drawModalTitle">Draw #1</h2>
          <span class="status-badge" id="drawModalStatus">Draft</span>
          <span class="lock-indicator" id="lockIndicator" style="display: none;" title="This draw is locked">üîí</span>
        </div>
        <div class="modal-header-actions">
          <button class="btn btn-primary" id="editDrawBtn" onclick="toggleEditMode()" style="display: none;">
            Edit Draw
          </button>
          <button class="btn btn-success" id="saveDrawBtn" onclick="saveDrawEdits()" style="display: none;">
            Save Changes
          </button>
          <button class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEditMode()" style="display: none;">
            Cancel
          </button>
          <button class="btn btn-secondary" onclick="exportExcel()" title="Export Excel">
            Export Excel
          </button>
          <button class="btn btn-secondary" onclick="exportPDF()" title="Export PDF">
            Export PDF
          </button>
          <button class="btn btn-secondary" onclick="window.print()" title="Print">
            Print
          </button>
          <button class="close-btn" onclick="closeDrawModal()">&times;</button>
        </div>
      </div>

      <div class="modal-body draw-modal-body draw-single-page">
        <!-- Status Workflow -->
        <section class="draw-section">
          <div class="status-workflow" id="statusWorkflow">
            <div class="workflow-step" id="workflowDraft">
              <div class="workflow-icon">
                <span class="workflow-dot"></span>
              </div>
              <div class="workflow-label">Draft</div>
              <div class="workflow-date" id="workflowDraftDate">-</div>
            </div>
            <div class="workflow-connector" id="workflowConnector1"></div>
            <div class="workflow-step" id="workflowSubmitted">
              <div class="workflow-icon">
                <span class="workflow-dot"></span>
              </div>
              <div class="workflow-label">Submitted</div>
              <div class="workflow-date" id="workflowSubmittedDate">-</div>
            </div>
            <div class="workflow-connector" id="workflowConnector2"></div>
            <div class="workflow-step" id="workflowFunded">
              <div class="workflow-icon">
                <span class="workflow-dot"></span>
              </div>
              <div class="workflow-label">Funded</div>
              <div class="workflow-date" id="workflowFundedDate">-</div>
            </div>
          </div>
        </section>

        <!-- Summary Header -->
        <section class="draw-section draw-summary-section">
          <div class="draw-summary-grid">
            <div class="summary-card">
              <div class="summary-label">Job</div>
              <div class="summary-value" id="summaryJob">-</div>
            </div>
            <div class="summary-card editable-card">
              <div class="summary-label">Application #</div>
              <div class="summary-value" id="summaryAppNum">-</div>
              <input type="number" class="edit-input" id="editAppNum" style="display: none;" min="1">
            </div>
            <div class="summary-card editable-card">
              <div class="summary-label">Period To</div>
              <div class="summary-value" id="summaryPeriod">-</div>
              <input type="date" class="edit-input" id="editPeriodTo" style="display: none;">
            </div>
            <div class="summary-card">
              <div class="summary-label">Invoice Count</div>
              <div class="summary-value" id="summaryInvCount">0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">This Period</div>
              <div class="summary-value" id="summaryThisPeriod">$0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">Current Payment Due</div>
              <div class="summary-value" id="summaryPaymentDue">$0</div>
            </div>
            <div class="summary-card funding-info" id="fundingInfoCard" style="display: none;">
              <div class="summary-label">Funded Amount</div>
              <div class="summary-value" id="summaryFundedAmount">$0</div>
              <div class="funding-note" id="summaryFundingNote"></div>
            </div>
          </div>
          <!-- Notes Section (shown in edit mode) -->
          <div class="draw-notes-section" id="drawNotesSection" style="display: none;">
            <label class="summary-label">Notes</label>
            <textarea class="edit-input" id="editNotes" rows="3" placeholder="Add notes about this draw..."></textarea>
          </div>
          <!-- Notes Display (shown in view mode) -->
          <div class="draw-notes-display" id="drawNotesDisplay" style="display: none;">
            <label class="summary-label">Notes</label>
            <div class="summary-value" id="summaryNotes">-</div>
          </div>
        </section>

        <!-- G702 Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>G702 - Application and Certificate for Payment</h3>
          </div>
          <div class="g702-container">
            <div class="g702-form">
              <div class="g702-section">
                <div class="g702-row">
                  <div class="g702-field">
                    <label>TO OWNER:</label>
                    <div class="g702-value" id="g702Owner">-</div>
                  </div>
                  <div class="g702-field">
                    <label>APPLICATION NO:</label>
                    <div class="g702-value" id="g702AppNo">-</div>
                  </div>
                </div>
                <div class="g702-row">
                  <div class="g702-field">
                    <label>PROJECT:</label>
                    <div class="g702-value" id="g702Project">-</div>
                  </div>
                  <div class="g702-field">
                    <label>PERIOD TO:</label>
                    <div class="g702-value" id="g702PeriodTo">-</div>
                  </div>
                </div>
                <div class="g702-row">
                  <div class="g702-field">
                    <label>FROM CONTRACTOR:</label>
                    <div class="g702-value">Ross Built Custom Homes</div>
                  </div>
                </div>
              </div>

              <table class="g702-table">
                <tbody>
                  <tr class="g702-editable-row">
                    <td class="g702-line-num">1.</td>
                    <td>ORIGINAL CONTRACT SUM</td>
                    <td class="g702-amount">
                      <span id="g702Line1">$0.00</span>
                      <input type="text" class="g702-edit-input" id="editG702Line1" style="display: none;" placeholder="0.00">
                      <span class="g702-override-badge" id="g702Line1Badge" style="display: none;">Override</span>
                    </td>
                  </tr>
                  <tr class="g702-editable-row">
                    <td class="g702-line-num">2.</td>
                    <td>Net change by Change Orders</td>
                    <td class="g702-amount">
                      <span id="g702Line2">$0.00</span>
                      <input type="text" class="g702-edit-input" id="editG702Line2" style="display: none;" placeholder="0.00">
                      <span class="g702-override-badge" id="g702Line2Badge" style="display: none;">Override</span>
                    </td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">3.</td>
                    <td>CONTRACT SUM TO DATE (Line 1 + 2)</td>
                    <td class="g702-amount" id="g702Line3">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">4.</td>
                    <td>TOTAL COMPLETED & STORED TO DATE</td>
                    <td class="g702-amount" id="g702Line4">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">5.</td>
                    <td>LESS PREVIOUS CERTIFICATES FOR PAYMENT</td>
                    <td class="g702-amount" id="g702Line5">$0.00</td>
                  </tr>
                  <tr class="g702-highlight">
                    <td class="g702-line-num">6.</td>
                    <td><strong>CURRENT PAYMENT DUE</strong> (Line 4 less Line 5)</td>
                    <td class="g702-amount" id="g702Line6">$0.00</td>
                  </tr>
                  <tr>
                    <td class="g702-line-num">7.</td>
                    <td>BALANCE TO FINISH (Line 3 less Line 4)</td>
                    <td class="g702-amount" id="g702Line7">$0.00</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <\!-- G703 Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>G703 - Schedule of Values</h3>
            <span class="section-subtitle">Budget vs Billings by Cost Code</span>
          </div>
          <div class="g703-container">
            <div class="g703-table-wrapper">
              <table class="g703-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Cost Code</th>
                    <th>Scheduled Value</th>
                    <th>Previous<br>Applications</th>
                    <th>This<br>Application</th>
                    <th>Total<br>Completed</th>
                    <th>%</th>
                    <th>Balance<br>to Finish</th>
                  </tr>
                </thead>
                <tbody id="g703Body">
                  <tr>
                    <td colspan="8" class="loading">Loading schedule of values...</td>
                  </tr>
                </tbody>
                <tfoot id="g703Footer">
                </tfoot>
              </table>
            </div>
          </div>
        </section>

        <!-- Change Order Billing Section -->
        <section class="draw-section" id="coBillingSection">
          <div class="section-header">
            <h3>Change Order Billings</h3>
            <button class="btn btn-primary btn-sm" id="addCOBillingBtn" onclick="showAddCOBillingModal()">+ Add CO Billing</button>
          </div>
          <div class="co-billing-container">
            <table class="g703-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Change Order</th>
                  <th>CO Amount</th>
                  <th>Days</th>
                  <th>Previous<br>Billings</th>
                  <th>This<br>Application</th>
                  <th>Total<br>Billed</th>
                  <th>%</th>
                  <th>Balance</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="coBillingBody">
                <tr>
                  <td colspan="10" class="empty-state">No change order billings in this draw</td>
                </tr>
              </tbody>
              <tfoot id="coBillingFooter">
              </tfoot>
            </table>
          </div>
        </section>

        <!-- Invoices Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Invoices in this Draw</h3>
            <span class="section-hint" id="invoicesSectionHint">Invoices are automatically added when approved</span>
          </div>
          <div class="invoices-container">
            <table class="invoices-table">
              <thead>
                <tr>
                  <th>Vendor</th>
                  <th>Invoice #</th>
                  <th>Date</th>
                  <th>Cost Codes</th>
                  <th>Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoicesBody">
                <tr>
                  <td colspan="6" class="loading">Loading invoices...</td>
                </tr>
              </tbody>
              <tfoot id="invoicesFooter">
              </tfoot>
            </table>
          </div>
        </section>

        <!-- Activity Log Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Activity Log</h3>
          </div>
          <div class="activity-container" id="activityContainer">
            <div class="empty-state">No activity recorded</div>
          </div>
        </section>
      </div>

      <div class="modal-footer" id="drawModalFooter">
        <button class="btn btn-secondary" onclick="closeDrawModal()">Close</button>
        <button class="btn btn-outline-warning" id="unsubmitDrawBtn" onclick="unsubmitDraw()" style="display:none;">Unsubmit</button>
        <button class="btn btn-warning" id="submitDrawBtn" onclick="submitDraw()">Submit Draw</button>
        <button class="btn btn-success" id="fundDrawBtn" onclick="fundDraw()" style="display:none;">Mark as Funded</button>
      </div>
    </div>
  </div>

  <!-- Create Draw Modal -->
  <div id="createDrawModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Create New Draw</h2>
        <button class="close-btn" onclick="closeModal('createDrawModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Job *</label>
          <select id="newDrawJob" class="form-control" required>
            <option value="">Select a job...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Period End Date</label>
          <input type="date" id="newDrawPeriodEnd" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('createDrawModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createDraw()">Create Draw</button>
      </div>
    </div>
  </div>

  <!-- Add CO Billing Modal -->
  <div id="addCOBillingModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Add Change Order Billings</h2>
        <button class="close-btn" onclick="closeModal('addCOBillingModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-description">Select change orders to bill on this draw. Enter the amount to bill for each.</p>
        <div id="availableCOsList" class="co-billing-list">
          <!-- Dynamic content populated by showAddCOBillingModal -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addCOBillingModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCOBillings()">Add to Draw</button>
      </div>
    </div>
  </div>

  <!-- Fund Draw Modal -->
  <div id="fundDrawModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Mark Draw as Funded</h2>
        <button class="close-btn" onclick="closeModal('fundDrawModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="funding-summary" id="fundingSummary">
          <!-- Populated dynamically -->
        </div>

        <div class="form-group">
          <label>Amount Funded *</label>
          <div class="input-with-prefix">
            <span class="input-prefix">$</span>
            <input type="text" id="fundedAmount" class="form-control" placeholder="0.00"
              oninput="updateFundingDifference()">
          </div>
          <div class="field-hint" id="fundingDifferenceHint"></div>
        </div>

        <div class="form-group" id="partialNoteGroup" style="display: none;">
          <label>Note (required for partial funding)</label>
          <textarea id="partialFundingNote" class="form-control" rows="2"
            placeholder="Explain why the funding differs from the billed amount..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('fundDrawModal')">Cancel</button>
        <button class="btn btn-success" id="confirmFundBtn" onclick="confirmFundDraw()">Confirm Funding</button>
      </div>
    </div>
  </div>

  <!-- Unsubmit Reason Modal -->
  <div id="unsubmitModal" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2>Unsubmit Draw</h2>
        <button class="close-btn" onclick="closeModal('unsubmitModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>This will return the draw to draft status, allowing changes to be made.</p>
        <div class="form-group">
          <label>Reason (optional)</label>
          <textarea id="unsubmitReason" class="form-control" rows="3" placeholder="Why is this draw being unsubmitted?"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('unsubmitModal')">Cancel</button>
        <button class="btn btn-warning" onclick="confirmUnsubmit()">Unsubmit Draw</button>
      </div>
    </div>
  </div>

  <!-- Auto-Generate Draw Modal -->
  <div id="autoGenerateModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Auto-Generate Draw</h2>
        <button class="close-btn" onclick="closeModal('autoGenerateModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Job *</label>
          <select id="autoGenerateJob" class="form-control" onchange="loadApprovedInvoices()">
            <option value="">Select a job...</option>
          </select>
        </div>
        <div id="autoGeneratePreview" class="auto-generate-preview" style="display: none;">
          <div class="auto-generate-summary">
            <div class="summary-row">
              <span class="label">Approved Invoices Ready:</span>
              <span class="value" id="agInvoiceCount">0</span>
            </div>
            <div class="summary-row">
              <span class="label">Total Amount:</span>
              <span class="value" id="agTotalAmount">$0.00</span>
            </div>
            <div class="summary-row existing-draft" id="agExistingDraft" style="display: none;">
              <span class="label">Existing Draft Draw:</span>
              <span class="value" id="agDraftInfo">-</span>
            </div>
          </div>
          <div class="invoice-preview-list" id="agInvoiceList">
            <!-- Invoice list populated dynamically -->
          </div>
        </div>
        <div id="autoGenerateEmpty" class="empty-state" style="display: none;">
          No approved invoices ready for this job.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('autoGenerateModal')">Cancel</button>
        <button class="btn btn-primary" id="autoGenerateBtn" onclick="executeAutoGenerate()" disabled>Generate Draw</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="js/toasts.js"></script>
  <script src="js/sidebar.js?v=20260112"></script>
  <script>
    // ============================================================
    // DRAWS PAGE - Single Page Layout
    // ============================================================

    let state = {
      draws: [],
      jobs: [],
      currentFilter: 'all',
      currentJobFilter: '',
      searchQuery: ''
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadJobs();
      loadDraws();
      setupFilters();
      setupDrawSearch();

      // Sidebar integration - listen for job selection changes
      if (window.JobSidebar) {
        window.JobSidebar.onJobChange((jobId) => {
          state.currentJobFilter = jobId;
          renderDrawList();
        });
      }
    });

    function setupDrawSearch() {
      const input = document.getElementById('drawSearchInput');
      const clearBtn = document.getElementById('drawSearchClear');
      let debounceTimer;

      if (!input) return;

      input.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          state.searchQuery = e.target.value;
          clearBtn.style.display = state.searchQuery ? 'block' : 'none';
          renderDrawList();
        }, 300);
      });
    }

    function clearDrawSearch() {
      const input = document.getElementById('drawSearchInput');
      const clearBtn = document.getElementById('drawSearchClear');
      if (input) input.value = '';
      state.searchQuery = '';
      clearBtn.style.display = 'none';
      renderDrawList();
    }

    async function loadJobs() {
      try {
        const res = await fetch('/api/jobs');
        state.jobs = await res.json();
      } catch (err) {
        console.error('Failed to load jobs:', err);
      }
    }

    async function loadDraws() {
      try {
        const jobsRes = await fetch('/api/jobs');
        const jobs = await jobsRes.json();

        let allDraws = [];
        for (const job of jobs) {
          const res = await fetch(`/api/jobs/${job.id}/draws`);
          const draws = await res.json();
          draws.forEach(d => d.job = job);
          allDraws = allDraws.concat(draws);
        }

        state.draws = allDraws.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        renderDrawList();
      } catch (err) {
        console.error('Failed to load draws:', err);
        document.getElementById('drawList').innerHTML = '<div class="empty-state">Failed to load draws</div>';
      }
    }

    function setupFilters() {
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', (e) => {
          state.currentFilter = e.target.value || 'all';
          renderDrawList();
        });
      }
    }

    function renderDrawList() {
      const container = document.getElementById('drawList');

      let filtered = state.draws;

      if (state.currentFilter !== 'all') {
        filtered = filtered.filter(d => d.status === state.currentFilter);
      }

      if (state.currentJobFilter) {
        filtered = filtered.filter(d => d.job_id === state.currentJobFilter);
      }

      // Search filter
      if (state.searchQuery) {
        const q = state.searchQuery.toLowerCase();
        filtered = filtered.filter(d =>
          (d.draw_number?.toString() || '').includes(q) ||
          (d.job?.name || '').toLowerCase().includes(q) ||
          (d.status || '').toLowerCase().includes(q) ||
          (d.total_amount?.toString() || '').includes(q)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No draws found</div>';
        return;
      }

      container.innerHTML = `
        <div class="draw-list-header">
          <div>Draw #</div>
          <div>Job</div>
          <div>Period End</div>
          <div>Status</div>
          <div>Amount</div>
          <div>Invoices</div>
        </div>
        ${filtered.map(draw => renderDrawRow(draw)).join('')}
      `;
    }

    function renderDrawRow(draw) {
      // Only 3 statuses: draft, submitted, funded
      const statusClass = {
        draft: 'pending',
        submitted: 'pending-approval',
        funded: 'approved'
      }[draw.status] || 'pending';

      const statusLabel = {
        draft: 'Draft',
        submitted: 'Submitted',
        funded: 'Funded'
      }[draw.status] || draw.status;

      // Funding variance indicator (shown next to status for funded draws)
      let fundingVariance = '';
      if (draw.status === 'funded' && draw.funding_difference) {
        const diff = parseFloat(draw.funding_difference);
        if (diff < -0.01) {
          fundingVariance = `<span class="funding-variance text-warning">-${formatMoney(Math.abs(diff))}</span>`;
        } else if (diff > 0.01) {
          fundingVariance = `<span class="funding-variance text-info">+${formatMoney(diff)}</span>`;
        }
      }

      // Count invoices from the nested data
      const invoiceCount = draw.invoices?.length || draw.invoice_count || 0;

      return `
        <div class="draw-row" onclick="openDraw('${draw.id}', '${draw.job_id}')">
          <div class="draw-number">Draw #${draw.draw_number}</div>
          <div class="draw-job">${draw.job?.name || 'Unknown'}</div>
          <div class="draw-date">${draw.period_end ? formatDate(draw.period_end) : '-'}</div>
          <div><span class="status-badge status-${statusClass}">${statusLabel}</span>${fundingVariance}</div>
          <div class="draw-amount">${formatMoney(draw.total_amount)}</div>
          <div class="draw-invoices">${invoiceCount}</div>
        </div>
      `;
    }

    let currentDraw = null;
    window.currentDraw = null;

    async function openDraw(drawId) {
      console.log('openDraw called with drawId:', drawId);
      try {
        const url = `/api/draws/${drawId}`;
        const res = await fetch(url);

        if (!res.ok) {
          const errorText = await res.text();
          console.error('API Error:', errorText);
          throw new Error(`Failed to fetch draw: ${res.status}`);
        }

        currentDraw = await res.json();
        window.currentDraw = currentDraw;

        renderDrawModal(currentDraw);
        document.getElementById('drawModal').classList.add('show');
      } catch (err) {
        console.error('Error opening draw:', err);
        showToast('Failed to load draw', 'error');
      }
    }

    let isEditMode = false;

    function updateStatusWorkflow(draw) {
      const draftStep = document.getElementById('workflowDraft');
      const submittedStep = document.getElementById('workflowSubmitted');
      const fundedStep = document.getElementById('workflowFunded');
      const connector1 = document.getElementById('workflowConnector1');
      const connector2 = document.getElementById('workflowConnector2');

      // Reset all
      [draftStep, submittedStep, fundedStep].forEach(step => {
        step.classList.remove('completed', 'current');
      });
      [connector1, connector2].forEach(conn => {
        conn.classList.remove('completed');
      });

      // Set dates
      document.getElementById('workflowDraftDate').textContent = draw.created_at ? formatDate(draw.created_at) : '-';
      document.getElementById('workflowSubmittedDate').textContent = draw.submitted_at ? formatDate(draw.submitted_at) : '-';
      document.getElementById('workflowFundedDate').textContent = draw.funded_at ? formatDate(draw.funded_at) : '-';

      // Set states based on current status
      if (draw.status === 'draft') {
        draftStep.classList.add('current');
      } else if (draw.status === 'submitted') {
        draftStep.classList.add('completed');
        connector1.classList.add('completed');
        submittedStep.classList.add('current');
      } else if (draw.status === 'funded') {
        draftStep.classList.add('completed');
        connector1.classList.add('completed');
        submittedStep.classList.add('completed');
        connector2.classList.add('completed');
        fundedStep.classList.add('current');
      }
    }

    function closeDrawModal() {
      document.getElementById('drawModal').classList.remove('show');
      currentDraw = null;
      isEditMode = false;
    }

    function toggleEditMode() {
      isEditMode = true;

      // Show edit inputs, hide display values
      document.getElementById('summaryAppNum').style.display = 'none';
      document.getElementById('summaryPeriod').style.display = 'none';
      document.getElementById('editAppNum').style.display = 'block';
      document.getElementById('editPeriodTo').style.display = 'block';

      // Populate edit inputs with current values
      document.getElementById('editAppNum').value = currentDraw.draw_number;
      document.getElementById('editPeriodTo').value = currentDraw.period_end ? currentDraw.period_end.split('T')[0] : '';
      document.getElementById('editNotes').value = currentDraw.notes || '';

      // Show notes edit section
      document.getElementById('drawNotesSection').style.display = 'block';
      document.getElementById('drawNotesDisplay').style.display = 'none';

      // Show G702 edit inputs
      document.getElementById('editG702Line1').style.display = 'inline-block';
      document.getElementById('editG702Line2').style.display = 'inline-block';

      // Populate G702 edit values (use override if set, otherwise calculated value)
      const contractSum = currentDraw.g702_original_contract_override ?? currentDraw.job?.contract_amount ?? 0;
      const changeOrders = currentDraw.g702_change_orders_override ?? currentDraw.changeOrderTotal ?? 0;
      document.getElementById('editG702Line1').value = parseFloat(contractSum).toFixed(2);
      document.getElementById('editG702Line2').value = parseFloat(changeOrders).toFixed(2);

      // Toggle buttons
      document.getElementById('editDrawBtn').style.display = 'none';
      document.getElementById('saveDrawBtn').style.display = 'inline-block';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
    }

    function cancelEditMode() {
      isEditMode = false;

      // Hide edit inputs, show display values
      document.getElementById('summaryAppNum').style.display = 'block';
      document.getElementById('summaryPeriod').style.display = 'block';
      document.getElementById('editAppNum').style.display = 'none';
      document.getElementById('editPeriodTo').style.display = 'none';

      // Hide notes edit, show display if has notes
      document.getElementById('drawNotesSection').style.display = 'none';
      if (currentDraw.notes) {
        document.getElementById('drawNotesDisplay').style.display = 'block';
      }

      // Hide G702 edit inputs
      document.getElementById('editG702Line1').style.display = 'none';
      document.getElementById('editG702Line2').style.display = 'none';

      // Toggle buttons
      document.getElementById('editDrawBtn').style.display = 'inline-block';
      document.getElementById('saveDrawBtn').style.display = 'none';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }

    async function saveDrawEdits() {
      // Parse G702 values (remove commas if present)
      const g702Line1 = parseFloat(document.getElementById('editG702Line1').value.replace(/,/g, '')) || 0;
      const g702Line2 = parseFloat(document.getElementById('editG702Line2').value.replace(/,/g, '')) || 0;

      const updates = {
        draw_number: parseInt(document.getElementById('editAppNum').value),
        period_end: document.getElementById('editPeriodTo').value,
        notes: document.getElementById('editNotes').value || null,
        g702_overrides: {
          original_contract_sum: g702Line1,
          net_change_orders: g702Line2
        }
      };

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || 'Failed to save');
        }

        showToast('Draw updated successfully', 'success');

        // Reload the draw
        await openDraw(currentDraw.id);
        cancelEditMode();
        loadDraws();
      } catch (err) {
        console.error('Error saving draw:', err);
        showToast(err.message || 'Failed to save draw', 'error');
      }
    }

    function renderDrawModal(draw) {
      // Modal header
      document.getElementById('drawModalTitle').textContent = `Draw #${draw.draw_number} - ${draw.job?.name || 'Unknown Job'}`;

      // Status badge - only 3 statuses: draft, submitted, funded
      const statusBadge = document.getElementById('drawModalStatus');
      const statusClass = { draft: 'pending', submitted: 'pending-approval', funded: 'approved' }[draw.status] || 'pending';
      const statusLabel = { draft: 'Draft', submitted: 'Submitted', funded: 'Funded' }[draw.status] || draw.status;
      statusBadge.className = `status-badge status-${statusClass}`;
      statusBadge.textContent = statusLabel;

      // Update status workflow
      updateStatusWorkflow(draw);

      // Summary section
      document.getElementById('summaryJob').textContent = draw.job?.name || '-';
      document.getElementById('summaryAppNum').textContent = draw.draw_number;
      document.getElementById('summaryPeriod').textContent = draw.period_end ? formatDate(draw.period_end) : '-';
      document.getElementById('summaryInvCount').textContent = draw.invoiceCount || 0;
      document.getElementById('summaryThisPeriod').textContent = formatMoney(draw.g702?.totalCompletedThisPeriod || 0);
      document.getElementById('summaryPaymentDue').textContent = formatMoney(draw.g702?.currentPaymentDue || 0);

      // Funding info (for funded draws)
      const fundingInfoCard = document.getElementById('fundingInfoCard');
      if (draw.status === 'funded') {
        fundingInfoCard.style.display = 'block';
        const fundedAmount = parseFloat(draw.funded_amount || 0);
        const billedAmount = parseFloat(draw.total_amount || 0);
        const diff = parseFloat(draw.funding_difference || 0);

        document.getElementById('summaryFundedAmount').textContent = formatMoney(fundedAmount);

        const noteEl = document.getElementById('summaryFundingNote');
        if (diff < -0.01) {
          // Partial payment - client paid less
          noteEl.innerHTML = `<span class="text-warning">Short ${formatMoney(Math.abs(diff))}</span>`;
          if (draw.partial_funding_note) {
            noteEl.innerHTML += `<br><small>${draw.partial_funding_note}</small>`;
          }
        } else if (diff > 0.01) {
          // Overpayment - client paid more (credit)
          noteEl.innerHTML = `<span class="text-info">Credit ${formatMoney(diff)}</span>`;
          if (draw.partial_funding_note) {
            noteEl.innerHTML += `<br><small>${draw.partial_funding_note}</small>`;
          }
        } else {
          noteEl.textContent = 'Paid in full';
        }
      } else {
        fundingInfoCard.style.display = 'none';
      }

      // G702 section
      document.getElementById('g702Owner').textContent = draw.job?.client_name || '-';
      document.getElementById('g702AppNo').textContent = draw.draw_number;
      document.getElementById('g702Project').textContent = draw.job?.name || '-';
      document.getElementById('g702PeriodTo').textContent = draw.period_end ? formatDate(draw.period_end) : '-';

      // G702 values - use overrides if set, otherwise use calculated values
      const hasContractOverride = draw.g702_original_contract_override !== null && draw.g702_original_contract_override !== undefined;
      const hasChangeOrderOverride = draw.g702_change_orders_override !== null && draw.g702_change_orders_override !== undefined;

      const contractSum = hasContractOverride ? parseFloat(draw.g702_original_contract_override) : (parseFloat(draw.job?.contract_amount) || 0);
      const changeOrders = hasChangeOrderOverride ? parseFloat(draw.g702_change_orders_override) : (draw.changeOrderTotal || 0);
      const contractSumToDate = contractSum + changeOrders;
      const totalCompleted = draw.g702?.grandTotal || 0;
      const previousCertificates = draw.g702?.lessPreviousCertificates || 0;
      const currentPaymentDue = draw.g702?.currentPaymentDue || 0;
      const balanceToFinish = contractSumToDate - totalCompleted;

      // Store for edit mode
      draw.g702_original_contract_override = hasContractOverride ? draw.g702_original_contract_override : null;
      draw.g702_change_orders_override = hasChangeOrderOverride ? draw.g702_change_orders_override : null;

      document.getElementById('g702Line1').textContent = formatMoneyDecimal(contractSum);
      document.getElementById('g702Line2').textContent = formatMoneyDecimal(changeOrders);
      document.getElementById('g702Line3').textContent = formatMoneyDecimal(contractSumToDate);
      document.getElementById('g702Line4').textContent = formatMoneyDecimal(totalCompleted);
      document.getElementById('g702Line5').textContent = formatMoneyDecimal(previousCertificates);
      document.getElementById('g702Line6').textContent = formatMoneyDecimal(currentPaymentDue);
      document.getElementById('g702Line7').textContent = formatMoneyDecimal(balanceToFinish);

      // Show override badges
      document.getElementById('g702Line1Badge').style.display = hasContractOverride ? 'inline-block' : 'none';
      document.getElementById('g702Line2Badge').style.display = hasChangeOrderOverride ? 'inline-block' : 'none';

      // G703 section
      renderG703Table(draw.scheduleOfValues || []);

      // CO Billing section
      renderCOBillingTable(draw.coScheduleOfValues || [], draw.status);

      // Invoices section
      renderInvoicesTable(draw.invoices || [], draw.status);

      // Activity log section
      renderActivityLog(draw.activity || []);

      // Lock indicator
      const lockIndicator = document.getElementById('lockIndicator');
      const isLocked = draw.status !== 'draft';
      lockIndicator.style.display = isLocked ? 'inline' : 'none';

      // Action buttons based on status
      const submitBtn = document.getElementById('submitDrawBtn');
      const fundBtn = document.getElementById('fundDrawBtn');
      const unsubmitBtn = document.getElementById('unsubmitDrawBtn');
      const addCOBillingBtn = document.getElementById('addCOBillingBtn');
      const isFunded = ['funded', 'partially_funded', 'overfunded'].includes(draw.status);

      // Edit button - only for draft status
      const editDrawBtn = document.getElementById('editDrawBtn');
      editDrawBtn.style.display = draw.status === 'draft' ? 'inline-block' : 'none';

      // Reset edit mode buttons
      document.getElementById('saveDrawBtn').style.display = 'none';
      document.getElementById('cancelEditBtn').style.display = 'none';

      // Notes display
      const notesDisplay = document.getElementById('drawNotesDisplay');
      const notesSection = document.getElementById('drawNotesSection');
      const summaryNotes = document.getElementById('summaryNotes');
      notesSection.style.display = 'none'; // Always hidden initially (shown in edit mode)
      if (draw.notes) {
        notesDisplay.style.display = 'block';
        summaryNotes.textContent = draw.notes;
      } else {
        notesDisplay.style.display = 'none';
      }

      if (draw.status === 'draft') {
        submitBtn.style.display = 'inline-block';
        fundBtn.style.display = 'none';
        unsubmitBtn.style.display = 'none';
        addCOBillingBtn.style.display = 'inline-block';
      } else if (draw.status === 'submitted') {
        submitBtn.style.display = 'none';
        fundBtn.style.display = 'inline-block';
        unsubmitBtn.style.display = 'inline-block';
        addCOBillingBtn.style.display = 'none';
      } else {
        // Funded draws - fully immutable
        submitBtn.style.display = 'none';
        fundBtn.style.display = 'none';
        unsubmitBtn.style.display = 'none';
        addCOBillingBtn.style.display = 'none';
      }
    }

    function renderG703Table(scheduleOfValues) {
      const tbody = document.getElementById('g703Body');
      const tfoot = document.getElementById('g703Footer');

      if (!scheduleOfValues || scheduleOfValues.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No billing data for this draw</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      tbody.innerHTML = scheduleOfValues.map(item => {
        const budget = item.budget || item.scheduledValue || 0;
        const previous = item.previousBilled || item.previousCompleted || 0;
        const current = item.currentBilled || item.thisPeriod || 0;
        const total = item.totalBilled || item.totalCompleted || 0;
        const balance = item.balance || 0;
        const balanceClass = balance < 0 ? 'over-budget' : '';

        return `
          <tr>
            <td>${item.item}</td>
            <td>${item.costCode} - ${item.description}</td>
            <td class="amount">${budget > 0 ? formatMoneyDecimal(budget) : '<span class="no-budget">No Budget</span>'}</td>
            <td class="amount">${formatMoneyDecimal(previous)}</td>
            <td class="amount highlight-current">${formatMoneyDecimal(current)}</td>
            <td class="amount">${formatMoneyDecimal(total)}</td>
            <td class="percent">${item.percentComplete.toFixed(1)}%</td>
            <td class="amount ${balanceClass}">${formatMoneyDecimal(balance)}</td>
          </tr>
        `;
      }).join('');

      // Totals row
      const totals = scheduleOfValues.reduce((acc, item) => ({
        budget: acc.budget + (item.budget || item.scheduledValue || 0),
        previous: acc.previous + (item.previousBilled || item.previousCompleted || 0),
        current: acc.current + (item.currentBilled || item.thisPeriod || 0),
        total: acc.total + (item.totalBilled || item.totalCompleted || 0),
        balance: acc.balance + (item.balance || 0)
      }), { budget: 0, previous: 0, current: 0, total: 0, balance: 0 });

      const overallPercent = totals.budget > 0 ? (totals.total / totals.budget) * 100 : (totals.total > 0 ? 100 : 0);

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td></td>
          <td><strong>GRAND TOTAL</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.budget)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.previous)}</strong></td>
          <td class="amount highlight-current"><strong>${formatMoneyDecimal(totals.current)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.total)}</strong></td>
          <td class="percent"><strong>${overallPercent.toFixed(1)}%</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.balance)}</strong></td>
        </tr>
      `;
    }

    function renderCOBillingTable(coScheduleOfValues, drawStatus) {
      const tbody = document.getElementById('coBillingBody');
      const tfoot = document.getElementById('coBillingFooter');
      const section = document.getElementById('coBillingSection');

      if (!coScheduleOfValues || coScheduleOfValues.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No change order billings in this draw</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      const isDraft = drawStatus === 'draft';

      tbody.innerHTML = coScheduleOfValues.map((item, idx) => {
        const coAmount = parseFloat(item.coAmount) || 0;
        const daysAdded = parseInt(item.daysAdded) || 0;
        const previous = parseFloat(item.previousBilled) || 0;
        const current = parseFloat(item.thisPeriod) || 0;
        const total = parseFloat(item.totalBilled) || 0;
        const balance = coAmount - total;
        const percent = coAmount > 0 ? (total / coAmount) * 100 : 0;

        const daysDisplay = daysAdded > 0 ? `+${daysAdded}` : daysAdded.toString();
        const daysColor = daysAdded > 0 ? 'var(--accent-orange)' : (daysAdded < 0 ? 'var(--accent-green)' : 'var(--text-secondary)');

        return `
          <tr>
            <td>${idx + 1}</td>
            <td>
              <strong>CO-${String(item.changeOrderNumber).padStart(3, '0')}</strong>
              <br><span class="text-muted">${item.title || ''}</span>
            </td>
            <td class="amount">${formatMoneyDecimal(coAmount)}</td>
            <td style="text-align: center; color: ${daysColor}; font-weight: 500;">${daysDisplay}</td>
            <td class="amount">${formatMoneyDecimal(previous)}</td>
            <td class="amount highlight-current">${formatMoneyDecimal(current)}</td>
            <td class="amount">${formatMoneyDecimal(total)}</td>
            <td class="percent">${percent.toFixed(1)}%</td>
            <td class="amount">${formatMoneyDecimal(balance)}</td>
            <td>
              ${isDraft && current > 0 ? `
                <button class="btn btn-sm btn-danger" onclick="removeCOBilling('${item.changeOrderId}')" title="Remove from draw">
                  <i class="fas fa-times"></i>
                </button>
              ` : '-'}
            </td>
          </tr>
        `;
      }).join('');

      // Totals row
      const totals = coScheduleOfValues.reduce((acc, item) => ({
        coAmount: acc.coAmount + (parseFloat(item.coAmount) || 0),
        days: acc.days + (parseInt(item.daysAdded) || 0),
        previous: acc.previous + (parseFloat(item.previousBilled) || 0),
        current: acc.current + (parseFloat(item.thisPeriod) || 0),
        total: acc.total + (parseFloat(item.totalBilled) || 0)
      }), { coAmount: 0, days: 0, previous: 0, current: 0, total: 0 });

      const overallPercent = totals.coAmount > 0 ? (totals.total / totals.coAmount) * 100 : 0;
      const totalBalance = totals.coAmount - totals.total;
      const totalDaysDisplay = totals.days > 0 ? `+${totals.days}` : totals.days.toString();

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td></td>
          <td><strong>CO TOTALS</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.coAmount)}</strong></td>
          <td style="text-align: center;"><strong>${totalDaysDisplay}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.previous)}</strong></td>
          <td class="amount highlight-current"><strong>${formatMoneyDecimal(totals.current)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.total)}</strong></td>
          <td class="percent"><strong>${overallPercent.toFixed(1)}%</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totalBalance)}</strong></td>
          <td></td>
        </tr>
      `;
    }

    function renderInvoicesTable(invoices, drawStatus) {
      const tbody = document.getElementById('invoicesBody');
      const tfoot = document.getElementById('invoicesFooter');
      const isDraft = drawStatus === 'draft';

      if (!invoices || invoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No invoices in this draw yet. Approve invoices to add them automatically.</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      // Helper to get billable amount (allocation sum or invoice amount)
      function getBillableAmount(inv) {
        const allocationSum = (inv.allocations || []).reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
        return allocationSum > 0 ? allocationSum : parseFloat(inv.amount || 0);
      }

      tbody.innerHTML = invoices.map(inv => {
        // Get cost codes from allocations
        const costCodes = inv.allocations?.map(a => a.cost_code?.code).filter(Boolean).join(', ') || '-';
        const billableAmount = getBillableAmount(inv);
        const isPartial = billableAmount < parseFloat(inv.amount || 0);

        return `
          <tr>
            <td>${inv.vendor?.name || 'Unknown'}</td>
            <td>${inv.invoice_number || '-'}${isPartial ? ' <span class="partial-badge">Partial</span>' : ''}</td>
            <td>${inv.invoice_date ? formatDate(inv.invoice_date) : '-'}</td>
            <td class="cost-codes">${costCodes}</td>
            <td class="amount">${formatMoney(billableAmount)}${isPartial ? `<br><small class="text-muted">of ${formatMoney(inv.amount)}</small>` : ''}</td>
            <td>
              ${isDraft ? `
                <button class="btn btn-sm btn-danger" onclick="removeInvoice('${inv.id}')">Remove</button>
              ` : ''}
              ${inv.pdf_stamped_url ? `
                <a href="${inv.pdf_stamped_url}" target="_blank" class="btn btn-sm btn-secondary">PDF</a>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');

      // Total row - use billable amounts (allocation sums)
      const totalAmount = invoices.reduce((sum, inv) => {
        const allocationSum = (inv.allocations || []).reduce((s, a) => s + parseFloat(a.amount || 0), 0);
        return sum + (allocationSum > 0 ? allocationSum : parseFloat(inv.amount || 0));
      }, 0);
      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="4"><strong>Total (${invoices.length} invoice${invoices.length !== 1 ? 's' : ''})</strong></td>
          <td class="amount"><strong>${formatMoney(totalAmount)}</strong></td>
          <td></td>
        </tr>
      `;
    }

    function renderActivityLog(activities) {
      const container = document.getElementById('activityContainer');

      const actionLabels = {
        created: 'Draw created',
        invoice_added: 'Invoice added',
        invoice_removed: 'Invoice removed',
        submitted: 'Draw submitted',
        unsubmitted: 'Draw unsubmitted',
        funded: 'Draw funded'
      };

      if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="empty-state">No activity recorded</div>';
        return;
      }

      container.innerHTML = `
        <div class="activity-list">
          ${activities.map(act => {
            const details = act.details || {};
            let detailText = '';
            if (act.action === 'invoice_added' || act.action === 'invoice_removed') {
              detailText = details.invoice_number ? ` - ${details.invoice_number}` : '';
            } else if (act.action === 'funded') {
              detailText = details.funded_amount ? ` - ${formatMoney(details.funded_amount)}` : '';
            } else if (act.action === 'unsubmitted' && details.reason) {
              detailText = ` - "${details.reason}"`;
            }
            return `
              <div class="activity-item">
                <span class="activity-time">${formatDateTime(act.created_at)}</span>
                <span class="activity-action">${actionLabels[act.action] || act.action}${detailText}</span>
                <span class="activity-user">${act.performed_by || 'System'}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    // ============================================================
    // UNSUBMIT FUNCTIONALITY
    // ============================================================

    function unsubmitDraw() {
      if (!currentDraw || currentDraw.status !== 'submitted') return;
      document.getElementById('unsubmitReason').value = '';
      openModal('unsubmitModal');
    }

    async function confirmUnsubmit() {
      if (!currentDraw) return;

      const reason = document.getElementById('unsubmitReason').value.trim();

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/unsubmit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to unsubmit draw');
        }

        showToast('Draw returned to draft status', 'success');
        closeModal('unsubmitModal');
        openDraw(currentDraw.id); // Refresh the draw
        loadDraws();
      } catch (err) {
        console.error('Error unsubmitting draw:', err);
        showToast(err.message || 'Failed to unsubmit draw', 'error');
      }
    }

    async function submitDraw() {
      if (!currentDraw) return;

      if (!confirm('Submit this draw? It will be locked from further changes.')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/submit`, { method: 'PATCH' });
        if (!res.ok) throw new Error('Failed to submit draw');

        showToast('Draw submitted successfully', 'success');
        closeDrawModal();
        loadDraws();
      } catch (err) {
        console.error('Error submitting draw:', err);
        showToast('Failed to submit draw', 'error');
      }
    }

    function fundDraw() {
      if (!currentDraw) return;

      // Populate the fund draw modal
      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const formattedAmount = totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      document.getElementById('fundingSummary').innerHTML = `
        <div class="summary-row">
          <span class="summary-label">Draw Total (Billed):</span>
          <span class="summary-value">$${formattedAmount}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Invoices:</span>
          <span class="summary-value">${currentDraw.invoices?.length || 0}</span>
        </div>
      `;

      document.getElementById('fundedAmount').value = formattedAmount;
      document.getElementById('partialFundingNote').value = '';
      document.getElementById('partialNoteGroup').style.display = 'none';
      document.getElementById('fundingDifferenceHint').textContent = '';
      document.getElementById('fundingDifferenceHint').className = 'field-hint';

      openModal('fundDrawModal');
    }

    function updateFundingDifference() {
      if (!currentDraw) return;

      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const inputVal = document.getElementById('fundedAmount').value.replace(/[^0-9.-]/g, '');
      const fundedAmount = parseFloat(inputVal) || 0;
      const difference = fundedAmount - totalAmount;

      const hintEl = document.getElementById('fundingDifferenceHint');
      const noteGroup = document.getElementById('partialNoteGroup');

      if (Math.abs(difference) < 0.01) {
        hintEl.textContent = 'Full funding - matches billed amount';
        hintEl.className = 'field-hint text-success';
        noteGroup.style.display = 'none';
      } else if (difference < 0) {
        const shortfall = Math.abs(difference).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        hintEl.textContent = `Partial funding - ${shortfall} less than billed`;
        hintEl.className = 'field-hint text-warning';
        noteGroup.style.display = 'block';
      } else {
        const overage = difference.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        hintEl.textContent = `Overfunding - ${overage} more than billed (credit)`;
        hintEl.className = 'field-hint text-info';
        noteGroup.style.display = 'block';
      }
    }

    async function confirmFundDraw() {
      if (!currentDraw) return;

      const totalAmount = parseFloat(currentDraw.total_amount || 0);
      const inputVal = document.getElementById('fundedAmount').value.replace(/[^0-9.-]/g, '');
      const fundedAmount = parseFloat(inputVal) || 0;
      const difference = fundedAmount - totalAmount;
      const note = document.getElementById('partialFundingNote').value.trim();

      // Require note for non-matching amounts
      if (Math.abs(difference) >= 0.01 && !note) {
        showToast('Please provide a note explaining the funding difference', 'error');
        document.getElementById('partialFundingNote').focus();
        return;
      }

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/fund`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            funded_amount: fundedAmount,
            partial_funding_note: note || null
          })
        });

        if (!res.ok) throw new Error('Failed to fund draw');

        const result = await res.json();
        const statusLabel = result.status === 'partially_funded' ? 'partially funded' :
                           result.status === 'overfunded' ? 'overfunded' : 'funded';

        showToast(`Draw marked as ${statusLabel}`, 'success');
        closeModal('fundDrawModal');
        closeDrawModal();
        loadDraws();
      } catch (err) {
        console.error('Error funding draw:', err);
        showToast('Failed to fund draw', 'error');
      }
    }

    async function removeInvoice(invoiceId) {
      if (!currentDraw) return;

      if (!confirm('Remove this invoice from the draw?')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/remove-invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ invoice_id: invoiceId })
        });
        if (!res.ok) throw new Error('Failed to remove invoice');

        showToast('Invoice removed from draw', 'success');
        openDraw(currentDraw.id); // Refresh modal
        loadDraws(); // Refresh draw list to update amounts
      } catch (err) {
        console.error('Error removing invoice:', err);
        showToast('Failed to remove invoice', 'error');
      }
    }

    function showAddInvoiceModal() {
      showToast('Add invoice modal - coming soon', 'info');
    }

    async function showAddCOBillingModal() {
      if (!currentDraw) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/available-cos`);
        if (!res.ok) throw new Error('Failed to load available COs');

        const availableCOs = await res.json();

        if (availableCOs.length === 0) {
          showToast('No approved change orders available to bill', 'info');
          return;
        }

        // Populate the modal with available COs
        const container = document.getElementById('availableCOsList');
        container.innerHTML = availableCOs.map(co => {
          const remaining = parseFloat(co.amount) - parseFloat(co.billed_amount || 0);
          const percent = co.amount > 0 ? ((co.billed_amount || 0) / co.amount) * 100 : 0;

          return `
            <div class="co-billing-item" data-co-id="${co.id}">
              <div class="co-billing-info">
                <strong>CO-${String(co.change_order_number).padStart(3, '0')}: ${co.title}</strong>
                <div class="co-billing-details">
                  <span>Total: ${formatMoneyDecimal(co.amount)}</span>
                  <span>Billed: ${formatMoneyDecimal(co.billed_amount || 0)} (${percent.toFixed(1)}%)</span>
                  <span>Remaining: ${formatMoneyDecimal(remaining)}</span>
                </div>
              </div>
              <div class="co-billing-input">
                <label>Bill this period:</label>
                <input type="number" class="form-control co-amount-input"
                       data-co-id="${co.id}"
                       data-max="${remaining}"
                       min="0"
                       max="${remaining}"
                       step="0.01"
                       placeholder="0.00"
                       onchange="validateCOAmount(this)">
                <button class="btn btn-sm btn-outline" onclick="setCOAmountPercent('${co.id}', 100)">100%</button>
                <button class="btn btn-sm btn-outline" onclick="setCOAmountPercent('${co.id}', 50)">50%</button>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('addCOBillingModal').classList.add('show');
      } catch (err) {
        console.error('Error loading available COs:', err);
        showToast('Failed to load change orders', 'error');
      }
    }

    function validateCOAmount(input) {
      const max = parseFloat(input.dataset.max) || 0;
      const value = parseFloat(input.value) || 0;
      if (value > max) {
        input.value = max.toFixed(2);
        showToast('Amount cannot exceed remaining balance', 'warning');
      }
      if (value < 0) {
        input.value = '0.00';
      }
    }

    function setCOAmountPercent(coId, percent) {
      const input = document.querySelector(`.co-amount-input[data-co-id="${coId}"]`);
      if (input) {
        const max = parseFloat(input.dataset.max) || 0;
        input.value = (max * percent / 100).toFixed(2);
      }
    }

    async function saveCOBillings() {
      if (!currentDraw) return;

      const inputs = document.querySelectorAll('.co-amount-input');
      const billings = [];

      inputs.forEach(input => {
        const amount = parseFloat(input.value) || 0;
        if (amount > 0) {
          billings.push({
            changeOrderId: input.dataset.coId,
            amount: amount
          });
        }
      });

      if (billings.length === 0) {
        showToast('No amounts entered', 'warning');
        return;
      }

      try {
        for (const billing of billings) {
          const res = await fetch(`/api/draws/${currentDraw.id}/add-co-billing`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(billing)
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Failed to add CO billing');
          }
        }

        showToast(`Added ${billings.length} CO billing(s) to draw`, 'success');
        closeModal('addCOBillingModal');
        openDraw(currentDraw.id); // Refresh draw data
      } catch (err) {
        console.error('Error adding CO billings:', err);
        showToast(err.message || 'Failed to add CO billings', 'error');
      }
    }

    async function removeCOBilling(changeOrderId) {
      if (!currentDraw) return;
      if (!confirm('Remove this change order billing from the draw?')) return;

      try {
        const res = await fetch(`/api/draws/${currentDraw.id}/remove-co-billing/${changeOrderId}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to remove CO billing');
        }

        showToast('CO billing removed from draw', 'success');
        openDraw(currentDraw.id); // Refresh draw data
      } catch (err) {
        console.error('Error removing CO billing:', err);
        showToast(err.message || 'Failed to remove CO billing', 'error');
      }
    }

    async function exportExcel() {
      if (!currentDraw) return;
      window.open(`/api/draws/${currentDraw.id}/export/excel`, '_blank');
    }

    async function exportPDF() {
      if (!currentDraw) return;
      window.open(`/api/draws/${currentDraw.id}/export/pdf`, '_blank');
    }

    function showCreateDrawModal() {
      const select = document.getElementById('newDrawJob');
      select.innerHTML = '<option value="">Select a job...</option>';
      state.jobs.forEach(job => {
        select.innerHTML += `<option value="${job.id}">${job.name}</option>`;
      });

      document.getElementById('newDrawPeriodEnd').value = new Date().toISOString().split('T')[0];
      document.getElementById('createDrawModal').classList.add('show');
    }

    // ============================================================
    // AUTO-GENERATE DRAW
    // ============================================================

    let autoGenerateData = null;

    function showAutoGenerateModal() {
      const select = document.getElementById('autoGenerateJob');
      select.innerHTML = '<option value="">Select a job...</option>';
      state.jobs.forEach(job => {
        select.innerHTML += `<option value="${job.id}">${job.name}</option>`;
      });

      // Pre-select job if one is currently filtered
      if (state.currentJobFilter) {
        select.value = state.currentJobFilter;
        loadApprovedInvoices();
      } else {
        // Reset preview
        document.getElementById('autoGeneratePreview').style.display = 'none';
        document.getElementById('autoGenerateEmpty').style.display = 'none';
        document.getElementById('autoGenerateBtn').disabled = true;
        autoGenerateData = null;
      }

      document.getElementById('autoGenerateModal').classList.add('show');
    }

    async function loadApprovedInvoices() {
      const jobId = document.getElementById('autoGenerateJob').value;
      const preview = document.getElementById('autoGeneratePreview');
      const emptyMsg = document.getElementById('autoGenerateEmpty');
      const genBtn = document.getElementById('autoGenerateBtn');

      if (!jobId) {
        preview.style.display = 'none';
        emptyMsg.style.display = 'none';
        genBtn.disabled = true;
        autoGenerateData = null;
        return;
      }

      try {
        const res = await fetch(`/api/jobs/${jobId}/approved-unbilled-invoices`);
        if (!res.ok) throw new Error('Failed to fetch invoices');

        autoGenerateData = await res.json();
        autoGenerateData.jobId = jobId;

        if (autoGenerateData.invoice_count === 0) {
          preview.style.display = 'none';
          emptyMsg.style.display = 'block';
          genBtn.disabled = true;
          return;
        }

        // Show preview
        emptyMsg.style.display = 'none';
        preview.style.display = 'block';
        genBtn.disabled = false;

        document.getElementById('agInvoiceCount').textContent = autoGenerateData.invoice_count;
        document.getElementById('agTotalAmount').textContent = formatMoney(autoGenerateData.total_amount);

        // Show existing draft info if applicable
        const draftRow = document.getElementById('agExistingDraft');
        if (autoGenerateData.existing_draft) {
          draftRow.style.display = 'flex';
          document.getElementById('agDraftInfo').textContent =
            `Draw #${autoGenerateData.existing_draft.draw_number} (${formatMoney(autoGenerateData.existing_draft.total_amount || 0)})`;
          genBtn.textContent = 'Add to Existing Draft';
        } else {
          draftRow.style.display = 'none';
          genBtn.textContent = 'Create New Draw';
        }

        // Render invoice list
        const listContainer = document.getElementById('agInvoiceList');
        listContainer.innerHTML = autoGenerateData.invoices.map(inv => {
          const allocationSum = (inv.allocations || []).reduce((s, a) => s + parseFloat(a.amount || 0), 0);
          const amount = allocationSum > 0 ? allocationSum : parseFloat(inv.amount || 0);
          return `
            <div class="invoice-preview-item">
              <div class="inv-info">
                <span class="inv-vendor">${inv.vendor?.name || 'Unknown'}</span>
                <span class="inv-number">#${inv.invoice_number || 'N/A'}</span>
              </div>
              <span class="inv-amount">${formatMoney(amount)}</span>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error loading approved invoices:', err);
        showToast('Failed to load invoices', 'error');
        preview.style.display = 'none';
        emptyMsg.style.display = 'none';
        genBtn.disabled = true;
      }
    }

    async function executeAutoGenerate() {
      if (!autoGenerateData || autoGenerateData.invoice_count === 0) {
        showToast('No invoices to add to draw', 'error');
        return;
      }

      const genBtn = document.getElementById('autoGenerateBtn');
      genBtn.disabled = true;
      genBtn.textContent = 'Processing...';

      try {
        const res = await fetch(`/api/jobs/${autoGenerateData.jobId}/auto-generate-draw`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            invoice_ids: autoGenerateData.invoices.map(inv => inv.id),
            use_existing_draft: !!autoGenerateData.existing_draft
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to generate draw');
        }

        const result = await res.json();

        showToast(
          `Draw #${result.draw_number} ${result.created_new ? 'created' : 'updated'} with ${result.invoice_count} invoice${result.invoice_count !== 1 ? 's' : ''}`,
          'success'
        );

        closeModal('autoGenerateModal');
        loadDraws();

        // Open the new/updated draw
        openDraw(result.draw_id);

      } catch (err) {
        console.error('Error generating draw:', err);
        showToast(err.message || 'Failed to generate draw', 'error');
        genBtn.disabled = false;
        genBtn.textContent = autoGenerateData.existing_draft ? 'Add to Existing Draft' : 'Create New Draw';
      }
    }

    async function createDraw() {
      const jobId = document.getElementById('newDrawJob').value;
      const periodEnd = document.getElementById('newDrawPeriodEnd').value;

      if (!jobId) {
        showToast('Please select a job', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/jobs/${jobId}/draws`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ period_end: periodEnd })
        });
        if (!res.ok) throw new Error('Failed to create draw');

        const newDraw = await res.json();
        showToast('Draw created successfully', 'success');
        closeModal('createDrawModal');
        loadDraws();
        openDraw(newDraw.id);
      } catch (err) {
        console.error('Error creating draw:', err);
        showToast('Failed to create draw', 'error');
      }
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    function formatMoney(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatMoneyDecimal(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function showToast(message, type = 'info') {
      if (window.Toast) {
        Toast.show(message, type);
      } else {
        console.log(`[${type}] ${message}`);
      }
    }
  </script>
</body>
</html>






