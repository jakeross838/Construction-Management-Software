<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Budgets</title>
  <link rel="stylesheet" href="css/styles.css?v=20260114">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-top">
        <div class="header-brand">
          <span class="brand-icon">üèóÔ∏è</span>
          <span class="brand-name">Ross Built</span>
        </div>
        <nav class="main-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showImportModal()">Import Budget</button>
        </div>
      </div>
      <div class="header-sub">
        <nav class="sub-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="app-body">
      <main class="main">
      <!-- Budget Content -->
      <div id="budgetContent">
        <div class="empty-state">Select a job from the sidebar to view budget</div>
      </div>

      <!-- Budget Detail (shown when job selected) -->
      <div id="budgetDetail" style="display: none;">
        <!-- Budget Header -->
        <div class="budget-page-header">
          <div class="budget-title-row">
            <h2 id="budgetPageTitle">Budget</h2>
            <div class="budget-actions">
              <button class="btn btn-secondary" onclick="exportBudgetExcel()">Export Excel</button>
              <button class="btn btn-secondary" onclick="window.print()">Print</button>
            </div>
          </div>
        </div>

        <!-- Contract Overview -->
        <section class="draw-section draw-summary-section">
          <div class="section-header">
            <h3>Contract</h3>
            <span class="section-badge" id="coCountBadge" style="display: none;">0 COs</span>
          </div>
          <div class="draw-summary-grid" style="grid-template-columns: repeat(2, 1fr);">
            <div class="summary-card">
              <div class="summary-label">Base Contract</div>
              <div class="summary-value" id="summaryBudget">$0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">Current Contract</div>
              <div class="summary-value" id="summaryTotalContract">$0</div>
              <div class="summary-hint" id="coSummaryHint"></div>
            </div>
          </div>
        </section>

        <!-- Base Budget Status -->
        <section class="draw-section draw-summary-section">
          <div class="section-header">
            <h3>Base Budget Status</h3>
            <span class="section-subtitle">Excludes change orders</span>
          </div>
          <div class="draw-summary-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div class="summary-card">
              <div class="summary-label">Drawn</div>
              <div class="summary-value" id="summaryBilled">$0</div>
              <div class="summary-hint">Billed to owner</div>
            </div>
            <div class="summary-card" id="projectedCard">
              <div class="summary-label">Projected Cost</div>
              <div class="summary-value" id="summaryProjected">$0</div>
              <div class="summary-hint">POs + invoices</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Budget Remaining</div>
              <div class="summary-value" id="summaryRemaining">$0</div>
              <div class="summary-hint">Not yet committed</div>
            </div>
          </div>
        </section>

        <!-- Budget Forecast -->
        <section class="draw-section draw-summary-section">
          <div class="section-header">
            <h3>Forecast</h3>
            <span class="section-subtitle">Variance from closed lines + open overages</span>
          </div>
          <div class="draw-summary-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="summary-card" id="coverageCard">
              <div class="summary-label">Closed</div>
              <div class="summary-value" id="summaryCoverage">0%</div>
              <div class="summary-hint" id="coverageHint">of budget closed</div>
            </div>
            <div class="summary-card highlight" id="projectedVarianceCard">
              <div class="summary-label">Projected Variance</div>
              <div class="summary-value" id="summaryProjectedVariance">$0</div>
              <div class="summary-hint">Under / over budget</div>
            </div>
            <div class="summary-card" id="confirmedSavingsCard">
              <div class="summary-label">Closed Variance</div>
              <div class="summary-value" id="summaryConfirmedSavings">$0</div>
              <div class="summary-hint">Locked in</div>
            </div>
            <div class="summary-card" id="potentialSavingsCard">
              <div class="summary-label">Open Overages</div>
              <div class="summary-value" id="summaryPotentialSavings">$0</div>
              <div class="summary-hint">Over budget on open lines</div>
            </div>
          </div>
        </section>

        <!-- Base Budget Lines Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Base Budget by Cost Code</h3>
            <span class="section-subtitle">Excludes change orders - shows live status including invoices awaiting approval</span>
            <div class="division-controls">
              <button onclick="toggleAllGroups(false)">Expand All</button>
              <button onclick="toggleAllGroups(true)">Collapse All</button>
            </div>
          </div>
          <div class="g703-container">
            <div class="g703-table-wrapper">
              <table class="g703-table budget-table">
                <thead>
                  <tr>
                    <th>Cost Code</th>
                    <th>Description</th>
                    <th>Budget</th>
                    <th>Billed</th>
                    <th>Projected</th>
                    <th>Status</th>
                    <th>% Complete</th>
                    <th>Variance</th>
                  </tr>
                </thead>
                <tbody id="budgetBody">
                  <tr>
                    <td colspan="8" class="loading">Loading budget...</td>
                  </tr>
                </tbody>
                <tfoot id="budgetFooter">
                </tfoot>
              </table>
            </div>
          </div>
        </section>

        <!-- Change Orders Section (PCCOs) -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Change Orders (PCCOs)</h3>
            <span class="section-subtitle">Contract modifications with owner - tracked separately from base budget</span>
            <div class="section-header-actions">
              <span class="section-badge" id="changeOrderCount">0 PCCOs</span>
              <button class="btn btn-sm btn-primary" onclick="showAddCOModal()">+ Add Change Order</button>
            </div>
          </div>
          <div class="invoices-container">
            <table class="invoices-table co-table">
              <thead>
                <tr>
                  <th style="width: 60px;">PCCO #</th>
                  <th>Description</th>
                  <th style="width: 100px;">Base Amount</th>
                  <th style="width: 80px;">GC Fee</th>
                  <th style="width: 100px;">Total</th>
                  <th style="width: 60px;">Days</th>
                  <th style="width: 80px;">Billed</th>
                  <th style="width: 80px;">Status</th>
                  <th style="width: 100px;">Actions</th>
                </tr>
              </thead>
              <tbody id="changeOrdersBody">
                <tr>
                  <td colspan="9" class="empty-state">No change orders</td>
                </tr>
              </tbody>
              <tfoot id="changeOrdersFooter">
              </tfoot>
            </table>
          </div>
        </section>
      </div>
    </main>
    </div>
  </div>

  <!-- Change Order Modal -->
  <div id="coModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2 id="coModalTitle">Add Change Order</h2>
        <button class="close-btn" onclick="closeModal('coModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="coEditId">
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label>PCCO Number *</label>
            <input type="number" id="coNumber" class="form-control" min="1" required>
          </div>
          <div class="form-group" style="flex: 1;">
            <label>First Billed on App #</label>
            <input type="number" id="coAppNumber" class="form-control" min="1">
          </div>
        </div>
        <div class="form-group">
          <label>Description *</label>
          <input type="text" id="coTitle" class="form-control" placeholder="e.g., Added helical piles near pool" required>
        </div>
        <div class="form-group">
          <label>Reason</label>
          <select id="coReason" class="form-control">
            <option value="scope_change">Scope Change</option>
            <option value="owner_request">Owner Request</option>
            <option value="unforeseen_conditions">Unforeseen Conditions</option>
            <option value="design_change">Design Change</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label>Base Amount *</label>
            <input type="number" id="coBaseAmount" class="form-control" step="0.01" min="0" required onchange="calculateCOTotal()">
          </div>
          <div class="form-group" style="flex: 0.7;">
            <label>GC Fee %</label>
            <input type="number" id="coGCFeePercent" class="form-control" step="0.1" value="20" onchange="calculateCOTotal()">
          </div>
          <div class="form-group" style="flex: 1;">
            <label>GC Fee Amount</label>
            <input type="number" id="coGCFeeAmount" class="form-control" step="0.01" readonly>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <label>Total Amount</label>
            <input type="text" id="coTotalAmount" class="form-control" readonly style="font-weight: bold; font-size: 1.1rem;">
          </div>
          <div class="form-group" style="flex: 1;">
            <label>Days Added *</label>
            <input type="number" id="coDaysAdded" class="form-control" value="0" required placeholder="0">
            <small class="form-hint">Schedule impact (can be 0 or negative)</small>
          </div>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="coStatus" class="form-control">
            <option value="draft">Draft</option>
            <option value="pending_approval">Pending Approval</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>

        <!-- Linked Invoices Section (only shown when editing) -->
        <div id="coInvoicesSection" style="display: none; margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
          <div class="section-header" style="margin-bottom: 0.5rem;">
            <h4 style="margin: 0;">Linked Invoices</h4>
            <button class="btn btn-sm btn-secondary" onclick="showLinkInvoiceModal()">+ Link Invoice</button>
          </div>
          <div id="coLinkedInvoices" class="linked-invoices-list">
            <div class="empty-state" style="padding: 0.5rem;">No invoices linked</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('coModal')">Cancel</button>
        <button class="btn btn-danger" id="coDeleteBtn" onclick="deleteChangeOrder()" style="display: none;">Delete</button>
        <button class="btn btn-primary" onclick="saveChangeOrder()">Save Change Order</button>
      </div>
    </div>
  </div>

  <!-- Link Invoice Modal -->
  <div id="linkInvoiceModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Link Invoice to Change Order</h2>
        <button class="close-btn" onclick="closeModal('linkInvoiceModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Invoice</label>
          <select id="linkInvoiceSelect" class="form-control">
            <option value="">Select an invoice...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount from this invoice for CO (optional)</label>
          <input type="number" id="linkInvoiceAmount" class="form-control" step="0.01" placeholder="Leave blank for full invoice amount">
          <small class="form-hint">If this invoice covers multiple COs, enter the portion for this CO</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('linkInvoiceModal')">Cancel</button>
        <button class="btn btn-primary" onclick="linkInvoice()">Link Invoice</button>
      </div>
    </div>
  </div>

  <!-- Import Budget Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Import Budget from Excel</h2>
        <button class="close-btn" onclick="closeModal('importModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Job *</label>
          <select id="importJob" class="form-control" required>
            <option value="">Select a job...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Excel File (.xlsx, .xls)</label>
          <input type="file" id="importFile" class="form-control" accept=".xlsx,.xls">
          <small class="form-hint">Upload a G703 format budget spreadsheet</small>
        </div>
        <div id="importPreview" class="import-preview" style="display: none;">
          <h4>Preview</h4>
          <div id="previewContent"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
        <button class="btn btn-primary" onclick="importBudget()" id="importBtn" disabled>Import Budget</button>
      </div>
    </div>
  </div>

  <!-- Cost Code Detail Modal -->
  <div id="costCodeDetailModal" class="modal modal-fullscreen-dark">
    <div class="modal-content" style="max-width: 900px; max-height: 85vh;">
      <div class="modal-header">
        <div>
          <h2 id="ccDetailTitle">Cost Code Details</h2>
          <p id="ccDetailSubtitle" class="modal-subtitle" style="margin: 0; color: var(--text-secondary);"></p>
        </div>
        <button class="close-btn" onclick="closeModal('costCodeDetailModal')">&times;</button>
      </div>
      <div class="modal-body" style="overflow-y: auto;">
        <!-- Summary Cards -->
        <div class="cc-detail-summary" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="summary-card">
            <div class="summary-label">Budget</div>
            <div class="summary-value" id="ccBudget">$0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Committed</div>
            <div class="summary-value" id="ccCommitted">$0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Billed</div>
            <div class="summary-value" id="ccBilled">$0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Paid</div>
            <div class="summary-value" id="ccPaid">$0</div>
          </div>
          <div class="summary-card" id="ccRemainingCard">
            <div class="summary-label">Remaining</div>
            <div class="summary-value" id="ccRemaining">$0</div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs" style="margin-bottom: 1rem;">
          <button class="tab active" data-tab="cc-invoices" onclick="switchCCTab('cc-invoices')">Invoices</button>
          <button class="tab" data-tab="cc-pos" onclick="switchCCTab('cc-pos')">Purchase Orders</button>
        </div>

        <!-- Invoices Tab -->
        <div id="tab-cc-invoices" class="tab-content active">
          <table class="invoices-table">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Vendor</th>
                <th>Date</th>
                <th>Allocated</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="ccInvoicesBody">
              <tr><td colspan="5" class="empty-state">No invoices</td></tr>
            </tbody>
            <tfoot id="ccInvoicesFooter"></tfoot>
          </table>
        </div>

        <!-- Purchase Orders Tab -->
        <div id="tab-cc-pos" class="tab-content" style="display: none;">
          <table class="invoices-table">
            <thead>
              <tr>
                <th>PO #</th>
                <th>Vendor</th>
                <th>Line Item</th>
                <th>Amount</th>
                <th>Invoiced</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="ccPOsBody">
              <tr><td colspan="6" class="empty-state">No purchase orders</td></tr>
            </tbody>
            <tfoot id="ccPOsFooter"></tfoot>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div id="ccCloseoutActions" style="display: flex; gap: 0.5rem;">
          <button id="btnCloseoutLine" class="btn btn-primary" onclick="closeOutBudgetLine()" style="display: none;">
            Close Out Line
          </button>
          <button id="btnReopenLine" class="btn btn-secondary" onclick="reopenBudgetLine()" style="display: none;">
            Reopen Line
          </button>
        </div>
        <button class="btn btn-secondary" onclick="closeModal('costCodeDetailModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Invoice PDF Viewer Modal -->
  <div id="pdfViewerModal" class="modal modal-fullscreen-dark">
    <div class="modal-content" style="max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
      <div class="modal-header">
        <div>
          <h2 id="pdfViewerTitle">Invoice</h2>
          <p id="pdfViewerSubtitle" class="modal-subtitle" style="margin: 0; color: var(--text-secondary);"></p>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <span id="pdfInvoiceStatus" class="status-badge"></span>
          <button class="btn btn-secondary" onclick="openInvoiceInNewTab()" title="Open in new tab">Open Full Page</button>
          <button class="close-btn" onclick="closeModal('pdfViewerModal')">&times;</button>
        </div>
      </div>
      <div class="modal-body" style="flex: 1; padding: 0; overflow: hidden;">
        <div id="pdfViewerLoading" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
          <span class="loading">Loading PDF...</span>
        </div>
        <iframe id="pdfViewerFrame" style="width: 100%; height: 100%; border: none; display: none;"></iframe>
        <div id="pdfViewerError" style="display: none; padding: 2rem; text-align: center; color: var(--text-secondary);">
          <p>Unable to load PDF</p>
          <button class="btn btn-primary" onclick="openInvoiceInNewTab()">Open Invoice Page</button>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 0.75rem 1.5rem;">
        <div id="pdfInvoiceInfo" style="display: flex; gap: 2rem; font-size: 0.9rem; color: var(--text-secondary);"></div>
        <button class="btn btn-secondary" onclick="closeModal('pdfViewerModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="js/toasts.js"></script>
  <script src="js/nav-sidebar.js?v=20260114"></script>
  <script src="js/sidebar.js?v=20260114"></script>
  <script>
    // ============================================================
    // BUDGETS PAGE - Live Budget View
    // ============================================================

    let state = {
      jobs: [],
      currentJob: null,
      budgetData: null,
      pendingHighlightCostCode: null
    };

    document.addEventListener('DOMContentLoaded', async () => {
      setupEventListeners();

      // Load jobs first, then setup sidebar listener
      await loadJobs();

      // Check for costCode query parameter (deep linking from reconciliation, etc.)
      const urlParams = new URLSearchParams(window.location.search);
      const costCodeParam = urlParams.get('costCode');
      if (costCodeParam) {
        state.pendingHighlightCostCode = costCodeParam;
        // Clear the URL param
        window.history.replaceState({}, '', window.location.pathname);
      }

      // Sidebar integration - listen for job selection changes
      if (window.JobSidebar) {
        window.JobSidebar.onJobChange((jobId) => {
          if (jobId) {
            loadBudget(jobId);
          } else {
            // "All Jobs" selected - show selection prompt, hide budget detail
            document.getElementById('budgetContent').style.display = 'block';
            document.getElementById('budgetContent').innerHTML = '<div class="empty-state">Select a job from the sidebar to view budget</div>';
            document.getElementById('budgetDetail').style.display = 'none';
            state.currentJob = null;
            state.budgetData = null;
          }
        });
      }
    });

    async function loadJobs() {
      try {
        const res = await fetch('/api/jobs');
        state.jobs = await res.json();

        // Populate import modal job selector
        const importSelect = document.getElementById('importJob');
        importSelect.innerHTML = '<option value="">Select a job...</option>';
        state.jobs.forEach(job => {
          importSelect.innerHTML += `<option value="${job.id}">${job.name}</option>`;
        });
      } catch (err) {
        console.error('Failed to load jobs:', err);
      }
    }

    function setupEventListeners() {
      document.getElementById('importFile').addEventListener('change', handleFileSelect);
    }

    async function loadBudget(jobId) {
      try {
        // Show loading state
        document.getElementById('budgetContent').style.display = 'none';
        document.getElementById('budgetDetail').style.display = 'block';
        document.getElementById('budgetBody').innerHTML = '<tr><td colspan="9" class="loading">Loading budget...</td></tr>';

        // Fetch budget data
        const res = await fetch(`/api/jobs/${jobId}/budget-summary`);
        if (!res.ok) throw new Error('Failed to fetch budget');

        state.budgetData = await res.json();

        // Get job from response or state
        state.currentJob = state.budgetData.job || state.jobs.find(j => j.id === jobId);

        // Render budget inline
        renderBudget();
      } catch (err) {
        console.error('Error loading budget:', err);
        showToast('Failed to load budget', 'error');
        // Show error state
        document.getElementById('budgetBody').innerHTML = '<tr><td colspan="9" class="empty-state">Failed to load budget. Please try again.</td></tr>';
      }
    }

    function renderBudget() {
      const data = state.budgetData;
      const job = state.currentJob;

      // Header
      document.getElementById('budgetPageTitle').textContent = `Budget - ${job?.name || 'Unknown Job'}`;

      // Contract Overview
      const baseBudget = data.totals.budgeted;
      const changeOrderTotal = data.totals.changeOrderTotal || 0;
      const totalContract = baseBudget + changeOrderTotal;
      const coCount = (data.jobChangeOrders || []).filter(co => co.status === 'approved').length;

      document.getElementById('summaryBudget').textContent = formatMoney(baseBudget);
      document.getElementById('summaryTotalContract').textContent = formatMoney(totalContract);

      // Show CO count badge and hint if there are approved COs
      const coBadge = document.getElementById('coCountBadge');
      const coHint = document.getElementById('coSummaryHint');
      if (coCount > 0) {
        coBadge.textContent = `${coCount} CO${coCount !== 1 ? 's' : ''}`;
        coBadge.style.display = 'inline-block';
        coHint.textContent = `+${formatMoney(changeOrderTotal)} in COs`;
      } else {
        coBadge.style.display = 'none';
        coHint.textContent = '';
      }

      // Base Budget Status (excludes change orders)
      // Projected = Committed + In Review
      const committed = data.totals.committed || 0;
      const inReview = data.totals.pending || 0;
      const projected = committed + inReview;
      const budgetRemaining = baseBudget - projected; // What's not yet committed

      document.getElementById('summaryBilled').textContent = formatMoney(data.totals.billed || 0);
      document.getElementById('summaryProjected').textContent = formatMoney(projected);
      document.getElementById('summaryRemaining').textContent = formatMoney(budgetRemaining);

      // Calculate variance:
      // - Closed lines: actual variance (under or over)
      // - Open lines: only count overages (committed > budget)
      // Underages only recognized when line is closed
      let closedVariance = 0;  // Net variance from closed lines (+ = under, - = over)
      let openOverages = 0;    // Amount over budget on open lines

      (data.lines || []).forEach(line => {
        const budgeted = line.budgeted || 0;
        const lineCommitted = (line.committed || 0) + (line.pending || 0);
        const variance = budgeted - lineCommitted;

        if (line.closedAt) {
          // Closed line - count the variance (under or over)
          closedVariance += variance;
        } else if (lineCommitted > budgeted) {
          // Open line but already over budget - count the overage
          openOverages += Math.abs(variance);
        }
        // Open lines at or under budget: assume full budget spend (no variance to count)
      });

      // Coverage = % of budget that is closed (where we know final cost)
      const closedPercent = data.totals.budgeted > 0
        ? ((data.totals.budgetClosed || 0) / data.totals.budgeted) * 100
        : 0;
      document.getElementById('summaryCoverage').textContent = `${closedPercent.toFixed(0)}%`;
      document.getElementById('coverageHint').textContent = 'of budget closed';

      // Style coverage card
      const coverageCard = document.getElementById('coverageCard');
      coverageCard.className = 'summary-card';

      // Total projected variance = closed variance - open overages
      const totalVariance = closedVariance - openOverages;
      document.getElementById('summaryProjectedVariance').textContent = formatMoney(totalVariance);
      const varianceCard = document.getElementById('projectedVarianceCard');
      if (totalVariance < 0) {
        varianceCard.className = 'summary-card highlight over-budget';
      } else if (totalVariance > 0) {
        varianceCard.className = 'summary-card highlight under-budget';
      } else {
        varianceCard.className = 'summary-card highlight';
      }

      // Closed variance (net under/over from closed lines)
      document.getElementById('summaryConfirmedSavings').textContent = formatMoney(closedVariance);
      document.getElementById('confirmedSavingsCard').className = closedVariance > 0 ? 'summary-card under-budget' : (closedVariance < 0 ? 'summary-card over-budget' : 'summary-card');

      // Open overages (amount over budget on open lines)
      document.getElementById('summaryPotentialSavings').textContent = formatMoney(openOverages > 0 ? -openOverages : 0);
      document.getElementById('potentialSavingsCard').className = openOverages > 0 ? 'summary-card over-budget' : 'summary-card';

      // Budget lines table
      renderBudgetTable(data.lines);

      // Change orders (PCCOs - job change orders)
      renderChangeOrders(data.jobChangeOrders || []);
    }

    // Category sort order - follows construction flow, General Conditions at bottom
    const CATEGORY_ORDER = [
      'Pre-Construction & Design',
      'Permits & Fees',
      'Site Work',
      'Foundation',
      'Framing & Structure',
      'Roofing',
      'Windows & Doors',
      'Plumbing',
      'Electrical & Low Voltage',
      'HVAC',
      'Gas',
      'Fireplace',
      'Insulation',
      'Drywall & Ceilings',
      'Exterior Finishes',
      'Painting',
      'Flooring & Tile',
      'Cabinetry & Countertops',
      'Interior Trim & Doors',
      'Appliances',
      'Hardware & Accessories',
      'Glass & Mirrors',
      'Closets',
      'Garage Doors',
      'Specialty Items',
      'Outdoor & Pool',
      'Landscaping & Hardscape',
      // General Conditions at bottom
      'General Conditions'
    ];

    // Track collapsed groups
    let collapsedGroups = new Set();

    function toggleGroup(groupName) {
      if (collapsedGroups.has(groupName)) {
        collapsedGroups.delete(groupName);
      } else {
        collapsedGroups.add(groupName);
      }
      renderBudgetTable(state.budgetData?.lines || []);
    }

    function toggleAllGroups(collapse) {
      if (collapse) {
        CATEGORY_ORDER.forEach(cat => collapsedGroups.add(cat));
      } else {
        collapsedGroups.clear();
      }
      renderBudgetTable(state.budgetData?.lines || []);
    }

    function renderBudgetTable(lines) {
      const tbody = document.getElementById('budgetBody');
      const tfoot = document.getElementById('budgetFooter');

      if (!lines || lines.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No budget lines found. Import a budget to get started.</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      // Filter out lines with no cost code (orphan allocations)
      const validLines = lines.filter(line => line.costCode && line.costCode.trim() !== '');

      // Group by category
      const groupedLines = {};
      validLines.forEach(line => {
        const category = line.category || 'Uncategorized';
        if (!groupedLines[category]) {
          groupedLines[category] = [];
        }
        groupedLines[category].push(line);
      });

      // Sort each group by cost code
      Object.values(groupedLines).forEach(group => {
        group.sort((a, b) => (a.costCode || '').localeCompare(b.costCode || ''));
      });

      // Sort categories by defined order
      const sortedCategories = Object.keys(groupedLines).sort((a, b) => {
        const aIdx = CATEGORY_ORDER.indexOf(a);
        const bIdx = CATEGORY_ORDER.indexOf(b);
        // If not in list, put at end (before General Conditions)
        const aOrder = aIdx === -1 ? CATEGORY_ORDER.length - 3 : aIdx;
        const bOrder = bIdx === -1 ? CATEGORY_ORDER.length - 3 : bIdx;
        return aOrder - bOrder;
      });

      // Render grouped table
      let html = '';
      sortedCategories.forEach(category => {
        const catLines = groupedLines[category];
        const isCollapsed = collapsedGroups.has(category);

        // Calculate category totals
        const catTotals = catLines.reduce((acc, line) => ({
          budgeted: acc.budgeted + (line.budgeted || 0),
          billed: acc.billed + (line.billed || 0),
          projected: acc.projected + (line.committed || 0) + (line.pending || 0)
        }), { budgeted: 0, billed: 0, projected: 0 });

        // Projected = Committed + In Review (what we're tracking to spend)
        const catProjected = catTotals.projected;
        // % Complete = Billed / Budget (actual progress)
        const catPercentComplete = catTotals.budgeted > 0 ? (catTotals.billed / catTotals.budgeted) * 100 : 0;
        // Variance = Budget - Projected (positive = savings, negative = over)
        const catVariance = catTotals.budgeted - catProjected;
        const catPercentProjected = catTotals.budgeted > 0 ? (catProjected / catTotals.budgeted) * 100 : 0;
        const catHealthClass = catVariance < 0 ? 'budget-over' : (catPercentProjected >= 80 ? 'budget-warning' : '');

        // Count closed lines in category
        const closedCount = catLines.filter(l => l.closedAt).length;
        const openCount = catLines.length - closedCount;

        // Category header row - escape quotes for onclick
        const escapedCategory = category.replace(/'/g, "\\'");
        html += `
          <tr class="category-header ${catHealthClass}" onclick="toggleGroup('${escapedCategory}')">
            <td colspan="2">
              <span class="category-toggle">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
              <strong>${category}</strong>
              <span class="category-count">(${catLines.length})</span>
            </td>
            <td class="amount">${formatMoneyDecimal(catTotals.budgeted)}</td>
            <td class="amount">${formatMoneyDecimal(catTotals.billed)}</td>
            <td class="amount">${formatMoneyDecimal(catProjected)}</td>
            <td class="status-cell">${closedCount > 0 ? `<span class="status-summary">${closedCount} closed</span>` : ''}</td>
            <td class="percent">${catPercentComplete.toFixed(1)}%</td>
            <td class="amount ${catVariance < 0 ? 'over-budget' : (catVariance > 0 ? 'under-budget' : '')}">${formatMoneyDecimal(catVariance)}</td>
          </tr>
        `;

        // Individual lines (hidden if collapsed)
        if (!isCollapsed) {
          catLines.forEach(line => {
            const budgeted = line.budgeted || 0;
            const billed = line.billed || 0;
            const committed = line.committed || 0;
            const pending = line.pending || 0;
            const isClosed = !!line.closedAt;
            // Projected = Committed + In Review
            const projected = committed + pending;
            // Variance = Budget - Projected (positive = savings)
            const variance = budgeted - projected;
            // % Complete = Billed / Budget (actual progress)
            const percentComplete = budgeted > 0 ? (billed / budgeted) * 100 : (billed > 0 ? 100 : 0);
            // For health class, use projected %
            const percentProjected = budgeted > 0 ? (projected / budgeted) * 100 : (projected > 0 ? 100 : 0);

            // Determine health class based on variance and closed status
            let healthClass = '';
            let healthIndicator = '';
            if (isClosed) {
              healthClass = 'budget-closed';
              healthIndicator = '<span class="budget-health-indicator health-closed"></span>';
            } else if (variance < 0) {
              healthClass = 'budget-over';
              healthIndicator = '<span class="budget-health-indicator health-over"></span>';
            } else if (budgeted > 0 && percentProjected >= 80) {
              healthClass = 'budget-warning';
              healthIndicator = '<span class="budget-health-indicator health-warning"></span>';
            } else if (projected > 0) {
              healthClass = 'budget-ok';
              healthIndicator = '<span class="budget-health-indicator health-ok"></span>';
            }

            const varianceClass = variance < 0 ? 'over-budget' : (variance > 0 ? 'under-budget' : '');
            const statusBadge = isClosed
              ? `<span class="status-badge status-closed" title="Closed by ${line.closedBy || 'Unknown'}">Closed</span>`
              : `<span class="status-badge status-open">Open</span>`;

            html += `
              <tr class="${healthClass} category-line clickable-row" data-cost-code="${line.costCode}" data-cost-code-id="${line.costCodeId}" onclick="showCostCodeDetail('${line.costCodeId}')" title="Click to view details">
                <td class="cost-code">${healthIndicator}${line.costCode}</td>
                <td>${line.description || '-'}</td>
                <td class="amount">${formatMoneyDecimal(budgeted)}</td>
                <td class="amount">${formatMoneyDecimal(billed)}</td>
                <td class="amount">${formatMoneyDecimal(projected)}</td>
                <td class="status-cell">${statusBadge}</td>
                <td class="percent">${percentComplete.toFixed(1)}%</td>
                <td class="amount ${varianceClass}">${formatMoneyDecimal(variance)}</td>
              </tr>
            `;
          });
        }
      });

      tbody.innerHTML = html;

      // Totals row
      const totals = lines.reduce((acc, line) => ({
        budgeted: acc.budgeted + (line.budgeted || 0),
        billed: acc.billed + (line.billed || 0),
        projected: acc.projected + (line.committed || 0) + (line.pending || 0)
      }), { budgeted: 0, billed: 0, projected: 0 });

      // Projected = Committed + In Review
      const totalProjected = totals.projected;
      // Variance = Budget - Projected (positive = savings)
      const totalVariance = totals.budgeted - totalProjected;
      // % Complete = Billed / Budget
      const overallPercentComplete = totals.budgeted > 0 ? (totals.billed / totals.budgeted) * 100 : 0;

      // Count closed vs open lines
      const closedLinesCount = lines.filter(l => l.closedAt).length;
      const openLinesCount = lines.length - closedLinesCount;

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="2"><strong>TOTAL</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.budgeted)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.billed)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totalProjected)}</strong></td>
          <td class="status-cell"><span class="status-summary">${closedLinesCount} closed / ${openLinesCount} open</span></td>
          <td class="percent"><strong>${overallPercentComplete.toFixed(1)}%</strong></td>
          <td class="amount ${totalVariance < 0 ? 'over-budget' : (totalVariance > 0 ? 'under-budget' : '')}"><strong>${formatMoneyDecimal(totalVariance)}</strong></td>
        </tr>
      `;

      // Handle pending cost code highlight from deep link
      if (state.pendingHighlightCostCode) {
        setTimeout(() => highlightCostCode(state.pendingHighlightCostCode), 100);
        state.pendingHighlightCostCode = null;
      }
    }

    // Highlight and scroll to a specific cost code row
    function highlightCostCode(costCode) {
      const row = document.querySelector(`tr[data-cost-code="${costCode}"]`);
      if (row) {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        row.classList.add('highlight-flash');
        setTimeout(() => row.classList.remove('highlight-flash'), 2000);
      }
    }

    function renderChangeOrders(changeOrders) {
      const tbody = document.getElementById('changeOrdersBody');
      const tfoot = document.getElementById('changeOrdersFooter');
      const countBadge = document.getElementById('changeOrderCount');

      // Store for editing
      state.changeOrders = changeOrders;

      countBadge.textContent = `${changeOrders.length} PCCO${changeOrders.length !== 1 ? 's' : ''}`;

      if (!changeOrders || changeOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No change orders. Click "+ Add Change Order" to create one.</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      tbody.innerHTML = changeOrders.map(co => {
        const statusClass = {
          draft: 'pending',
          pending_approval: 'pending',
          approved: 'approved',
          rejected: 'denied'
        }[co.status] || 'pending';

        const baseAmount = parseFloat(co.base_amount) || 0;
        const gcFeeAmount = parseFloat(co.gc_fee_amount) || 0;
        const totalAmount = parseFloat(co.amount) || 0;
        const daysAdded = parseInt(co.days_added) || 0;
        const billedAmount = parseFloat(co.billed_amount) || 0;
        const billedPercent = totalAmount > 0 ? (billedAmount / totalAmount * 100) : 0;

        const daysDisplay = daysAdded > 0 ? `+${daysAdded}` : daysAdded.toString();
        const daysColor = daysAdded > 0 ? 'var(--accent-orange)' : (daysAdded < 0 ? 'var(--accent-green)' : 'var(--text-secondary)');

        return `
          <tr onclick="editChangeOrder('${co.id}')" style="cursor: pointer;">
            <td><strong>#${co.change_order_number}</strong></td>
            <td>${co.title || '-'}</td>
            <td class="amount">${formatMoneyDecimal(baseAmount)}</td>
            <td class="amount" style="color: var(--text-secondary);">${formatMoneyDecimal(gcFeeAmount)}</td>
            <td class="amount" style="font-weight: 600;">${formatMoneyDecimal(totalAmount)}</td>
            <td style="text-align: center; color: ${daysColor}; font-weight: 500;">${daysDisplay}</td>
            <td class="amount">${formatMoneyDecimal(billedAmount)} <span style="color: var(--text-secondary); font-size: 0.8rem;">(${billedPercent.toFixed(0)}%)</span></td>
            <td><span class="status-badge status-${statusClass}">${co.status.replace('_', ' ')}</span></td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editChangeOrder('${co.id}')">Edit</button>
            </td>
          </tr>
        `;
      }).join('');

      // Totals row
      const totals = changeOrders.reduce((acc, co) => ({
        base: acc.base + (parseFloat(co.base_amount) || 0),
        gcFee: acc.gcFee + (parseFloat(co.gc_fee_amount) || 0),
        total: acc.total + (parseFloat(co.amount) || 0),
        days: acc.days + (parseInt(co.days_added) || 0),
        billed: acc.billed + (parseFloat(co.billed_amount) || 0)
      }), { base: 0, gcFee: 0, total: 0, days: 0, billed: 0 });

      const totalDaysDisplay = totals.days > 0 ? `+${totals.days}` : totals.days.toString();

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="2"><strong>TOTAL (${changeOrders.length} PCCOs)</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.base)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.gcFee)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.total)}</strong></td>
          <td style="text-align: center;"><strong>${totalDaysDisplay}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.billed)}</strong></td>
          <td colspan="2"></td>
        </tr>
      `;
    }

    // ============================================================
    // CHANGE ORDER MANAGEMENT
    // ============================================================

    function showAddCOModal() {
      if (!state.currentJob) {
        showToast('Please select a job first', 'error');
        return;
      }

      document.getElementById('coModalTitle').textContent = 'Add Change Order';
      document.getElementById('coEditId').value = '';
      document.getElementById('coNumber').value = getNextCONumber();
      document.getElementById('coAppNumber').value = '';
      document.getElementById('coTitle').value = '';
      document.getElementById('coReason').value = 'scope_change';
      document.getElementById('coBaseAmount').value = '';
      document.getElementById('coGCFeePercent').value = '20';
      document.getElementById('coGCFeeAmount').value = '';
      document.getElementById('coTotalAmount').value = '';
      document.getElementById('coDaysAdded').value = '0';
      document.getElementById('coStatus').value = 'draft';
      document.getElementById('coDeleteBtn').style.display = 'none';
      document.getElementById('coInvoicesSection').style.display = 'none';
      document.getElementById('coModal').classList.add('show');
    }

    function getNextCONumber() {
      if (!state.changeOrders || state.changeOrders.length === 0) return 1;
      return Math.max(...state.changeOrders.map(co => co.change_order_number)) + 1;
    }

    async function editChangeOrder(coId) {
      const co = state.changeOrders?.find(c => c.id === coId);
      if (!co) return;

      document.getElementById('coModalTitle').textContent = `Edit PCCO #${co.change_order_number}`;
      document.getElementById('coEditId').value = co.id;
      document.getElementById('coNumber').value = co.change_order_number;
      document.getElementById('coAppNumber').value = co.first_billed_draw_number || '';
      document.getElementById('coTitle').value = co.title || '';
      document.getElementById('coReason').value = co.reason || 'scope_change';
      document.getElementById('coBaseAmount').value = co.base_amount || '';
      document.getElementById('coGCFeePercent').value = co.gc_fee_percent || 20;
      document.getElementById('coGCFeeAmount').value = co.gc_fee_amount || '';
      document.getElementById('coTotalAmount').value = formatMoney(co.amount || 0);
      document.getElementById('coDaysAdded').value = co.days_added || 0;
      document.getElementById('coStatus').value = co.status || 'draft';
      document.getElementById('coDeleteBtn').style.display = 'inline-block';
      document.getElementById('coInvoicesSection').style.display = 'block';

      // Load linked invoices
      await loadLinkedInvoices(coId);

      document.getElementById('coModal').classList.add('show');
    }

    function calculateCOTotal() {
      const base = parseFloat(document.getElementById('coBaseAmount').value) || 0;
      const feePercent = parseFloat(document.getElementById('coGCFeePercent').value) || 0;
      const feeAmount = base * (feePercent / 100);
      const total = base + feeAmount;

      document.getElementById('coGCFeeAmount').value = feeAmount.toFixed(2);
      document.getElementById('coTotalAmount').value = formatMoney(total);
    }

    async function saveChangeOrder() {
      const coId = document.getElementById('coEditId').value;
      const jobId = state.currentJob?.id;

      if (!jobId) {
        showToast('No job selected', 'error');
        return;
      }

      const baseAmount = parseFloat(document.getElementById('coBaseAmount').value) || 0;
      const gcFeePercent = parseFloat(document.getElementById('coGCFeePercent').value) || 0;
      const gcFeeAmount = parseFloat(document.getElementById('coGCFeeAmount').value) || 0;
      const daysAddedInput = document.getElementById('coDaysAdded').value;

      const data = {
        change_order_number: parseInt(document.getElementById('coNumber').value),
        title: document.getElementById('coTitle').value,
        description: document.getElementById('coTitle').value,
        reason: document.getElementById('coReason').value,
        base_amount: baseAmount,
        gc_fee_percent: gcFeePercent,
        gc_fee_amount: gcFeeAmount,
        amount: baseAmount + gcFeeAmount,
        days_added: parseInt(daysAddedInput) || 0,
        status: document.getElementById('coStatus').value,
        first_billed_draw_number: parseInt(document.getElementById('coAppNumber').value) || null
      };

      if (!data.title) {
        showToast('Please enter a description', 'error');
        return;
      }

      if (daysAddedInput === '' || daysAddedInput === null || daysAddedInput === undefined) {
        showToast('Please enter days added (can be 0)', 'error');
        return;
      }

      try {
        let res;
        if (coId) {
          // Update existing
          res = await fetch(`/api/change-orders/${coId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          // Create new
          res = await fetch(`/api/jobs/${jobId}/change-orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to save');
        }

        showToast(coId ? 'Change order updated' : 'Change order created', 'success');
        closeModal('coModal');
        loadBudget(jobId);
      } catch (err) {
        console.error('Error saving change order:', err);
        showToast(err.message || 'Failed to save change order', 'error');
      }
    }

    async function deleteChangeOrder() {
      const coId = document.getElementById('coEditId').value;
      if (!coId) return;

      if (!confirm('Are you sure you want to delete this change order?')) return;

      try {
        const res = await fetch(`/api/change-orders/${coId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete');

        showToast('Change order deleted', 'success');
        closeModal('coModal');
        loadBudget(state.currentJob.id);
      } catch (err) {
        console.error('Error deleting change order:', err);
        showToast('Failed to delete change order', 'error');
      }
    }

    // ============================================================
    // INVOICE LINKING
    // ============================================================

    async function loadLinkedInvoices(coId) {
      try {
        const res = await fetch(`/api/change-orders/${coId}/invoices`);
        const invoices = await res.json();

        const container = document.getElementById('coLinkedInvoices');
        if (!invoices || invoices.length === 0) {
          container.innerHTML = '<div class="empty-state" style="padding: 0.5rem;">No invoices linked to this change order</div>';
          return;
        }

        container.innerHTML = invoices.map(link => {
          const inv = link.invoice;
          return `
            <div class="linked-invoice-item">
              <div class="linked-invoice-info">
                <span class="invoice-number">${inv?.invoice_number || 'Unknown'}</span>
                <span class="invoice-vendor">${inv?.vendor?.name || '-'}</span>
                <span class="invoice-amount">${formatMoney(link.amount || inv?.amount)}</span>
              </div>
              <button class="btn btn-sm btn-danger" onclick="unlinkInvoice('${coId}', '${link.invoice_id}')">Unlink</button>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading linked invoices:', err);
      }
    }

    async function showLinkInvoiceModal() {
      const jobId = state.currentJob?.id;
      if (!jobId) return;

      // Load invoices for this job
      try {
        const res = await fetch(`/api/invoices?job_id=${jobId}`);
        const invoices = await res.json();

        const select = document.getElementById('linkInvoiceSelect');
        select.innerHTML = '<option value="">Select an invoice...</option>';
        invoices.forEach(inv => {
          select.innerHTML += `<option value="${inv.id}" data-amount="${inv.amount}">${inv.invoice_number} - ${inv.vendor?.name || 'Unknown'} - ${formatMoney(inv.amount)}</option>`;
        });

        document.getElementById('linkInvoiceAmount').value = '';
        document.getElementById('linkInvoiceModal').classList.add('show');
      } catch (err) {
        console.error('Error loading invoices:', err);
        showToast('Failed to load invoices', 'error');
      }
    }

    async function linkInvoice() {
      const coId = document.getElementById('coEditId').value;
      const invoiceId = document.getElementById('linkInvoiceSelect').value;
      const amount = document.getElementById('linkInvoiceAmount').value || null;

      if (!coId || !invoiceId) {
        showToast('Please select an invoice', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/change-orders/${coId}/link-invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ invoice_id: invoiceId, amount: amount ? parseFloat(amount) : null })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to link');
        }

        showToast('Invoice linked to change order', 'success');
        closeModal('linkInvoiceModal');
        await loadLinkedInvoices(coId);
      } catch (err) {
        console.error('Error linking invoice:', err);
        showToast(err.message || 'Failed to link invoice', 'error');
      }
    }

    async function unlinkInvoice(coId, invoiceId) {
      if (!confirm('Unlink this invoice from the change order?')) return;

      try {
        const res = await fetch(`/api/change-orders/${coId}/unlink-invoice/${invoiceId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to unlink');

        showToast('Invoice unlinked', 'success');
        await loadLinkedInvoices(coId);
      } catch (err) {
        console.error('Error unlinking invoice:', err);
        showToast('Failed to unlink invoice', 'error');
      }
    }

    // Import functionality
    function showImportModal() {
      document.getElementById('importFile').value = '';
      document.getElementById('importPreview').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
      document.getElementById('importModal').classList.add('show');
    }

    let parsedBudgetData = null;

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          // Try to find G703 sheet
          let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('g703') || n.toLowerCase().includes('line item'));
          if (!sheetName) sheetName = workbook.SheetNames[0];

          const sheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          // Parse budget lines
          parsedBudgetData = parseBudgetFromExcel(jsonData);

          if (parsedBudgetData.length > 0) {
            showPreview(parsedBudgetData);
            document.getElementById('importBtn').disabled = false;
          } else {
            showToast('No budget lines found in file', 'error');
          }
        } catch (err) {
          console.error('Error parsing file:', err);
          showToast('Failed to parse Excel file', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function parseBudgetFromExcel(data) {
      const lines = [];

      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        if (!row || !row[0]) continue;

        // Look for cost code pattern (digits with possible dots/dashes)
        const firstCell = String(row[0]).trim();
        if (/^\d{2,5}$/.test(firstCell) || /^\d{2}\d{3}$/.test(firstCell)) {
          const costCode = firstCell;
          const description = row[1] || '';
          const budget = parseFloat(row[2]) || 0;

          if (description && !description.toLowerCase().includes('total')) {
            lines.push({
              costCode,
              description: String(description).trim(),
              budgeted: budget
            });
          }
        }
      }

      return lines;
    }

    function showPreview(lines) {
      const preview = document.getElementById('importPreview');
      const content = document.getElementById('previewContent');

      content.innerHTML = `
        <p><strong>${lines.length}</strong> cost codes found</p>
        <table class="preview-table">
          <thead>
            <tr><th>Code</th><th>Description</th><th>Budget</th></tr>
          </thead>
          <tbody>
            ${lines.slice(0, 10).map(l => `
              <tr>
                <td>${l.costCode}</td>
                <td>${l.description}</td>
                <td>${formatMoney(l.budgeted)}</td>
              </tr>
            `).join('')}
            ${lines.length > 10 ? `<tr><td colspan="3">... and ${lines.length - 10} more</td></tr>` : ''}
          </tbody>
        </table>
      `;

      preview.style.display = 'block';
    }

    async function importBudget() {
      const jobId = document.getElementById('importJob').value;
      if (!jobId) {
        showToast('Please select a job', 'error');
        return;
      }

      if (!parsedBudgetData || parsedBudgetData.length === 0) {
        showToast('No budget data to import', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/jobs/${jobId}/budget/import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lines: parsedBudgetData })
        });

        if (!res.ok) throw new Error('Failed to import budget');

        const result = await res.json();
        showToast(`Imported ${result.imported} budget lines`, 'success');
        closeModal('importModal');

        // Refresh if viewing this job
        if (state.currentJob?.id === jobId) {
          loadBudget(jobId);
        }
      } catch (err) {
        console.error('Error importing budget:', err);
        showToast('Failed to import budget', 'error');
      }
    }

    function exportBudgetExcel() {
      if (!state.currentJob) return;
      window.open(`/api/jobs/${state.currentJob.id}/budget/export`, '_blank');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    function formatMoney(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatMoneyDecimal(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // ============================================================
    // COST CODE DETAIL MODAL
    // ============================================================

    async function showCostCodeDetail(costCodeId) {
      if (!state.currentJob || !costCodeId) return;

      // Store current cost code ID for close-out actions
      state.currentCostCodeId = costCodeId;

      try {
        const res = await fetch(`/api/jobs/${state.currentJob.id}/cost-code/${costCodeId}/details`);
        if (!res.ok) throw new Error('Failed to fetch details');

        const data = await res.json();

        // Update header
        document.getElementById('ccDetailTitle').textContent = `${data.costCode.code} - ${data.costCode.name}`;
        document.getElementById('ccDetailSubtitle').textContent = data.costCode.category;

        // Update summary cards
        document.getElementById('ccBudget').textContent = formatMoney(data.budget.budgeted);
        document.getElementById('ccCommitted').textContent = formatMoney(data.budget.committed);
        document.getElementById('ccBilled').textContent = formatMoney(data.budget.billed);
        document.getElementById('ccPaid').textContent = formatMoney(data.budget.paid);
        document.getElementById('ccRemaining').textContent = formatMoney(data.budget.remaining);

        // Highlight remaining if over budget
        const remainingCard = document.getElementById('ccRemainingCard');
        remainingCard.className = data.budget.remaining < 0 ? 'summary-card over-budget' : 'summary-card';

        // Render invoices table
        renderCCInvoices(data.invoices);

        // Render POs table
        renderCCPurchaseOrders(data.purchaseOrders);

        // Reset to invoices tab
        switchCCTab('cc-invoices');

        // Check if this line is closed (from budget data)
        const budgetLine = (state.budgetData?.lines || []).find(l => l.costCodeId === costCodeId);
        const isClosed = budgetLine?.closedAt;
        state.currentLineClosedAt = isClosed;

        // Show/hide close-out buttons based on status
        document.getElementById('btnCloseoutLine').style.display = isClosed ? 'none' : 'inline-block';
        document.getElementById('btnReopenLine').style.display = isClosed ? 'inline-block' : 'none';

        // Show modal
        document.getElementById('costCodeDetailModal').classList.add('show');

      } catch (err) {
        console.error('Error loading cost code details:', err);
        showToast('Failed to load cost code details', 'error');
      }
    }

    function renderCCInvoices(invoices) {
      const tbody = document.getElementById('ccInvoicesBody');
      const tfoot = document.getElementById('ccInvoicesFooter');

      // Store invoices for PDF viewer access
      state.currentInvoices = invoices;

      if (!invoices || invoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No invoices coded to this cost code</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      const statusClasses = {
        received: 'pending',
        needs_approval: 'pending',
        approved: 'approved',
        in_draw: 'in-progress',
        paid: 'approved',
        denied: 'denied'
      };

      tbody.innerHTML = invoices.map((inv, idx) => `
        <tr class="clickable-row" onclick="showInvoicePdf(${idx})">
          <td><strong>${inv.invoiceNumber || '-'}</strong></td>
          <td>${inv.vendorName}</td>
          <td>${formatDate(inv.invoiceDate)}</td>
          <td class="amount">${formatMoney(inv.allocatedAmount)}</td>
          <td><span class="status-badge status-${statusClasses[inv.status] || 'pending'}">${inv.status.replace('_', ' ')}</span></td>
        </tr>
      `).join('');

      // Calculate totals
      const total = invoices.reduce((sum, inv) => sum + inv.allocatedAmount, 0);
      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="3"><strong>Total (${invoices.length} invoice${invoices.length !== 1 ? 's' : ''})</strong></td>
          <td class="amount"><strong>${formatMoney(total)}</strong></td>
          <td></td>
        </tr>
      `;
    }

    function renderCCPurchaseOrders(pos) {
      const tbody = document.getElementById('ccPOsBody');
      const tfoot = document.getElementById('ccPOsFooter');

      if (!pos || pos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No purchase orders for this cost code</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      const statusClasses = {
        draft: 'pending',
        pending: 'pending',
        sent: 'in-progress',
        approved: 'approved',
        active: 'approved',
        closed: 'approved',
        cancelled: 'denied'
      };

      let html = '';
      pos.forEach(po => {
        po.lineItems.forEach((li, idx) => {
          const isFirst = idx === 0;
          html += `
            <tr class="clickable-row" onclick="window.location.href='pos.html?po=${po.id}'">
              ${isFirst ? `<td rowspan="${po.lineItems.length}"><strong>${po.poNumber}</strong></td>` : ''}
              ${isFirst ? `<td rowspan="${po.lineItems.length}">${po.vendorName}</td>` : ''}
              <td>${li.description || '-'}</td>
              <td class="amount">${formatMoney(li.amount)}</td>
              <td class="amount">${formatMoney(li.invoicedAmount)}</td>
              ${isFirst ? `<td rowspan="${po.lineItems.length}"><span class="status-badge status-${statusClasses[po.statusDetail] || 'pending'}">${po.statusDetail || po.status}</span></td>` : ''}
            </tr>
          `;
        });
      });

      tbody.innerHTML = html;

      // Calculate totals
      const totalAmount = pos.reduce((sum, po) => sum + po.costCodeAmount, 0);
      const totalInvoiced = pos.reduce((sum, po) => sum + po.costCodeInvoiced, 0);
      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="3"><strong>Total (${pos.length} PO${pos.length !== 1 ? 's' : ''})</strong></td>
          <td class="amount"><strong>${formatMoney(totalAmount)}</strong></td>
          <td class="amount"><strong>${formatMoney(totalInvoiced)}</strong></td>
          <td></td>
        </tr>
      `;
    }

    function switchCCTab(tabId) {
      // Update tab buttons
      document.querySelectorAll('#costCodeDetailModal .tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
      });

      // Update tab content
      document.getElementById('tab-cc-invoices').style.display = tabId === 'cc-invoices' ? 'block' : 'none';
      document.getElementById('tab-cc-pos').style.display = tabId === 'cc-pos' ? 'block' : 'none';
    }

    // ============================================================
    // PDF VIEWER
    // ============================================================

    async function showInvoicePdf(invoiceIndex) {
      const invoice = state.currentInvoices?.[invoiceIndex];
      if (!invoice) return;

      // Store current invoice for "Open in new tab" button
      state.currentViewingInvoice = invoice;

      // Show loading state
      document.getElementById('pdfViewerLoading').style.display = 'flex';
      document.getElementById('pdfViewerFrame').style.display = 'none';
      document.getElementById('pdfViewerError').style.display = 'none';

      // Update header
      document.getElementById('pdfViewerTitle').textContent = `Invoice ${invoice.invoiceNumber || ''}`;
      document.getElementById('pdfViewerSubtitle').textContent = invoice.vendorName;

      // Update status badge
      const statusClasses = {
        received: 'pending',
        needs_approval: 'pending',
        approved: 'approved',
        in_draw: 'in-progress',
        paid: 'approved',
        denied: 'denied'
      };
      const statusBadge = document.getElementById('pdfInvoiceStatus');
      statusBadge.className = `status-badge status-${statusClasses[invoice.status] || 'pending'}`;
      statusBadge.textContent = invoice.status.replace('_', ' ');

      // Update footer info
      document.getElementById('pdfInvoiceInfo').innerHTML = `
        <span><strong>Date:</strong> ${formatDate(invoice.invoiceDate)}</span>
        <span><strong>Total:</strong> ${formatMoney(invoice.totalAmount)}</span>
        <span><strong>Allocated:</strong> ${formatMoney(invoice.allocatedAmount)}</span>
      `;

      // Show modal
      document.getElementById('pdfViewerModal').classList.add('show');

      // Fetch invoice details to get PDF URL
      try {
        const res = await fetch(`/api/invoices/${invoice.id}`);
        if (!res.ok) throw new Error('Failed to fetch invoice');

        const invoiceData = await res.json();
        const pdfUrl = invoiceData.pdf_stamped_url || invoiceData.pdf_url;

        if (pdfUrl) {
          const iframe = document.getElementById('pdfViewerFrame');
          iframe.onload = () => {
            document.getElementById('pdfViewerLoading').style.display = 'none';
            iframe.style.display = 'block';
          };
          iframe.onerror = () => {
            document.getElementById('pdfViewerLoading').style.display = 'none';
            document.getElementById('pdfViewerError').style.display = 'block';
          };
          iframe.src = pdfUrl;

          // Fallback timeout in case onload doesn't fire (some PDF viewers)
          setTimeout(() => {
            if (document.getElementById('pdfViewerLoading').style.display !== 'none') {
              document.getElementById('pdfViewerLoading').style.display = 'none';
              iframe.style.display = 'block';
            }
          }, 2000);
        } else {
          document.getElementById('pdfViewerLoading').style.display = 'none';
          document.getElementById('pdfViewerError').style.display = 'block';
        }
      } catch (err) {
        console.error('Error loading invoice PDF:', err);
        document.getElementById('pdfViewerLoading').style.display = 'none';
        document.getElementById('pdfViewerError').style.display = 'block';
      }
    }

    function openInvoiceInNewTab() {
      const invoice = state.currentViewingInvoice;
      if (invoice) {
        window.open(`index.html?invoice=${invoice.id}`, '_blank');
      }
    }

    // ============================================================
    // BUDGET LINE CLOSE-OUT
    // ============================================================

    async function closeOutBudgetLine() {
      const costCodeId = state.currentCostCodeId;
      const jobId = state.currentJob?.id;

      if (!costCodeId || !jobId) {
        showToast('No cost code selected', 'error');
        return;
      }

      // Get current line data to show what's being locked in
      const line = (state.budgetData?.lines || []).find(l => l.costCodeId === costCodeId);
      const budget = line?.budgeted || 0;
      const committed = (line?.committed || 0) + (line?.pending || 0);
      const variance = budget - committed;
      const varianceText = variance >= 0
        ? `${formatMoney(variance)} UNDER budget`
        : `${formatMoney(Math.abs(variance))} OVER budget`;

      // Confirm action with details
      const confirmMsg = `Close out this budget line?\n\nBudget: ${formatMoney(budget)}\nCommitted: ${formatMoney(committed)}\nVariance: ${varianceText}\n\nThis will lock in the committed cost as final.`;
      if (!confirm(confirmMsg)) {
        return;
      }

      try {
        const res = await fetch(`/api/jobs/${jobId}/budget/${costCodeId}/close`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ closed_by: 'User' })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to close out budget line');
        }

        showToast(`Line closed at ${formatMoney(committed)} (${varianceText})`, 'success');
        closeModal('costCodeDetailModal');

        // Refresh budget data
        loadBudget(jobId);
      } catch (err) {
        console.error('Error closing budget line:', err);
        showToast(err.message || 'Failed to close out budget line', 'error');
      }
    }

    async function reopenBudgetLine() {
      const costCodeId = state.currentCostCodeId;
      const jobId = state.currentJob?.id;

      if (!costCodeId || !jobId) {
        showToast('No cost code selected', 'error');
        return;
      }

      // Confirm action
      if (!confirm('Reopen this budget line? Savings will become potential (not confirmed) again.')) {
        return;
      }

      try {
        const res = await fetch(`/api/jobs/${jobId}/budget/${costCodeId}/reopen`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to reopen budget line');
        }

        showToast('Budget line reopened successfully', 'success');
        closeModal('costCodeDetailModal');

        // Refresh budget data
        loadBudget(jobId);
      } catch (err) {
        console.error('Error reopening budget line:', err);
        showToast(err.message || 'Failed to reopen budget line', 'error');
      }
    }

    function showToast(message, type = 'info') {
      if (window.Toast) {
        Toast.show(message, type);
      } else {
        console.log(`[${type}] ${message}`);
      }
    }
  </script>
</body>
</html>
