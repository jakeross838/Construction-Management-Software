<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Budgets</title>
  <link rel="stylesheet" href="css/styles.css?v=20260112a">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1>Budgets</h1>
        <nav class="header-nav">
          <a href="index.html" class="nav-link">Invoices</a>
          <a href="pos.html" class="nav-link">Purchase Orders</a>
          <a href="draws.html" class="nav-link">Draws</a>
          <a href="budgets.html" class="nav-link active">Budgets</a>
        </nav>
      </div>
      <button class="btn btn-primary" onclick="showImportModal()">Import Budget</button>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Job Selector -->
      <div class="table-toolbar">
        <div class="filter-controls">
          <select id="jobFilter" class="form-control filter-select" style="min-width: 300px;">
            <option value="">Select a Job...</option>
          </select>
        </div>
        <div class="budget-stats" id="budgetStats">
          <!-- Stats populated dynamically -->
        </div>
      </div>

      <!-- Budget Content -->
      <div id="budgetContent">
        <div class="empty-state">Select a job to view budget</div>
      </div>
    </main>
  </div>

  <!-- Budget Detail Modal -->
  <div id="budgetModal" class="modal modal-fullscreen-dark">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-group">
          <h2 id="budgetModalTitle">Budget</h2>
        </div>
        <div class="modal-header-actions">
          <button class="btn btn-secondary" onclick="exportBudgetExcel()">Export Excel</button>
          <button class="btn btn-secondary" onclick="window.print()">Print</button>
          <button class="close-btn" onclick="closeBudgetModal()">&times;</button>
        </div>
      </div>

      <div class="modal-body draw-modal-body draw-single-page">
        <!-- Summary Section -->
        <section class="draw-section draw-summary-section">
          <div class="draw-summary-grid">
            <div class="summary-card">
              <div class="summary-label">Original Budget</div>
              <div class="summary-value" id="summaryBudget">$0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Change Orders</div>
              <div class="summary-value" id="summaryChangeOrders">$0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">Total Contract</div>
              <div class="summary-value" id="summaryTotalContract">$0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Billed to Date</div>
              <div class="summary-value" id="summaryBilled">$0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Paid to Date</div>
              <div class="summary-value" id="summaryPaid">$0</div>
            </div>
            <div class="summary-card" id="varianceCard">
              <div class="summary-label">Remaining</div>
              <div class="summary-value" id="summaryRemaining">$0</div>
            </div>
            <div class="summary-card" id="overBudgetCard">
              <div class="summary-label">Over Budget</div>
              <div class="summary-value" id="summaryOverBudget">0 items</div>
            </div>
          </div>
        </section>

        <!-- Budget Lines Section -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Budget by Cost Code</h3>
            <span class="section-subtitle">Live view - updates when invoices are approved</span>
            <div class="division-controls">
              <button onclick="toggleAllGroups(false)">Expand All</button>
              <button onclick="toggleAllGroups(true)">Collapse All</button>
            </div>
          </div>
          <div class="g703-container">
            <div class="g703-table-wrapper">
              <table class="g703-table budget-table">
                <thead>
                  <tr>
                    <th>Cost Code</th>
                    <th>Description</th>
                    <th>Budget</th>
                    <th>Committed</th>
                    <th>Billed</th>
                    <th>Paid</th>
                    <th>%</th>
                    <th>Remaining</th>
                    <th>Variance</th>
                  </tr>
                </thead>
                <tbody id="budgetBody">
                  <tr>
                    <td colspan="9" class="loading">Loading budget...</td>
                  </tr>
                </tbody>
                <tfoot id="budgetFooter">
                </tfoot>
              </table>
            </div>
          </div>
        </section>

        <!-- Change Orders Section (PCCOs) -->
        <section class="draw-section">
          <div class="section-header">
            <h3>Prime Contract Change Orders (PCCOs)</h3>
            <div class="section-header-actions">
              <span class="section-badge" id="changeOrderCount">0 change orders</span>
              <button class="btn btn-sm btn-primary" onclick="showAddCOModal()">+ Add Change Order</button>
            </div>
          </div>
          <div class="invoices-container">
            <table class="invoices-table co-table">
              <thead>
                <tr>
                  <th style="width: 60px;">PCCO #</th>
                  <th>Description</th>
                  <th style="width: 100px;">Base Amount</th>
                  <th style="width: 80px;">GC Fee</th>
                  <th style="width: 100px;">Total</th>
                  <th style="width: 60px;">Days</th>
                  <th style="width: 80px;">Billed</th>
                  <th style="width: 80px;">Status</th>
                  <th style="width: 100px;">Actions</th>
                </tr>
              </thead>
              <tbody id="changeOrdersBody">
                <tr>
                  <td colspan="9" class="empty-state">No change orders</td>
                </tr>
              </tbody>
              <tfoot id="changeOrdersFooter">
              </tfoot>
            </table>
          </div>
        </section>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeBudgetModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Change Order Modal -->
  <div id="coModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2 id="coModalTitle">Add Change Order</h2>
        <button class="close-btn" onclick="closeModal('coModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="coEditId">
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label>PCCO Number *</label>
            <input type="number" id="coNumber" class="form-control" min="1" required>
          </div>
          <div class="form-group" style="flex: 1;">
            <label>First Billed on App #</label>
            <input type="number" id="coAppNumber" class="form-control" min="1">
          </div>
        </div>
        <div class="form-group">
          <label>Description *</label>
          <input type="text" id="coTitle" class="form-control" placeholder="e.g., Added helical piles near pool" required>
        </div>
        <div class="form-group">
          <label>Reason</label>
          <select id="coReason" class="form-control">
            <option value="scope_change">Scope Change</option>
            <option value="owner_request">Owner Request</option>
            <option value="unforeseen_conditions">Unforeseen Conditions</option>
            <option value="design_change">Design Change</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label>Base Amount *</label>
            <input type="number" id="coBaseAmount" class="form-control" step="0.01" min="0" required onchange="calculateCOTotal()">
          </div>
          <div class="form-group" style="flex: 0.7;">
            <label>GC Fee %</label>
            <input type="number" id="coGCFeePercent" class="form-control" step="0.1" value="20" onchange="calculateCOTotal()">
          </div>
          <div class="form-group" style="flex: 1;">
            <label>GC Fee Amount</label>
            <input type="number" id="coGCFeeAmount" class="form-control" step="0.01" readonly>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <label>Total Amount</label>
            <input type="text" id="coTotalAmount" class="form-control" readonly style="font-weight: bold; font-size: 1.1rem;">
          </div>
          <div class="form-group" style="flex: 1;">
            <label>Days Added *</label>
            <input type="number" id="coDaysAdded" class="form-control" value="0" required placeholder="0">
            <small class="form-hint">Schedule impact (can be 0 or negative)</small>
          </div>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="coStatus" class="form-control">
            <option value="draft">Draft</option>
            <option value="pending_approval">Pending Approval</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>

        <!-- Linked Invoices Section (only shown when editing) -->
        <div id="coInvoicesSection" style="display: none; margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
          <div class="section-header" style="margin-bottom: 0.5rem;">
            <h4 style="margin: 0;">Linked Invoices</h4>
            <button class="btn btn-sm btn-secondary" onclick="showLinkInvoiceModal()">+ Link Invoice</button>
          </div>
          <div id="coLinkedInvoices" class="linked-invoices-list">
            <div class="empty-state" style="padding: 0.5rem;">No invoices linked</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('coModal')">Cancel</button>
        <button class="btn btn-danger" id="coDeleteBtn" onclick="deleteChangeOrder()" style="display: none;">Delete</button>
        <button class="btn btn-primary" onclick="saveChangeOrder()">Save Change Order</button>
      </div>
    </div>
  </div>

  <!-- Link Invoice Modal -->
  <div id="linkInvoiceModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Link Invoice to Change Order</h2>
        <button class="close-btn" onclick="closeModal('linkInvoiceModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Invoice</label>
          <select id="linkInvoiceSelect" class="form-control">
            <option value="">Select an invoice...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount from this invoice for CO (optional)</label>
          <input type="number" id="linkInvoiceAmount" class="form-control" step="0.01" placeholder="Leave blank for full invoice amount">
          <small class="form-hint">If this invoice covers multiple COs, enter the portion for this CO</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('linkInvoiceModal')">Cancel</button>
        <button class="btn btn-primary" onclick="linkInvoice()">Link Invoice</button>
      </div>
    </div>
  </div>

  <!-- Import Budget Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Import Budget from Excel</h2>
        <button class="close-btn" onclick="closeModal('importModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Job *</label>
          <select id="importJob" class="form-control" required>
            <option value="">Select a job...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Excel File (.xlsx, .xls)</label>
          <input type="file" id="importFile" class="form-control" accept=".xlsx,.xls">
          <small class="form-hint">Upload a G703 format budget spreadsheet</small>
        </div>
        <div id="importPreview" class="import-preview" style="display: none;">
          <h4>Preview</h4>
          <div id="previewContent"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
        <button class="btn btn-primary" onclick="importBudget()" id="importBtn" disabled>Import Budget</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="js/toasts.js"></script>
  <script>
    // ============================================================
    // BUDGETS PAGE - Live Budget View
    // ============================================================

    let state = {
      jobs: [],
      currentJob: null,
      budgetData: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadJobs();
      setupEventListeners();
    });

    async function loadJobs() {
      try {
        const res = await fetch('/api/jobs');
        state.jobs = await res.json();

        const select = document.getElementById('jobFilter');
        const importSelect = document.getElementById('importJob');

        select.innerHTML = '<option value="">Select a Job...</option>';
        importSelect.innerHTML = '<option value="">Select a job...</option>';

        state.jobs.forEach(job => {
          select.innerHTML += `<option value="${job.id}">${job.name}</option>`;
          importSelect.innerHTML += `<option value="${job.id}">${job.name}</option>`;
        });
      } catch (err) {
        console.error('Failed to load jobs:', err);
      }
    }

    function setupEventListeners() {
      document.getElementById('jobFilter').addEventListener('change', (e) => {
        if (e.target.value) {
          loadBudget(e.target.value);
        } else {
          document.getElementById('budgetContent').innerHTML = '<div class="empty-state">Select a job to view budget</div>';
        }
      });

      document.getElementById('importFile').addEventListener('change', handleFileSelect);
    }

    async function loadBudget(jobId) {
      try {
        const job = state.jobs.find(j => j.id === jobId);
        state.currentJob = job;

        // Show loading in content area
        document.getElementById('budgetContent').innerHTML = '<div class="loading">Loading budget...</div>';

        // Fetch budget data
        const res = await fetch(`/api/jobs/${jobId}/budget-summary`);
        if (!res.ok) throw new Error('Failed to fetch budget');

        state.budgetData = await res.json();

        // Show the modal with budget data
        renderBudgetModal();
        document.getElementById('budgetModal').classList.add('show');

        // Update content area with summary
        renderBudgetSummaryCard();
      } catch (err) {
        console.error('Error loading budget:', err);
        showToast('Failed to load budget', 'error');
      }
    }

    function renderBudgetSummaryCard() {
      const data = state.budgetData;
      const job = state.currentJob;
      const totalContract = data.totals.adjustedContract || data.totals.budgeted;
      const remaining = totalContract - data.totals.billed;
      const percentComplete = totalContract > 0 ? (data.totals.billed / totalContract) * 100 : 0;

      document.getElementById('budgetContent').innerHTML = `
        <div class="budget-summary-card" onclick="document.getElementById('budgetModal').classList.add('show')">
          <div class="budget-card-header">
            <h3>${job.name}</h3>
            <span class="btn btn-sm btn-primary">View Details</span>
          </div>
          <div class="budget-card-stats">
            <div class="stat">
              <span class="stat-label">Total Contract</span>
              <span class="stat-value">${formatMoney(totalContract)}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Billed</span>
              <span class="stat-value">${formatMoney(data.totals.billed)}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Remaining</span>
              <span class="stat-value">${formatMoney(remaining)}</span>
            </div>
            <div class="stat">
              <span class="stat-label">% Complete</span>
              <span class="stat-value">${percentComplete.toFixed(1)}%</span>
            </div>
          </div>
          <div class="budget-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${Math.min(percentComplete, 100)}%"></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderBudgetModal() {
      const data = state.budgetData;
      const job = state.currentJob;

      // Header
      document.getElementById('budgetModalTitle').textContent = `Budget - ${job.name}`;

      // Summary cards
      document.getElementById('summaryBudget').textContent = formatMoney(data.totals.budgeted);
      document.getElementById('summaryChangeOrders').textContent = formatMoney(data.totals.changeOrderTotal || 0);
      document.getElementById('summaryTotalContract').textContent = formatMoney(data.totals.adjustedContract || data.totals.budgeted);
      document.getElementById('summaryBilled').textContent = formatMoney(data.totals.billed);
      document.getElementById('summaryPaid').textContent = formatMoney(data.totals.paid);

      const remaining = (data.totals.adjustedContract || data.totals.budgeted) - data.totals.billed;
      document.getElementById('summaryRemaining').textContent = formatMoney(remaining);
      document.getElementById('varianceCard').className = `summary-card ${remaining < 0 ? 'over-budget' : ''}`;

      // Count over-budget items
      const overBudgetCount = (data.lines || []).filter(line => {
        const budgeted = line.budgeted || 0;
        const billed = line.billed || 0;
        return budgeted > 0 && billed > budgeted;
      }).length;
      document.getElementById('summaryOverBudget').textContent = `${overBudgetCount} item${overBudgetCount !== 1 ? 's' : ''}`;
      document.getElementById('overBudgetCard').className = `summary-card ${overBudgetCount > 0 ? 'over-budget' : ''}`;

      // Budget lines table
      renderBudgetTable(data.lines);

      // Change orders (PCCOs - job change orders)
      renderChangeOrders(data.jobChangeOrders || []);
    }

    // Category sort order - follows construction flow, General Conditions at bottom
    const CATEGORY_ORDER = [
      'Pre-Construction & Design',
      'Permits & Fees',
      'Site Work',
      'Foundation',
      'Framing & Structure',
      'Roofing',
      'Windows & Doors',
      'Plumbing',
      'Electrical & Low Voltage',
      'HVAC',
      'Gas',
      'Fireplace',
      'Insulation',
      'Drywall & Ceilings',
      'Exterior Finishes',
      'Painting',
      'Flooring & Tile',
      'Cabinetry & Countertops',
      'Interior Trim & Doors',
      'Appliances',
      'Hardware & Accessories',
      'Glass & Mirrors',
      'Closets',
      'Garage Doors',
      'Specialty Items',
      'Outdoor & Pool',
      'Landscaping & Hardscape',
      // General Conditions at bottom
      'General Conditions'
    ];

    // Track collapsed groups
    let collapsedGroups = new Set();

    function toggleGroup(groupName) {
      if (collapsedGroups.has(groupName)) {
        collapsedGroups.delete(groupName);
      } else {
        collapsedGroups.add(groupName);
      }
      renderBudgetTable(state.budgetData?.lines || []);
    }

    function toggleAllGroups(collapse) {
      if (collapse) {
        CATEGORY_ORDER.forEach(cat => collapsedGroups.add(cat));
      } else {
        collapsedGroups.clear();
      }
      renderBudgetTable(state.budgetData?.lines || []);
    }

    function renderBudgetTable(lines) {
      const tbody = document.getElementById('budgetBody');
      const tfoot = document.getElementById('budgetFooter');

      if (!lines || lines.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No budget lines found. Import a budget to get started.</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      // Filter out lines with no cost code (orphan allocations)
      const validLines = lines.filter(line => line.costCode && line.costCode.trim() !== '');

      // Group by category
      const groupedLines = {};
      validLines.forEach(line => {
        const category = line.category || 'Uncategorized';
        if (!groupedLines[category]) {
          groupedLines[category] = [];
        }
        groupedLines[category].push(line);
      });

      // Sort each group by cost code
      Object.values(groupedLines).forEach(group => {
        group.sort((a, b) => (a.costCode || '').localeCompare(b.costCode || ''));
      });

      // Sort categories by defined order
      const sortedCategories = Object.keys(groupedLines).sort((a, b) => {
        const aIdx = CATEGORY_ORDER.indexOf(a);
        const bIdx = CATEGORY_ORDER.indexOf(b);
        // If not in list, put at end (before General Conditions)
        const aOrder = aIdx === -1 ? CATEGORY_ORDER.length - 3 : aIdx;
        const bOrder = bIdx === -1 ? CATEGORY_ORDER.length - 3 : bIdx;
        return aOrder - bOrder;
      });

      // Render grouped table
      let html = '';
      sortedCategories.forEach(category => {
        const catLines = groupedLines[category];
        const isCollapsed = collapsedGroups.has(category);

        // Calculate category totals
        const catTotals = catLines.reduce((acc, line) => ({
          budgeted: acc.budgeted + (line.budgeted || 0),
          committed: acc.committed + (line.committed || 0),
          billed: acc.billed + (line.billed || 0),
          paid: acc.paid + (line.paid || 0)
        }), { budgeted: 0, committed: 0, billed: 0, paid: 0 });

        const catPercent = catTotals.budgeted > 0 ? (catTotals.billed / catTotals.budgeted) * 100 : 0;
        const catVariance = catTotals.budgeted - catTotals.billed;
        const catHealthClass = catPercent > 100 ? 'budget-over' : (catPercent >= 80 ? 'budget-warning' : '');

        // Category header row - escape quotes for onclick
        const escapedCategory = category.replace(/'/g, "\\'");
        html += `
          <tr class="category-header ${catHealthClass}" onclick="toggleGroup('${escapedCategory}')">
            <td colspan="2">
              <span class="category-toggle">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
              <strong>${category}</strong>
              <span class="category-count">(${catLines.length})</span>
            </td>
            <td class="amount">${formatMoneyDecimal(catTotals.budgeted)}</td>
            <td class="amount">${formatMoneyDecimal(catTotals.committed)}</td>
            <td class="amount">${formatMoneyDecimal(catTotals.billed)}</td>
            <td class="amount">${formatMoneyDecimal(catTotals.paid)}</td>
            <td class="percent">${catPercent.toFixed(1)}%</td>
            <td class="amount">${formatMoneyDecimal(catTotals.budgeted - catTotals.billed)}</td>
            <td class="amount ${catVariance < 0 ? 'over-budget' : ''}">${formatMoneyDecimal(catVariance)}</td>
          </tr>
        `;

        // Individual lines (hidden if collapsed)
        if (!isCollapsed) {
          catLines.forEach(line => {
            const budgeted = line.budgeted || 0;
            const committed = line.committed || 0;
            const billed = line.billed || 0;
            const paid = line.paid || 0;
            const remaining = budgeted - billed;
            const variance = budgeted - billed;
            const percentComplete = budgeted > 0 ? (billed / budgeted) * 100 : (billed > 0 ? 100 : 0);

            // Determine health class based on % used
            let healthClass = '';
            let healthIndicator = '';
            if (budgeted > 0) {
              if (percentComplete > 100) {
                healthClass = 'budget-over';
                healthIndicator = '<span class="budget-health-indicator health-over"></span>';
              } else if (percentComplete >= 80) {
                healthClass = 'budget-warning';
                healthIndicator = '<span class="budget-health-indicator health-warning"></span>';
              } else if (billed > 0) {
                healthClass = 'budget-ok';
                healthIndicator = '<span class="budget-health-indicator health-ok"></span>';
              }
            } else if (billed > 0) {
              healthClass = 'budget-over';
              healthIndicator = '<span class="budget-health-indicator health-over"></span>';
            }

            const varianceClass = variance < 0 ? 'over-budget' : '';

            html += `
              <tr class="${healthClass} category-line">
                <td class="cost-code">${healthIndicator}${line.costCode}</td>
                <td>${line.description || '-'}</td>
                <td class="amount">${formatMoneyDecimal(budgeted)}</td>
                <td class="amount">${formatMoneyDecimal(committed)}</td>
                <td class="amount highlight-current">${formatMoneyDecimal(billed)}</td>
                <td class="amount">${formatMoneyDecimal(paid)}</td>
                <td class="percent">${percentComplete.toFixed(1)}%</td>
                <td class="amount">${formatMoneyDecimal(remaining)}</td>
                <td class="amount ${varianceClass}">${formatMoneyDecimal(variance)}</td>
              </tr>
            `;
          });
        }
      });

      tbody.innerHTML = html;

      // Totals row
      const totals = lines.reduce((acc, line) => ({
        budgeted: acc.budgeted + (line.budgeted || 0),
        committed: acc.committed + (line.committed || 0),
        billed: acc.billed + (line.billed || 0),
        paid: acc.paid + (line.paid || 0)
      }), { budgeted: 0, committed: 0, billed: 0, paid: 0 });

      const totalRemaining = totals.budgeted - totals.billed;
      const totalVariance = totals.budgeted - totals.billed;
      const overallPercent = totals.budgeted > 0 ? (totals.billed / totals.budgeted) * 100 : 0;

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="2"><strong>TOTAL</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.budgeted)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.committed)}</strong></td>
          <td class="amount highlight-current"><strong>${formatMoneyDecimal(totals.billed)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.paid)}</strong></td>
          <td class="percent"><strong>${overallPercent.toFixed(1)}%</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totalRemaining)}</strong></td>
          <td class="amount ${totalVariance < 0 ? 'over-budget' : ''}"><strong>${formatMoneyDecimal(totalVariance)}</strong></td>
        </tr>
      `;
    }

    function renderChangeOrders(changeOrders) {
      const tbody = document.getElementById('changeOrdersBody');
      const tfoot = document.getElementById('changeOrdersFooter');
      const countBadge = document.getElementById('changeOrderCount');

      // Store for editing
      state.changeOrders = changeOrders;

      countBadge.textContent = `${changeOrders.length} PCCO${changeOrders.length !== 1 ? 's' : ''}`;

      if (!changeOrders || changeOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No change orders. Click "+ Add Change Order" to create one.</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      tbody.innerHTML = changeOrders.map(co => {
        const statusClass = {
          draft: 'pending',
          pending_approval: 'pending',
          approved: 'approved',
          rejected: 'denied'
        }[co.status] || 'pending';

        const baseAmount = parseFloat(co.base_amount) || 0;
        const gcFeeAmount = parseFloat(co.gc_fee_amount) || 0;
        const totalAmount = parseFloat(co.amount) || 0;
        const daysAdded = parseInt(co.days_added) || 0;
        const billedAmount = parseFloat(co.billed_amount) || 0;
        const billedPercent = totalAmount > 0 ? (billedAmount / totalAmount * 100) : 0;

        const daysDisplay = daysAdded > 0 ? `+${daysAdded}` : daysAdded.toString();
        const daysColor = daysAdded > 0 ? 'var(--accent-orange)' : (daysAdded < 0 ? 'var(--accent-green)' : 'var(--text-secondary)');

        return `
          <tr onclick="editChangeOrder('${co.id}')" style="cursor: pointer;">
            <td><strong>#${co.change_order_number}</strong></td>
            <td>${co.title || '-'}</td>
            <td class="amount">${formatMoneyDecimal(baseAmount)}</td>
            <td class="amount" style="color: var(--text-secondary);">${formatMoneyDecimal(gcFeeAmount)}</td>
            <td class="amount" style="font-weight: 600;">${formatMoneyDecimal(totalAmount)}</td>
            <td style="text-align: center; color: ${daysColor}; font-weight: 500;">${daysDisplay}</td>
            <td class="amount">${formatMoneyDecimal(billedAmount)} <span style="color: var(--text-secondary); font-size: 0.8rem;">(${billedPercent.toFixed(0)}%)</span></td>
            <td><span class="status-badge status-${statusClass}">${co.status.replace('_', ' ')}</span></td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editChangeOrder('${co.id}')">Edit</button>
            </td>
          </tr>
        `;
      }).join('');

      // Totals row
      const totals = changeOrders.reduce((acc, co) => ({
        base: acc.base + (parseFloat(co.base_amount) || 0),
        gcFee: acc.gcFee + (parseFloat(co.gc_fee_amount) || 0),
        total: acc.total + (parseFloat(co.amount) || 0),
        days: acc.days + (parseInt(co.days_added) || 0),
        billed: acc.billed + (parseFloat(co.billed_amount) || 0)
      }), { base: 0, gcFee: 0, total: 0, days: 0, billed: 0 });

      const totalDaysDisplay = totals.days > 0 ? `+${totals.days}` : totals.days.toString();

      tfoot.innerHTML = `
        <tr class="totals-row">
          <td colspan="2"><strong>TOTAL (${changeOrders.length} PCCOs)</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.base)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.gcFee)}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.total)}</strong></td>
          <td style="text-align: center;"><strong>${totalDaysDisplay}</strong></td>
          <td class="amount"><strong>${formatMoneyDecimal(totals.billed)}</strong></td>
          <td colspan="2"></td>
        </tr>
      `;
    }

    // ============================================================
    // CHANGE ORDER MANAGEMENT
    // ============================================================

    function showAddCOModal() {
      if (!state.currentJob) {
        showToast('Please select a job first', 'error');
        return;
      }

      document.getElementById('coModalTitle').textContent = 'Add Change Order';
      document.getElementById('coEditId').value = '';
      document.getElementById('coNumber').value = getNextCONumber();
      document.getElementById('coAppNumber').value = '';
      document.getElementById('coTitle').value = '';
      document.getElementById('coReason').value = 'scope_change';
      document.getElementById('coBaseAmount').value = '';
      document.getElementById('coGCFeePercent').value = '20';
      document.getElementById('coGCFeeAmount').value = '';
      document.getElementById('coTotalAmount').value = '';
      document.getElementById('coDaysAdded').value = '0';
      document.getElementById('coStatus').value = 'draft';
      document.getElementById('coDeleteBtn').style.display = 'none';
      document.getElementById('coInvoicesSection').style.display = 'none';
      document.getElementById('coModal').classList.add('show');
    }

    function getNextCONumber() {
      if (!state.changeOrders || state.changeOrders.length === 0) return 1;
      return Math.max(...state.changeOrders.map(co => co.change_order_number)) + 1;
    }

    async function editChangeOrder(coId) {
      const co = state.changeOrders?.find(c => c.id === coId);
      if (!co) return;

      document.getElementById('coModalTitle').textContent = `Edit PCCO #${co.change_order_number}`;
      document.getElementById('coEditId').value = co.id;
      document.getElementById('coNumber').value = co.change_order_number;
      document.getElementById('coAppNumber').value = co.first_billed_draw_number || '';
      document.getElementById('coTitle').value = co.title || '';
      document.getElementById('coReason').value = co.reason || 'scope_change';
      document.getElementById('coBaseAmount').value = co.base_amount || '';
      document.getElementById('coGCFeePercent').value = co.gc_fee_percent || 20;
      document.getElementById('coGCFeeAmount').value = co.gc_fee_amount || '';
      document.getElementById('coTotalAmount').value = formatMoney(co.amount || 0);
      document.getElementById('coDaysAdded').value = co.days_added || 0;
      document.getElementById('coStatus').value = co.status || 'draft';
      document.getElementById('coDeleteBtn').style.display = 'inline-block';
      document.getElementById('coInvoicesSection').style.display = 'block';

      // Load linked invoices
      await loadLinkedInvoices(coId);

      document.getElementById('coModal').classList.add('show');
    }

    function calculateCOTotal() {
      const base = parseFloat(document.getElementById('coBaseAmount').value) || 0;
      const feePercent = parseFloat(document.getElementById('coGCFeePercent').value) || 0;
      const feeAmount = base * (feePercent / 100);
      const total = base + feeAmount;

      document.getElementById('coGCFeeAmount').value = feeAmount.toFixed(2);
      document.getElementById('coTotalAmount').value = formatMoney(total);
    }

    async function saveChangeOrder() {
      const coId = document.getElementById('coEditId').value;
      const jobId = state.currentJob?.id;

      if (!jobId) {
        showToast('No job selected', 'error');
        return;
      }

      const baseAmount = parseFloat(document.getElementById('coBaseAmount').value) || 0;
      const gcFeePercent = parseFloat(document.getElementById('coGCFeePercent').value) || 0;
      const gcFeeAmount = parseFloat(document.getElementById('coGCFeeAmount').value) || 0;
      const daysAddedInput = document.getElementById('coDaysAdded').value;

      const data = {
        change_order_number: parseInt(document.getElementById('coNumber').value),
        title: document.getElementById('coTitle').value,
        description: document.getElementById('coTitle').value,
        reason: document.getElementById('coReason').value,
        base_amount: baseAmount,
        gc_fee_percent: gcFeePercent,
        gc_fee_amount: gcFeeAmount,
        amount: baseAmount + gcFeeAmount,
        days_added: parseInt(daysAddedInput) || 0,
        status: document.getElementById('coStatus').value,
        first_billed_draw_number: parseInt(document.getElementById('coAppNumber').value) || null
      };

      if (!data.title) {
        showToast('Please enter a description', 'error');
        return;
      }

      if (daysAddedInput === '' || daysAddedInput === null || daysAddedInput === undefined) {
        showToast('Please enter days added (can be 0)', 'error');
        return;
      }

      try {
        let res;
        if (coId) {
          // Update existing
          res = await fetch(`/api/change-orders/${coId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          // Create new
          res = await fetch(`/api/jobs/${jobId}/change-orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to save');
        }

        showToast(coId ? 'Change order updated' : 'Change order created', 'success');
        closeModal('coModal');
        loadBudget(jobId);
      } catch (err) {
        console.error('Error saving change order:', err);
        showToast(err.message || 'Failed to save change order', 'error');
      }
    }

    async function deleteChangeOrder() {
      const coId = document.getElementById('coEditId').value;
      if (!coId) return;

      if (!confirm('Are you sure you want to delete this change order?')) return;

      try {
        const res = await fetch(`/api/change-orders/${coId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete');

        showToast('Change order deleted', 'success');
        closeModal('coModal');
        loadBudget(state.currentJob.id);
      } catch (err) {
        console.error('Error deleting change order:', err);
        showToast('Failed to delete change order', 'error');
      }
    }

    // ============================================================
    // INVOICE LINKING
    // ============================================================

    async function loadLinkedInvoices(coId) {
      try {
        const res = await fetch(`/api/change-orders/${coId}/invoices`);
        const invoices = await res.json();

        const container = document.getElementById('coLinkedInvoices');
        if (!invoices || invoices.length === 0) {
          container.innerHTML = '<div class="empty-state" style="padding: 0.5rem;">No invoices linked to this change order</div>';
          return;
        }

        container.innerHTML = invoices.map(link => {
          const inv = link.invoice;
          return `
            <div class="linked-invoice-item">
              <div class="linked-invoice-info">
                <span class="invoice-number">${inv?.invoice_number || 'Unknown'}</span>
                <span class="invoice-vendor">${inv?.vendor?.name || '-'}</span>
                <span class="invoice-amount">${formatMoney(link.amount || inv?.amount)}</span>
              </div>
              <button class="btn btn-sm btn-danger" onclick="unlinkInvoice('${coId}', '${link.invoice_id}')">Unlink</button>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading linked invoices:', err);
      }
    }

    async function showLinkInvoiceModal() {
      const jobId = state.currentJob?.id;
      if (!jobId) return;

      // Load invoices for this job
      try {
        const res = await fetch(`/api/invoices?job_id=${jobId}`);
        const invoices = await res.json();

        const select = document.getElementById('linkInvoiceSelect');
        select.innerHTML = '<option value="">Select an invoice...</option>';
        invoices.forEach(inv => {
          select.innerHTML += `<option value="${inv.id}" data-amount="${inv.amount}">${inv.invoice_number} - ${inv.vendor?.name || 'Unknown'} - ${formatMoney(inv.amount)}</option>`;
        });

        document.getElementById('linkInvoiceAmount').value = '';
        document.getElementById('linkInvoiceModal').classList.add('show');
      } catch (err) {
        console.error('Error loading invoices:', err);
        showToast('Failed to load invoices', 'error');
      }
    }

    async function linkInvoice() {
      const coId = document.getElementById('coEditId').value;
      const invoiceId = document.getElementById('linkInvoiceSelect').value;
      const amount = document.getElementById('linkInvoiceAmount').value || null;

      if (!coId || !invoiceId) {
        showToast('Please select an invoice', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/change-orders/${coId}/link-invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ invoice_id: invoiceId, amount: amount ? parseFloat(amount) : null })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to link');
        }

        showToast('Invoice linked to change order', 'success');
        closeModal('linkInvoiceModal');
        await loadLinkedInvoices(coId);
      } catch (err) {
        console.error('Error linking invoice:', err);
        showToast(err.message || 'Failed to link invoice', 'error');
      }
    }

    async function unlinkInvoice(coId, invoiceId) {
      if (!confirm('Unlink this invoice from the change order?')) return;

      try {
        const res = await fetch(`/api/change-orders/${coId}/unlink-invoice/${invoiceId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to unlink');

        showToast('Invoice unlinked', 'success');
        await loadLinkedInvoices(coId);
      } catch (err) {
        console.error('Error unlinking invoice:', err);
        showToast('Failed to unlink invoice', 'error');
      }
    }

    function closeBudgetModal() {
      document.getElementById('budgetModal').classList.remove('show');
    }

    // Import functionality
    function showImportModal() {
      document.getElementById('importFile').value = '';
      document.getElementById('importPreview').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
      document.getElementById('importModal').classList.add('show');
    }

    let parsedBudgetData = null;

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          // Try to find G703 sheet
          let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('g703') || n.toLowerCase().includes('line item'));
          if (!sheetName) sheetName = workbook.SheetNames[0];

          const sheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          // Parse budget lines
          parsedBudgetData = parseBudgetFromExcel(jsonData);

          if (parsedBudgetData.length > 0) {
            showPreview(parsedBudgetData);
            document.getElementById('importBtn').disabled = false;
          } else {
            showToast('No budget lines found in file', 'error');
          }
        } catch (err) {
          console.error('Error parsing file:', err);
          showToast('Failed to parse Excel file', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function parseBudgetFromExcel(data) {
      const lines = [];

      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        if (!row || !row[0]) continue;

        // Look for cost code pattern (digits with possible dots/dashes)
        const firstCell = String(row[0]).trim();
        if (/^\d{2,5}$/.test(firstCell) || /^\d{2}\d{3}$/.test(firstCell)) {
          const costCode = firstCell;
          const description = row[1] || '';
          const budget = parseFloat(row[2]) || 0;

          if (description && !description.toLowerCase().includes('total')) {
            lines.push({
              costCode,
              description: String(description).trim(),
              budgeted: budget
            });
          }
        }
      }

      return lines;
    }

    function showPreview(lines) {
      const preview = document.getElementById('importPreview');
      const content = document.getElementById('previewContent');

      content.innerHTML = `
        <p><strong>${lines.length}</strong> cost codes found</p>
        <table class="preview-table">
          <thead>
            <tr><th>Code</th><th>Description</th><th>Budget</th></tr>
          </thead>
          <tbody>
            ${lines.slice(0, 10).map(l => `
              <tr>
                <td>${l.costCode}</td>
                <td>${l.description}</td>
                <td>${formatMoney(l.budgeted)}</td>
              </tr>
            `).join('')}
            ${lines.length > 10 ? `<tr><td colspan="3">... and ${lines.length - 10} more</td></tr>` : ''}
          </tbody>
        </table>
      `;

      preview.style.display = 'block';
    }

    async function importBudget() {
      const jobId = document.getElementById('importJob').value;
      if (!jobId) {
        showToast('Please select a job', 'error');
        return;
      }

      if (!parsedBudgetData || parsedBudgetData.length === 0) {
        showToast('No budget data to import', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/jobs/${jobId}/budget/import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lines: parsedBudgetData })
        });

        if (!res.ok) throw new Error('Failed to import budget');

        const result = await res.json();
        showToast(`Imported ${result.imported} budget lines`, 'success');
        closeModal('importModal');

        // Refresh if viewing this job
        if (state.currentJob?.id === jobId) {
          loadBudget(jobId);
        }
      } catch (err) {
        console.error('Error importing budget:', err);
        showToast('Failed to import budget', 'error');
      }
    }

    function exportBudgetExcel() {
      if (!state.currentJob) return;
      window.open(`/api/jobs/${state.currentJob.id}/budget/export`, '_blank');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    function formatMoney(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatMoneyDecimal(amount) {
      const num = parseFloat(amount) || 0;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function showToast(message, type = 'info') {
      if (window.Toast) {
        Toast.show(message, type);
      } else {
        console.log(`[${type}] ${message}`);
      }
    }
  </script>
</body>
</html>
