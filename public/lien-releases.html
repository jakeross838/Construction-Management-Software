<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <title>Ross Built - Lien Releases</title>
  <link rel="stylesheet" href="css/styles.css?v=20260115-perf">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-top">
        <div class="header-brand">
          <span class="brand-icon">üèóÔ∏è</span>
          <span class="brand-name">Ross Built</span>
        </div>
        <nav class="main-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
        <div class="header-actions">
          <button class="btn btn-primary" id="uploadBtn">+ Upload</button>
        </div>
      </div>
      <div class="header-sub">
        <nav class="sub-nav">
          <!-- Filled by nav-sidebar.js -->
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="app-body">
      <main class="main">
      <!-- Filters -->
      <div class="table-toolbar">
        <div class="filter-controls">
          <select id="statusFilter" class="form-control filter-select">
            <option value="">All Status</option>
            <option value="received">Received</option>
            <option value="verified">Verified</option>
            <option value="attached">Attached to Draw</option>
          </select>
          <select id="releaseTypeFilter" class="form-control filter-select">
            <option value="">All Types</option>
            <option value="conditional_progress">Conditional Progress</option>
            <option value="unconditional_progress">Unconditional Progress</option>
            <option value="conditional_final">Conditional Final</option>
            <option value="unconditional_final">Unconditional Final</option>
          </select>
          <select id="vendorFilter" class="form-control filter-select">
            <option value="">All Vendors</option>
          </select>
        </div>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search vendor, job..." class="form-control search-input">
        </div>
      </div>

      <!-- Lien Release List -->
      <div class="lien-release-list" id="lienReleaseList">
        <div class="loading">Loading lien releases...</div>
      </div>
    </main>
    </div>
  </div>

  <!-- Universal Upload Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upload Document</h2>
        <button class="close-btn" id="closeUploadBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="upload-info-banner">
          <div class="info-icon">AI</div>
          <div class="info-text">
            <strong>Smart Document Processing</strong>
            <p>AI will automatically detect if this is a Lien Release, Invoice, or other document type.</p>
          </div>
        </div>
        <div class="form-group">
          <label>PDF Document *</label>
          <div class="file-drop-zone" id="dropZone">
            <input type="file" id="pdfFileInput" accept="application/pdf">
            <div class="drop-zone-content">
              <div class="drop-icon">PDF</div>
              <p>Click to select or drag PDF here</p>
            </div>
          </div>
          <div id="selectedFileName" class="selected-file" style="display: none;"></div>
        </div>
        <div id="processingStatus" class="processing-status" style="display: none;">
          <div class="processing-spinner"></div>
          <div id="processingMessage">Processing...</div>
        </div>
        <div id="resultArea" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelUploadBtn">Cancel</button>
        <button class="btn btn-primary" id="processBtn" disabled>Process Document</button>
      </div>
    </div>
  </div>

  <!-- Lien Release Detail Modal -->
  <div id="detailModal" class="modal modal-fullscreen-dark">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-row">
          <h2 id="detailModalTitle">Lien Release</h2>
          <span id="detailStatusBadge" class="status-badge"></span>
        </div>
        <button class="close-btn" onclick="closeDetailModal()">&times;</button>
      </div>
      <div class="modal-body lien-release-modal-body" id="detailModalBody">
        <div class="loading">Loading...</div>
      </div>
      <div class="modal-footer" id="detailModalFooter">
        <!-- Action buttons populated by JS -->
      </div>
    </div>
  </div>

  <!-- Attach to Draw Modal -->
  <div id="attachDrawModal" class="modal">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2>Attach to Draw</h2>
        <button class="close-btn" onclick="closeAttachDrawModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="suggestedDrawsSection" class="suggested-draws-section" style="display: none;">
          <h4>Suggested Draws</h4>
          <div id="suggestedDrawsList" class="suggested-draws-list"></div>
        </div>
        <div class="form-group">
          <label>Or Select Draw Manually</label>
          <select id="drawSelect" class="form-control">
            <option value="">Select a draw...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAttachDrawModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmAttachToDraw()">Attach</button>
      </div>
    </div>
  </div>

  <!-- Confirm Dialog -->
  <div id="confirmDialog" class="modal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2 id="confirmTitle">Confirm</h2>
        <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="js/toasts.js?v=20260114"></script>
  <script src="js/nav-sidebar.js?v=20260114"></script>
  <script src="js/searchable-picker.js?v=20260114"></script>
  <script src="js/sidebar.js?v=20260114"></script>
  <script>
// ============================================================
// LIEN RELEASES PAGE
// ============================================================

let state = {
  lienReleases: [],
  vendors: [],
  jobs: [],
  draws: [],
  currentStatusFilter: '',
  currentTypeFilter: '',
  currentVendorFilter: '',
  searchQuery: '',
  currentLienRelease: null
};

// ============================================================
// INITIALIZATION
// ============================================================

document.addEventListener('DOMContentLoaded', async () => {
  await Promise.all([
    loadVendors(),
    loadJobs(),
    loadDraws(),
    loadLienReleases()
  ]);
  setupFilters();
  setupUploadZone();

  // Check for openLienRelease query parameter (deep linking)
  const urlParams = new URLSearchParams(window.location.search);
  const openId = urlParams.get('openLienRelease');
  if (openId) {
    window.history.replaceState({}, '', window.location.pathname);
    setTimeout(() => openLienRelease(openId), 300);
  }

  // Sidebar integration
  if (window.JobSidebar) {
    window.JobSidebar.onJobChange((jobId) => {
      state.currentJobFilter = jobId;
      renderList();
    });
  }
});

// ============================================================
// DATA LOADING
// ============================================================

async function loadLienReleases() {
  try {
    const res = await fetch('/api/lien-releases');
    state.lienReleases = await res.json();
    renderList();
  } catch (err) {
    console.error('Failed to load lien releases:', err);
    document.getElementById('lienReleaseList').innerHTML =
      '<div class="error-state">Failed to load lien releases</div>';
  }
}

async function loadVendors() {
  try {
    const res = await fetch('/api/vendors');
    state.vendors = await res.json();
    const select = document.getElementById('vendorFilter');
    select.innerHTML = '<option value="">All Vendors</option>';
    state.vendors.forEach(v => {
      select.innerHTML += `<option value="${v.id}">${v.name}</option>`;
    });
  } catch (err) {
    console.error('Failed to load vendors:', err);
  }
}

async function loadJobs() {
  try {
    const res = await fetch('/api/jobs');
    state.jobs = await res.json();
  } catch (err) {
    console.error('Failed to load jobs:', err);
  }
}

async function loadDraws() {
  try {
    const res = await fetch('/api/draws');
    state.draws = await res.json();
  } catch (err) {
    console.error('Failed to load draws:', err);
  }
}

// ============================================================
// RENDERING
// ============================================================

function renderList() {
  const container = document.getElementById('lienReleaseList');
  let filtered = state.lienReleases;

  // Apply filters
  if (state.currentStatusFilter) {
    filtered = filtered.filter(lr => lr.status === state.currentStatusFilter);
  }
  if (state.currentTypeFilter) {
    filtered = filtered.filter(lr => lr.release_type === state.currentTypeFilter);
  }
  if (state.currentVendorFilter) {
    filtered = filtered.filter(lr => lr.vendor_id === state.currentVendorFilter);
  }
  if (state.currentJobFilter) {
    filtered = filtered.filter(lr => lr.job_id === state.currentJobFilter);
  }
  if (state.searchQuery) {
    const q = state.searchQuery.toLowerCase();
    filtered = filtered.filter(lr =>
      (lr.vendor?.name || '').toLowerCase().includes(q) ||
      (lr.job?.name || '').toLowerCase().includes(q) ||
      (lr.signer_name || '').toLowerCase().includes(q)
    );
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state">No lien releases found</div>';
    return;
  }

  container.innerHTML = `
    <div class="lien-release-list-header">
      <div>Vendor</div>
      <div>Type</div>
      <div>Amount</div>
      <div>Through Date</div>
      <div>Job</div>
      <div>Status</div>
      <div>Draw</div>
    </div>
    ${filtered.map(lr => renderRow(lr)).join('')}
  `;
}

function renderRow(lr) {
  const vendor = lr.vendor || state.vendors.find(v => v.id === lr.vendor_id);
  const job = lr.job || state.jobs.find(j => j.id === lr.job_id);

  const typeLabel = formatReleaseType(lr.release_type);
  const statusLabel = formatStatus(lr.status);
  const statusClass = getStatusClass(lr.status);

  return `
    <div class="lien-release-row" onclick="openLienRelease('${lr.id}')">
      <div class="vendor-name">${vendor?.name || 'Unknown Vendor'}</div>
      <div class="release-type">${typeLabel}</div>
      <div class="amount">${lr.amount ? formatMoney(lr.amount) : '-'}</div>
      <div class="through-date">${lr.through_date ? formatDate(lr.through_date) : '-'}</div>
      <div class="job-name">${job?.name || 'Unassigned'}</div>
      <div><span class="status-badge status-${statusClass}">${statusLabel}</span></div>
      <div>${lr.draw ? `Draw #${lr.draw.draw_number}` : '-'}</div>
    </div>
  `;
}

function formatReleaseType(type) {
  const labels = {
    'conditional_progress': 'Conditional Progress',
    'unconditional_progress': 'Unconditional Progress',
    'conditional_final': 'Conditional Final',
    'unconditional_final': 'Unconditional Final'
  };
  return labels[type] || type;
}

function formatStatus(status) {
  const labels = {
    'received': 'Received',
    'verified': 'Verified',
    'attached': 'Attached'
  };
  return labels[status] || status;
}

function getStatusClass(status) {
  const classes = {
    'received': 'pending',
    'verified': 'approved',
    'attached': 'in-draw'
  };
  return classes[status] || 'pending';
}

function formatMoney(amount) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD'
  }).format(amount || 0);
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ============================================================
// FILTERS
// ============================================================

function setupFilters() {
  document.getElementById('statusFilter').addEventListener('change', e => {
    state.currentStatusFilter = e.target.value;
    renderList();
  });
  document.getElementById('releaseTypeFilter').addEventListener('change', e => {
    state.currentTypeFilter = e.target.value;
    renderList();
  });
  document.getElementById('vendorFilter').addEventListener('change', e => {
    state.currentVendorFilter = e.target.value;
    renderList();
  });

  let debounce;
  document.getElementById('searchInput').addEventListener('input', e => {
    clearTimeout(debounce);
    debounce = setTimeout(() => {
      state.searchQuery = e.target.value;
      renderList();
    }, 300);
  });
}

// ============================================================
// UPLOAD - Simple Universal Upload
// ============================================================

(function() {
  var uploadBtn = document.getElementById('uploadBtn');
  var modal = document.getElementById('uploadModal');
  var closeBtn = document.getElementById('closeUploadBtn');
  var cancelBtn = document.getElementById('cancelUploadBtn');
  var processBtn = document.getElementById('processBtn');
  var fileInput = document.getElementById('pdfFileInput');
  var dropZone = document.getElementById('dropZone');
  var fileNameDiv = document.getElementById('selectedFileName');
  var processingDiv = document.getElementById('processingStatus');
  var processingMsg = document.getElementById('processingMessage');
  var resultArea = document.getElementById('resultArea');

  var selectedFile = null;

  uploadBtn.onclick = function() {
    console.log('Opening upload modal');
    resetUploadModal();
    modal.style.display = 'flex';
    modal.style.opacity = '1';
  };

  function closeUploadModal() {
    modal.style.display = 'none';
    resetUploadModal();
  }

  closeBtn.onclick = closeUploadModal;
  cancelBtn.onclick = closeUploadModal;

  modal.onclick = function(e) {
    if (e.target === modal) closeUploadModal();
  };

  function resetUploadModal() {
    selectedFile = null;
    fileInput.value = '';
    fileNameDiv.style.display = 'none';
    fileNameDiv.textContent = '';
    processingDiv.style.display = 'none';
    resultArea.style.display = 'none';
    resultArea.innerHTML = '';
    processBtn.disabled = true;
    processBtn.textContent = 'Process Document';
  }

  fileInput.onchange = function() {
    if (fileInput.files && fileInput.files[0]) {
      selectedFile = fileInput.files[0];
      fileNameDiv.textContent = selectedFile.name;
      fileNameDiv.style.display = 'block';
      processBtn.disabled = false;
    }
  };

  dropZone.ondragover = function(e) {
    e.preventDefault();
    dropZone.classList.add('dragover');
  };

  dropZone.ondragleave = function() {
    dropZone.classList.remove('dragover');
  };

  dropZone.ondrop = function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      var file = e.dataTransfer.files[0];
      if (file.type === 'application/pdf') {
        selectedFile = file;
        fileNameDiv.textContent = file.name;
        fileNameDiv.style.display = 'block';
        processBtn.disabled = false;
      } else {
        showToast('Please select a PDF file', 'error');
      }
    }
  };

  processBtn.onclick = async function() {
    if (!selectedFile) {
      showToast('Please select a file first', 'error');
      return;
    }

    processBtn.disabled = true;
    processBtn.textContent = 'Processing...';
    processingDiv.style.display = 'flex';
    processingMsg.textContent = 'Uploading and analyzing document...';
    resultArea.style.display = 'none';

    try {
      var formData = new FormData();
      formData.append('pdf', selectedFile);
      formData.append('uploaded_by', 'Jake Ross');

      var response = await fetch('/api/documents/process', {
        method: 'POST',
        body: formData
      });

      var result = await response.json();
      processingDiv.style.display = 'none';

      if (!response.ok) {
        throw new Error(result.error || 'Processing failed');
      }

      var docType = result.documentType || 'unknown';
      var typeLabels = {
        invoice: 'Invoice',
        lien_release: 'Lien Release',
        purchase_order: 'Purchase Order',
        quote: 'Quote',
        unknown: 'Unknown Document'
      };

      resultArea.innerHTML = '<div class="result-success">' +
        '<h3>Document Processed</h3>' +
        '<p><strong>Type:</strong> ' + (typeLabels[docType] || docType) + '</p>' +
        (result.data?.vendor?.name ? '<p><strong>Vendor:</strong> ' + result.data.vendor.name + '</p>' : '') +
        '</div>';
      resultArea.style.display = 'block';

      processBtn.textContent = 'Done';
      showToast(typeLabels[docType] + ' processed successfully', 'success');

      // Refresh the list
      if (typeof loadLienReleases === 'function') {
        loadLienReleases();
      }

      setTimeout(function() {
        closeUploadModal();
      }, 2000);

    } catch (err) {
      processingDiv.style.display = 'none';
      processBtn.disabled = false;
      processBtn.textContent = 'Try Again';
      showToast(err.message || 'Upload failed', 'error');
    }
  };

  console.log('Lien releases upload module initialized');
})();

// Legacy function stub for compatibility
function setupUploadZone() {}

// ============================================================
// DETAIL MODAL
// ============================================================

async function openLienRelease(id) {
  console.log('[LienRelease] Opening:', id);
  const modal = document.getElementById('detailModal');
  const body = document.getElementById('detailModalBody');
  const footer = document.getElementById('detailModalFooter');

  // Show modal with proper class for CSS transitions
  modal.style.display = 'flex';
  // Use requestAnimationFrame to ensure display:flex is applied before adding show class
  requestAnimationFrame(() => {
    modal.classList.add('show');
  });
  body.innerHTML = '<div class="loading">Loading...</div>';
  footer.innerHTML = '';

  try {
    console.log('[LienRelease] Fetching data...');
    const res = await fetch(`/api/lien-releases/${id}`);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    const lr = await res.json();
    console.log('[LienRelease] Data received:', lr.id);
    state.currentLienRelease = lr;

    const vendor = lr.vendor || (state.vendors || []).find(v => v.id === lr.vendor_id);
    const job = lr.job || (state.jobs || []).find(j => j.id === lr.job_id);
    console.log('[LienRelease] Vendor:', vendor?.name, 'Job:', job?.name);

    console.log('[LienRelease] Setting title...');
    document.getElementById('detailModalTitle').textContent =
      `${formatReleaseType(lr.release_type)} - ${vendor?.name || 'Unknown Vendor'}`;
    document.getElementById('detailStatusBadge').className =
      `status-badge status-${getStatusClass(lr.status)}`;
    document.getElementById('detailStatusBadge').textContent = formatStatus(lr.status);

    console.log('[LienRelease] Building body HTML...');

    // Build vendor options safely
    const vendorOptions = (state.vendors || []).map(v =>
      `<option value="${v.id}" ${v.id === lr.vendor_id ? 'selected' : ''}>${escapeHtml(v.name)}</option>`
    ).join('');

    // Build job options safely
    const jobOptions = (state.jobs || []).map(j =>
      `<option value="${j.id}" ${j.id === lr.job_id ? 'selected' : ''}>${escapeHtml(j.name)}</option>`
    ).join('');

    // Build activity safely (limit to 20 items max)
    const activityItems = (lr.activity || []).slice(0, 20);
    const activityHtml = activityItems.length > 0 ? `
      <div class="detail-card">
        <h3>Activity</h3>
        <div class="activity-log">
          ${activityItems.map(a => `
            <div class="activity-item">
              <span class="activity-action">${escapeHtml(a.action || '')}</span>
              <span class="activity-by">${escapeHtml(a.performed_by || 'System')}</span>
              <span class="activity-time">${formatDate(a.created_at)}</span>
            </div>
          `).join('')}
        </div>
      </div>
    ` : '';

    console.log('[LienRelease] Assigning body innerHTML...');
    body.innerHTML = `
      <div class="lien-release-detail-layout">
        <div class="pdf-viewer-section">
          ${lr.pdf_url
            ? `<iframe src="${lr.pdf_url}" class="pdf-viewer-iframe" title="Lien Release PDF"></iframe>`
            : '<div class="no-pdf">No PDF available</div>'}
        </div>
        <div class="detail-form-section">
          <div class="detail-card">
            <h3>Release Details</h3>
            <div class="detail-grid">
              <div class="detail-row">
                <label>Type</label>
                <select id="editReleaseType" class="form-control">
                  <option value="conditional_progress" ${lr.release_type === 'conditional_progress' ? 'selected' : ''}>Conditional Progress</option>
                  <option value="unconditional_progress" ${lr.release_type === 'unconditional_progress' ? 'selected' : ''}>Unconditional Progress</option>
                  <option value="conditional_final" ${lr.release_type === 'conditional_final' ? 'selected' : ''}>Conditional Final</option>
                  <option value="unconditional_final" ${lr.release_type === 'unconditional_final' ? 'selected' : ''}>Unconditional Final</option>
                </select>
              </div>
              <div class="detail-row">
                <label>Amount</label>
                <input type="number" id="editAmount" class="form-control" value="${lr.amount || ''}" step="0.01">
              </div>
              <div class="detail-row">
                <label>Through Date</label>
                <input type="date" id="editThroughDate" class="form-control" value="${lr.through_date || ''}">
              </div>
              <div class="detail-row">
                <label>Release Date</label>
                <input type="date" id="editReleaseDate" class="form-control" value="${lr.release_date || ''}">
              </div>
            </div>
          </div>

          <div class="detail-card">
            <h3>Vendor & Job</h3>
            <div class="detail-grid">
              <div class="detail-row">
                <label>Vendor</label>
                <select id="editVendor" class="form-control">
                  <option value="">Select Vendor...</option>
                  ${vendorOptions}
                </select>
              </div>
              <div class="detail-row">
                <label>Job</label>
                <select id="editJob" class="form-control">
                  <option value="">Select Job...</option>
                  ${jobOptions}
                </select>
              </div>
            </div>
          </div>

          <div class="detail-card">
            <h3>Signer & Notary</h3>
            <div class="detail-grid">
              <div class="detail-row">
                <label>Signer Name</label>
                <input type="text" id="editSignerName" class="form-control" value="${escapeHtml(lr.signer_name || '')}">
              </div>
              <div class="detail-row">
                <label>Signer Title</label>
                <input type="text" id="editSignerTitle" class="form-control" value="${escapeHtml(lr.signer_title || '')}">
              </div>
              <div class="detail-row">
                <label>Notary Name</label>
                <input type="text" id="editNotaryName" class="form-control" value="${escapeHtml(lr.notary_name || '')}">
              </div>
              <div class="detail-row">
                <label>Notary County</label>
                <input type="text" id="editNotaryCounty" class="form-control" value="${escapeHtml(lr.notary_county || '')}">
              </div>
            </div>
          </div>

          <div class="detail-card">
            <h3>Notes</h3>
            <textarea id="editNotes" class="form-control" rows="3">${escapeHtml(lr.notes || '')}</textarea>
          </div>

          ${lr.needs_review && lr.review_flags ? `
          <div class="detail-card review-flags-card">
            <h3>Review Flags</h3>
            <div class="review-flags">
              ${(lr.review_flags || []).map(f => `<span class="flag-badge">${escapeHtml(f)}</span>`).join('')}
            </div>
          </div>
          ` : ''}

          ${activityHtml}
        </div>
      </div>
    `;
    console.log('[LienRelease] Body HTML assigned.');

    // Footer buttons
    console.log('[LienRelease] Building footer...');
    footer.innerHTML = `
      <div class="footer-left">
        <button class="btn btn-danger" onclick="deleteLienRelease('${lr.id}')">Delete</button>
      </div>
      <div class="footer-right">
        ${lr.status !== 'attached' ? `
        <button class="btn btn-secondary" onclick="showAttachDrawModal('${lr.id}')">Attach to Draw</button>
        ` : `
        <button class="btn btn-secondary" onclick="detachFromDraw('${lr.id}')">Detach from Draw</button>
        `}
        ${lr.status === 'received' ? `
        <button class="btn btn-success" onclick="verifyLienRelease('${lr.id}')">Mark Verified</button>
        ` : ''}
        <button class="btn btn-primary" onclick="saveLienRelease('${lr.id}')">Save Changes</button>
      </div>
    `;
    console.log('[LienRelease] Modal fully rendered.');

  } catch (err) {
    console.error('[LienRelease] Error loading lien release:', err);
    body.innerHTML = '<div class="error-state">Failed to load lien release: ' + escapeHtml(err.message) + '</div>';
  }
}

// Helper to escape HTML to prevent XSS and rendering issues
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function closeDetailModal() {
  const modal = document.getElementById('detailModal');
  modal.classList.remove('show');
  modal.style.display = 'none';
  state.currentLienRelease = null;
}

async function saveLienRelease(id) {
  const updates = {
    release_type: document.getElementById('editReleaseType').value,
    amount: parseFloat(document.getElementById('editAmount').value) || null,
    through_date: document.getElementById('editThroughDate').value || null,
    release_date: document.getElementById('editReleaseDate').value || null,
    vendor_id: document.getElementById('editVendor').value || null,
    job_id: document.getElementById('editJob').value || null,
    signer_name: document.getElementById('editSignerName').value || null,
    signer_title: document.getElementById('editSignerTitle').value || null,
    notary_name: document.getElementById('editNotaryName').value || null,
    notary_county: document.getElementById('editNotaryCounty').value || null,
    notes: document.getElementById('editNotes').value || null,
    updated_by: 'User'
  };

  try {
    const res = await fetch(`/api/lien-releases/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updates)
    });

    if (!res.ok) throw new Error('Failed to save');

    showToast('Lien release updated', 'success');
    await loadLienReleases();
    openLienRelease(id);
  } catch (err) {
    showToast(err.message, 'error');
  }
}

async function verifyLienRelease(id) {
  try {
    const res = await fetch(`/api/lien-releases/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'verified', updated_by: 'User' })
    });

    if (!res.ok) throw new Error('Failed to verify');

    showToast('Lien release marked as verified', 'success');
    await loadLienReleases();
    openLienRelease(id);
  } catch (err) {
    showToast(err.message, 'error');
  }
}

async function deleteLienRelease(id) {
  if (!confirm('Are you sure you want to delete this lien release?')) return;

  try {
    const res = await fetch(`/api/lien-releases/${id}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ deleted_by: 'User' })
    });

    if (!res.ok) throw new Error('Failed to delete');

    showToast('Lien release deleted', 'success');
    closeDetailModal();
    await loadLienReleases();
  } catch (err) {
    showToast(err.message, 'error');
  }
}

// ============================================================
// ATTACH TO DRAW
// ============================================================

let pendingAttachId = null;

async function showAttachDrawModal(lienReleaseId) {
  pendingAttachId = lienReleaseId;
  const lr = state.currentLienRelease;

  // Show modal immediately
  document.getElementById('attachDrawModal').style.display = 'flex';

  // Load suggested draws
  const suggestedSection = document.getElementById('suggestedDrawsSection');
  const suggestedList = document.getElementById('suggestedDrawsList');
  suggestedSection.style.display = 'none';
  suggestedList.innerHTML = '<div class="loading">Loading suggestions...</div>';

  try {
    const res = await fetch(`/api/lien-releases/${lienReleaseId}/suggested-draws`);
    const suggestions = await res.json();

    if (suggestions && suggestions.length > 0) {
      suggestedSection.style.display = 'block';
      suggestedList.innerHTML = suggestions.map(s => `
        <div class="suggested-draw-item" onclick="selectSuggestedDraw('${s.draw_id}')">
          <div class="suggested-draw-info">
            <span class="suggested-draw-title">Draw #${s.draw_number} - ${s.job_name}</span>
            <span class="suggested-draw-meta">
              ${s.period_end ? formatDate(s.period_end) : 'No date'} - ${formatMoney(s.total_amount || 0)}
            </span>
            <span class="suggested-draw-reasons">${s.reasons.join(' ‚Ä¢ ')}</span>
          </div>
          <div class="suggested-draw-score">
            <span class="score-badge">${s.score}%</span>
            <span class="score-label">match</span>
          </div>
        </div>
      `).join('');
    }
  } catch (err) {
    console.error('Failed to load suggestions:', err);
    suggestedSection.style.display = 'none';
  }

  // Populate manual select dropdown
  let availableDraws = state.draws.filter(d => d.status === 'draft' || d.status === 'pending');
  if (lr?.job_id) {
    availableDraws = availableDraws.filter(d => d.job_id === lr.job_id);
  }

  const select = document.getElementById('drawSelect');
  select.innerHTML = '<option value="">Select a draw...</option>';
  availableDraws.forEach(d => {
    const job = state.jobs.find(j => j.id === d.job_id);
    select.innerHTML += `<option value="${d.id}">Draw #${d.draw_number} - ${job?.name || 'Unknown Job'}</option>`;
  });
}

function selectSuggestedDraw(drawId) {
  document.getElementById('drawSelect').value = drawId;
  // Highlight the selected suggestion
  document.querySelectorAll('.suggested-draw-item').forEach(item => {
    item.classList.remove('selected');
    if (item.onclick.toString().includes(drawId)) {
      item.classList.add('selected');
    }
  });
}

function closeAttachDrawModal() {
  document.getElementById('attachDrawModal').style.display = 'none';
  pendingAttachId = null;
}

async function confirmAttachToDraw() {
  const drawId = document.getElementById('drawSelect').value;
  if (!drawId) {
    showToast('Please select a draw', 'error');
    return;
  }

  try {
    const res = await fetch(`/api/lien-releases/${pendingAttachId}/attach-to-draw`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ draw_id: drawId, attached_by: 'User' })
    });

    if (!res.ok) throw new Error('Failed to attach');

    showToast('Lien release attached to draw', 'success');
    closeAttachDrawModal();
    await loadLienReleases();
    openLienRelease(pendingAttachId);
  } catch (err) {
    showToast(err.message, 'error');
  }
}

async function detachFromDraw(id) {
  if (!confirm('Detach this lien release from its draw?')) return;

  try {
    const res = await fetch(`/api/lien-releases/${id}/detach-from-draw`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ detached_by: 'User' })
    });

    if (!res.ok) throw new Error('Failed to detach');

    showToast('Lien release detached from draw', 'success');
    await loadLienReleases();
    openLienRelease(id);
  } catch (err) {
    showToast(err.message, 'error');
  }
}

// ============================================================
// CONFIRM MODAL (utility)
// ============================================================

function closeConfirmModal() {
  document.getElementById('confirmDialog').style.display = 'none';
}
  </script>
</body>
</html>
